<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGæ•°æ®é¢„å¤„ç† - AI-STACK</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { margin-bottom: 30px; color: #333; }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .section h2 {
            margin-bottom: 15px;
            color: #555;
            font-size: 18px;
        }
        .config-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .config-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .config-item label {
            font-size: 14px;
            color: #666;
        }
        .config-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .config-item input[type="text"],
        .config-item input[type="number"],
        .config-item select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 20px;
            background: #4caf50;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover { background: #45a049; }
        .btn-secondary {
            background: #2196f3;
        }
        .btn-secondary:hover {
            background: #1976d2;
        }
        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 200px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š RAGæ•°æ®é¢„å¤„ç†</h1>
        
        <!-- æ¸…æ´—é…ç½® -->
        <div class="section">
            <h2>1. æ•°æ®æ¸…æ´—é…ç½®</h2>
            <div class="config-group">
                <div class="config-item">
                    <input type="checkbox" id="remove-invalid-chars" checked>
                    <label for="remove-invalid-chars">ç§»é™¤æ— æ•ˆå­—ç¬¦</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="remove-whitespace" checked>
                    <label for="remove-whitespace">ç§»é™¤å¤šä½™ç©ºç™½</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="remove-html-tags" checked>
                    <label for="remove-html-tags">ç§»é™¤HTMLæ ‡ç­¾</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="remove-special-chars">
                    <label for="remove-special-chars">ç§»é™¤ç‰¹æ®Šå­—ç¬¦</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="remove-duplicate-lines" checked>
                    <label for="remove-duplicate-lines">ç§»é™¤é‡å¤è¡Œ</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="remove-empty-lines" checked>
                    <label for="remove-empty-lines">ç§»é™¤ç©ºè¡Œ</label>
                </div>
            </div>
        </div>

        <!-- æ ‡å‡†åŒ–é…ç½® -->
        <div class="section">
            <h2>2. æ•°æ®æ ‡å‡†åŒ–é…ç½®</h2>
            <div class="config-group">
                <div class="config-item">
                    <label>ç¼–ç æ ¼å¼:</label>
                    <select id="encoding">
                        <option value="utf-8" selected>UTF-8</option>
                        <option value="gbk">GBK</option>
                        <option value="gb2312">GB2312</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>æ¢è¡Œç¬¦:</label>
                    <select id="line-ending">
                        <option value="lf" selected>LF (\n)</option>
                        <option value="crlf">CRLF (\r\n)</option>
                        <option value="cr">CR (\r)</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>æ—¥æœŸæ ¼å¼:</label>
                    <select id="date-format">
                        <option value="iso" selected>ISO (2025-11-12)</option>
                        <option value="us">US (11/12/2025)</option>
                        <option value="eu">EU (12/11/2025)</option>
                        <option value="cn">CN (2025å¹´11æœˆ12æ—¥)</option>
                    </select>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="normalize-case" checked>
                    <label for="normalize-case">ç»Ÿä¸€å¤§å°å†™</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="normalize-numbers" checked>
                    <label for="normalize-numbers">ç»Ÿä¸€æ•°å­—æ ¼å¼</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="normalize-punctuation" checked>
                    <label for="normalize-punctuation">ç»Ÿä¸€æ ‡ç‚¹ç¬¦å·</label>
                </div>
            </div>
        </div>

        <!-- å»é‡é…ç½® -->
        <div class="section">
            <h2>3. æ•°æ®å»é‡é…ç½®</h2>
            <div class="config-group">
                <div class="config-item">
                    <label>ç®—æ³•:</label>
                    <select id="dedup-algorithm">
                        <option value="cosine" selected>ä½™å¼¦ç›¸ä¼¼åº¦</option>
                        <option value="jaccard">Jaccardç›¸ä¼¼åº¦</option>
                        <option value="hamming">æ±‰æ˜è·ç¦»</option>
                        <option value="levenshtein">ç¼–è¾‘è·ç¦»</option>
                        <option value="simhash">SimHash</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>ç›¸ä¼¼åº¦é˜ˆå€¼:</label>
                    <input type="number" id="similarity-threshold" value="0.85" min="0" max="1" step="0.05">
                </div>
                <div class="config-item">
                    <input type="checkbox" id="exact-duplicate" checked>
                    <label for="exact-duplicate">ç²¾ç¡®å»é‡</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="fuzzy-duplicate" checked>
                    <label for="fuzzy-duplicate">æ¨¡ç³Šå»é‡</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="semantic-duplicate">
                    <label for="semantic-duplicate">è¯­ä¹‰å»é‡</label>
                </div>
                <div class="config-item">
                    <label>å»é‡ç­–ç•¥:</label>
                    <select id="dedup-strategy">
                        <option value="keep-first" selected>ä¿ç•™ç¬¬ä¸€ä¸ª</option>
                        <option value="keep-last">ä¿ç•™æœ€åä¸€ä¸ª</option>
                        <option value="keep-best">ä¿ç•™æœ€ä½³</option>
                        <option value="merge">åˆå¹¶</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- éªŒè¯é…ç½® -->
        <div class="section">
            <h2>4. æ•°æ®éªŒè¯é…ç½®</h2>
            <div class="config-group">
                <div class="config-item">
                    <input type="checkbox" id="validate-format" checked>
                    <label for="validate-format">æ ¼å¼éªŒè¯</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="validate-content" checked>
                    <label for="validate-content">å†…å®¹éªŒè¯</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="validate-completeness" checked>
                    <label for="validate-completeness">å®Œæ•´æ€§éªŒè¯</label>
                </div>
                <div class="config-item">
                    <input type="checkbox" id="validate-consistency" checked>
                    <label for="validate-consistency">ä¸€è‡´æ€§éªŒè¯</label>
                </div>
            </div>
        </div>

        <!-- æ“ä½œåŒº -->
        <div class="section">
            <h2>5. æ‰§è¡Œé¢„å¤„ç†</h2>
            <div>
                <button class="btn" onclick="startPreprocessing()">å¼€å§‹é¢„å¤„ç†</button>
                <button class="btn btn-secondary" onclick="loadConfig()">åŠ è½½é…ç½®</button>
                <button class="btn btn-secondary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            </div>
            <div id="status" class="status info" style="display: none;"></div>
            <div class="result-area" id="result">ç­‰å¾…æ‰§è¡Œé¢„å¤„ç†ä»»åŠ¡...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v5/rag/preprocessing';

        // é¡µé¢åŠ è½½æ—¶è·å–é»˜è®¤é…ç½®
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_BASE}/config`);
                const config = await response.json();
                loadConfigToUI(config);
            } catch (error) {
                console.error('åŠ è½½é»˜è®¤é…ç½®å¤±è´¥:', error);
            }
        });

        async function startPreprocessing() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'status info';
            statusDiv.textContent = 'æ­£åœ¨æ‰§è¡Œæ‰¹é‡é¢„å¤„ç†...';
            resultDiv.textContent = 'å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...';

            try {
                // æ”¶é›†é…ç½®
                const batchConfig = {
                    steps: ["cleaning", "standardization", "deduplication", "validation"],
                    scope: "all",
                    parallel: true,
                    max_workers: 4
                };

                const response = await fetch(`${API_BASE}/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(batchConfig)
                });

                const result = await response.json();

                if (result.success_count !== undefined) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `é¢„å¤„ç†å®Œæˆï¼æˆåŠŸ: ${result.success_count}, å¤±è´¥: ${result.failed_count}`;
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºç»“æœ
                    let resultText = `æ‰¹é‡é¢„å¤„ç†ç»“æœ:\n`;
                    resultText += `æ€»æ–‡æ¡£æ•°: ${result.total_docs}\n`;
                    resultText += `æˆåŠŸ: ${result.success_count}\n`;
                    resultText += `å¤±è´¥: ${result.failed_count}\n`;
                    resultText += `æ€»è€—æ—¶: ${result.total_time}ç§’\n\n`;
                    resultText += `æ­¥éª¤è¯¦æƒ…:\n`;
                    result.steps.forEach(step => {
                        resultText += `- ${step.step}: ${step.duration}ç§’\n`;
                    });
                    resultDiv.textContent = resultText;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `é¢„å¤„ç†å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`;
                    resultDiv.textContent = JSON.stringify(result, null, 2);
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `é”™è¯¯: ${error.message}`;
                resultDiv.textContent = `è¿æ¥é”™è¯¯: ${error.toString()}\n\nè¯·ç¡®ä¿RAG APIæœåŠ¡æ­£åœ¨è¿è¡Œ (http://localhost:8000)`;
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/config`);
                const config = await response.json();
                loadConfigToUI(config);
                
                const statusDiv = document.getElementById('status');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status success';
                statusDiv.textContent = 'é…ç½®åŠ è½½æˆåŠŸï¼';
            } catch (error) {
                alert(`åŠ è½½é…ç½®å¤±è´¥: ${error.message}`);
            }
        }

        function loadConfigToUI(config) {
            // åŠ è½½æ¸…æ´—é…ç½®
            if (config.cleaning) {
                document.getElementById('remove-invalid-chars').checked = config.cleaning.remove_invalid_chars ?? true;
                document.getElementById('remove-whitespace').checked = config.cleaning.remove_whitespace ?? true;
                document.getElementById('remove-html-tags').checked = config.cleaning.remove_html_tags ?? true;
                document.getElementById('remove-special-chars').checked = config.cleaning.remove_special_chars ?? false;
                document.getElementById('remove-duplicate-lines').checked = config.cleaning.remove_duplicate_lines ?? true;
                document.getElementById('remove-empty-lines').checked = config.cleaning.remove_empty_lines ?? true;
            }
            
            // åŠ è½½æ ‡å‡†åŒ–é…ç½®
            if (config.standardization) {
                document.getElementById('encoding').value = config.standardization.encoding || 'utf-8';
                document.getElementById('line-ending').value = config.standardization.line_ending || 'lf';
                document.getElementById('date-format').value = config.standardization.date_format || 'iso';
                document.getElementById('normalize-case').checked = config.standardization.normalize_case ?? true;
                document.getElementById('normalize-numbers').checked = config.standardization.normalize_numbers ?? true;
                document.getElementById('normalize-punctuation').checked = config.standardization.normalize_punctuation ?? true;
            }
            
            // åŠ è½½å»é‡é…ç½®
            if (config.deduplication) {
                document.getElementById('dedup-algorithm').value = config.deduplication.algorithm || 'cosine';
                document.getElementById('similarity-threshold').value = config.deduplication.similarity_threshold || 0.85;
                document.getElementById('exact-duplicate').checked = config.deduplication.exact_duplicate ?? true;
                document.getElementById('fuzzy-duplicate').checked = config.deduplication.fuzzy_duplicate ?? true;
                document.getElementById('semantic-duplicate').checked = config.deduplication.semantic_duplicate ?? true;
                document.getElementById('dedup-strategy').value = config.deduplication.strategy || 'keep-first';
            }
            
            // åŠ è½½éªŒè¯é…ç½®
            if (config.validation) {
                document.getElementById('validate-format').checked = config.validation.validate_format ?? true;
                document.getElementById('validate-content').checked = config.validation.validate_content ?? true;
                document.getElementById('validate-completeness').checked = config.validation.validate_integrity ?? true;
                document.getElementById('validate-consistency').checked = config.validation.validate_content ?? true;
            }
        }

        async function saveConfig() {
            try {
                const config = {
                    cleaning: {
                        remove_invalid_chars: document.getElementById('remove-invalid-chars').checked,
                        remove_whitespace: document.getElementById('remove-whitespace').checked,
                        remove_html_tags: document.getElementById('remove-html-tags').checked,
                        remove_special_chars: document.getElementById('remove-special-chars').checked,
                        remove_duplicate_lines: document.getElementById('remove-duplicate-lines').checked,
                        remove_empty_lines: document.getElementById('remove-empty-lines').checked
                    },
                    standardization: {
                        encoding: document.getElementById('encoding').value,
                        line_ending: document.getElementById('line-ending').value,
                        date_format: document.getElementById('date-format').value,
                        normalize_case: document.getElementById('normalize-case').checked,
                        normalize_numbers: document.getElementById('normalize-numbers').checked,
                        normalize_punctuation: document.getElementById('normalize-punctuation').checked
                    },
                    deduplication: {
                        algorithm: document.getElementById('dedup-algorithm').value,
                        similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value),
                        exact_duplicate: document.getElementById('exact-duplicate').checked,
                        fuzzy_duplicate: document.getElementById('fuzzy-duplicate').checked,
                        semantic_duplicate: document.getElementById('semantic-duplicate').checked,
                        strategy: document.getElementById('dedup-strategy').value
                    },
                    validation: {
                        validate_integrity: document.getElementById('validate-completeness').checked,
                        validate_format: document.getElementById('validate-format').checked,
                        validate_content: document.getElementById('validate-content').checked
                    }
                };

                const response = await fetch(`${API_BASE}/config/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                const statusDiv = document.getElementById('status');
                statusDiv.style.display = 'block';
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'é…ç½®ä¿å­˜æˆåŠŸï¼';
                    // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('preprocessing_config', JSON.stringify(config));
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'é…ç½®ä¿å­˜å¤±è´¥';
                }
            } catch (error) {
                alert(`ä¿å­˜é…ç½®å¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>

