#!/usr/bin/env python3
"""
Enhanced RAG Web Application
å¯¹åº”éœ€æ±‚: 1.7 RAGå‰ç«¯åŠŸèƒ½åœ¨open webuiä¸Šå®ç°ï¼Œ1.9 å½¢æˆå‰ç«¯æ“ä½œç•Œé¢
æ–‡ä»¶ä½ç½®: ai-stack-super-enhanced/ğŸ“š Enhanced RAG & Knowledge Graph/web/111. app.py
"""

import logging
import os

# å¯¼å…¥RAGæ ¸å¿ƒæ¨¡å—
import sys
from datetime import datetime
from typing import Any, Dict

import uvicorn
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates

sys.path.append(os.path.join(os.path.dirname(__file__), ".."))
from core.dynamic_knowledge_graph import DynamicKnowledgeGraph
from core.hybrid_rag_engine import HybridRAGEngine
from pipelines.smart_ingestion_pipeline import SmartIngestionPipeline
from processors.file_processors.universal_file_parser import UniversalFileParser

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler("/Users/ywc/ai-stack-super-enhanced/logs/rag_web.log"),
        logging.StreamHandler(),
    ],
)
logger = logging.getLogger("rag_web_app")


class RAGWebApp:
    """å¢å¼ºRAG Webåº”ç”¨"""

    def __init__(self):
        self.app = FastAPI(
            title="Enhanced RAG System",
            description="AI Stackè¶…çº§å¢å¼ºç‰ˆ - RAGçŸ¥è¯†æ£€ç´¢ç³»ç»Ÿ",
            version="1.0.0",
            docs_url="/api/docs",
            redoc_url="/api/redoc",
        )

        # åˆå§‹åŒ–æ ¸å¿ƒç»„ä»¶
        self.rag_engine = None
        self.knowledge_graph = None
        self.file_parser = None
        self.ingestion_pipeline = None

        self._setup_middleware()
        self._setup_routes()
        self._setup_static_files()
        self.templates = Jinja2Templates(
            directory=os.path.join(os.path.dirname(__file__), "templates")
        )

    def _setup_middleware(self):
        """è®¾ç½®ä¸­é—´ä»¶"""
        self.app.add_middleware(
            CORSMiddleware,
            allow_origins=["*"],
            allow_credentials=True,
            allow_methods=["*"],
            allow_headers=["*"],
        )

        # æ·»åŠ æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
        @self.app.middleware("http")
        async def add_process_time_header(request, call_next):
            start_time = datetime.now()
            response = await call_next(request)
            process_time = (datetime.now() - start_time).total_seconds()
            response.headers["X-Process-Time"] = str(process_time)
            logger.info(
                f"Request processed in {process_time:.3f}s: {request.method} {request.url}"
            )
            return response

    def _setup_static_files(self):
        """è®¾ç½®é™æ€æ–‡ä»¶"""
        static_dir = os.path.join(os.path.dirname(__file__), "static")
        self.app.mount("/static", StaticFiles(directory=static_dir), name="static")

    def _setup_routes(self):
        """è®¾ç½®è·¯ç”±"""

        # å¥åº·æ£€æŸ¥
        @self.app.get("/health", response_model=Dict[str, Any])
        async def health_check():
            """ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
            status = {
                "status": "healthy",
                "timestamp": datetime.now().isoformat(),
                "version": "1.0.0",
                "components": {
                    "rag_engine": self.rag_engine is not None,
                    "knowledge_graph": self.knowledge_graph is not None,
                    "file_parser": self.file_parser is not None,
                },
            }
            return status

        # ä¸»é¡µé¢
        @self.app.get("/", response_class=HTMLResponse)
        async def read_root():
            """RAGç³»ç»Ÿä¸»é¡µé¢"""
            return self.templates.TemplateResponse(
                "rag-dashboard.html", {"request": {}}
            )

        # çŸ¥è¯†å›¾è°±é¡µé¢
        @self.app.get("/knowledge-graph", response_class=HTMLResponse)
        async def knowledge_graph_page():
            """çŸ¥è¯†å›¾è°±å¯è§†åŒ–é¡µé¢"""
            return self.templates.TemplateResponse(
                "knowledge-graph.html", {"request": {}}
            )

        # æ–‡ä»¶ç®¡ç†é¡µé¢
        @self.app.get("/file-management", response_class=HTMLResponse)
        async def file_management_page():
            """æ–‡ä»¶ç®¡ç†é¡µé¢"""
            return self.templates.TemplateResponse(
                "file-management.html", {"request": {}}
            )

        # æœç´¢ç•Œé¢
        @self.app.get("/search", response_class=HTMLResponse)
        async def search_interface():
            """æœç´¢ç•Œé¢"""
            return self.templates.TemplateResponse(
                "search-interface.html", {"request": {}}
            )

    async def initialize_components(self):
        """å¼‚æ­¥åˆå§‹åŒ–æ ¸å¿ƒç»„ä»¶"""
        try:
            logger.info("Initializing RAG Web Application components...")

            # åˆå§‹åŒ–æ–‡ä»¶è§£æå™¨
            self.file_parser = UniversalFileParser()
            await self.file_parser.initialize()

            # åˆå§‹åŒ–RAGå¼•æ“
            self.rag_engine = HybridRAGEngine()
            await self.rag_engine.initialize()

            # åˆå§‹åŒ–çŸ¥è¯†å›¾è°±
            self.knowledge_graph = DynamicKnowledgeGraph()
            await self.knowledge_graph.initialize()

            # åˆå§‹åŒ–æ³¨å…¥ç®¡é“
            self.ingestion_pipeline = SmartIngestionPipeline()
            await self.ingestion_pipeline.initialize()

            logger.info("RAG Web Application components initialized successfully")

        except Exception as e:
            logger.error(f"Failed to initialize RAG components: {str(e)}")
            raise

    def get_app(self):
        """è·å–FastAPIåº”ç”¨å®ä¾‹"""
        return self.app


# åˆ›å»ºåº”ç”¨å®ä¾‹
rag_web_app = RAGWebApp()
app = rag_web_app.get_app()


@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨äº‹ä»¶"""
    await rag_web_app.initialize_components()


@app.on_event("shutdown")
async def shutdown_event():
    """åº”ç”¨å…³é—­äº‹ä»¶"""
    logger.info("Shutting down RAG Web Application...")


def main():
    """ä¸»è¿è¡Œå‡½æ•°"""
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8001,  # RAGä¸“ç”¨ç«¯å£
        reload=True,
        log_level="info",
        access_log=True,
    )


if __name__ == "__main__":
    main()
