<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>RAGé¢„å¤„ç†ä¸­å¿ƒ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", sans-serif;
            background: #f6f8fb;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 1180px;
            margin: 30px auto;
            padding: 0 20px 40px;
        }
        .page-header {
            margin-bottom: 25px;
        }
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a237e;
        }
        .page-desc {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 18px;
        }
        .stage-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(25,118,210,0.08);
            display: flex;
            flex-direction: column;
            min-height: 300px;
            transition: transform 0.2s ease;
        }
        .stage-card:hover {
            transform: translateY(-4px);
        }
        .stage-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }
        .stage-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(33,150,243,0.1);
            color: #1976d2;
        }
        .stage-title {
            font-size: 18px;
            font-weight: 600;
        }
        .stage-desc {
            font-size: 13px;
            color: #607d8b;
            margin-bottom: 16px;
        }
        .stage-status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .stage-status-chip {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(25,118,210,0.1);
            color: #1565c0;
        }
        .stage-updated {
            font-size: 11px;
            color: #90a4ae;
        }
        .stage-steps {
            flex: 1;
        }
        .step-item {
            padding: 9px 0;
            border-bottom: 1px solid rgba(226,232,240,0.8);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .step-item:last-child {
            border-bottom: none;
        }
        .step-item span {
            font-weight: 600;
            color: #1a237e;
        }
        .actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .action-btn {
            border: none;
            padding: 12px 20px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            box-shadow: 0 6px 18px rgba(25,118,210,0.4);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(25,118,210,0.45);
        }
        .timeline {
            margin-top: 35px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(25,118,210,0.08);
        }
        .timeline-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .pipeline-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            font-size: 13px;
            color: #455a64;
            margin-bottom: 15px;
        }
        .pipeline-chip {
            padding: 4px 10px;
            border-radius: 8px;
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            font-weight: 600;
        }
        .timeline-steps {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        .timeline-step {
            flex: 1;
            text-align: center;
            font-size: 13px;
            color: #546e7a;
        }
        .timeline-step span {
            display: block;
            font-weight: 700;
            color: #1a237e;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <div class="page-title">RAG æ–‡æ¡£é¢„å¤„ç†ä¸­å¿ƒ</div>
            <div class="page-desc">å››å¤§é¢„å¤„ç†æ­¥éª¤ï¼ˆæ¸…æ´— / æ ‡å‡†åŒ– / å»é‡ / éªŒè¯ï¼‰è‡ªåŠ¨ç¼–æ’ï¼Œå¯å•æ­¥æ‰§è¡Œæˆ–ä¸€é”®æµæ°´çº¿åŒ–ã€‚</div>
        </div>

        <div class="workflow-grid">
            <div class="stage-card">
                <div class="stage-header">
                    <div class="stage-icon">ğŸ§¼</div>
                    <div class="stage-title">1. æ¸…æ´—ï¼ˆCleaningï¼‰</div>
                </div>
                <div class="stage-desc">å»å™ªã€æ‹†åˆ†ã€æ ‡ç­¾åŒ–ã€å…ƒæ•°æ®æŠ½å–ï¼Œç¡®ä¿æ–‡æ¡£å¹²å‡€å¯æ§ã€‚</div>
                <div class="stage-status-row">
                    <span class="stage-status-chip" id="stage-status-clean">æœªå¯åŠ¨</span>
                    <span class="stage-updated" id="stage-updated-clean">--</span>
                </div>
                <div class="stage-steps">
                    <div class="step-item"><span>1.1</span> HTMLæ ‡ç­¾ã€è„šæœ¬å‰¥ç¦»</div>
                    <div class="step-item"><span>1.2</span> ç©ºç™½/æ§åˆ¶å­—ç¬¦æ¸…ç†</div>
                    <div class="step-item"><span>1.3</span> æ®µè½ç»“æ„æ™ºèƒ½åˆ‡åˆ†</div>
                    <div class="step-item"><span>1.4</span> å…ƒæ•°æ®æå–ä¸è¡¥å…¨</div>
                </div>
            </div>

            <div class="stage-card">
                <div class="stage-header">
                    <div class="stage-icon">ğŸ“</div>
                    <div class="stage-title">2. æ ‡å‡†åŒ–ï¼ˆStandardizeï¼‰</div>
                </div>
                <div class="stage-desc">ç»Ÿä¸€ç¼–ç ã€ç« èŠ‚ã€è¯­è¨€ä¸æ ¼å¼ï¼Œè®©å†…å®¹å¯ä¸€è‡´å…¥åº“ã€‚</div>
                <div class="stage-status-row">
                    <span class="stage-status-chip" id="stage-status-standardize">æœªå¯åŠ¨</span>
                    <span class="stage-updated" id="stage-updated-standardize">--</span>
                </div>
                <div class="stage-steps">
                    <div class="step-item"><span>2.1</span> æ–‡æœ¬ç¼–ç  / è¯­è¨€è§„èŒƒ</div>
                    <div class="step-item"><span>2.2</span> ç« èŠ‚ / æ ‡é¢˜å±‚çº§å¯¹é½</div>
                    <div class="step-item"><span>2.3</span> å…¬å¼ / ä»£ç æ®µå¤„ç†</div>
                    <div class="step-item"><span>2.4</span> ç»“æ„åŒ–å­—æ®µæ˜ å°„</div>
                </div>
            </div>

            <div class="stage-card">
                <div class="stage-header">
                    <div class="stage-icon">â™»ï¸</div>
                    <div class="stage-title">3. å»é‡ï¼ˆDeduplicateï¼‰</div>
                </div>
                <div class="stage-desc">åŸºäºå“ˆå¸Œ / å‘é‡ / è§„åˆ™ä¸‰é‡å»é‡ï¼Œé¿å…é‡å¤å…¥åº“ã€‚</div>
                <div class="stage-status-row">
                    <span class="stage-status-chip" id="stage-status-deduplicate">æœªå¯åŠ¨</span>
                    <span class="stage-updated" id="stage-updated-deduplicate">--</span>
                </div>
                <div class="stage-steps">
                    <div class="step-item"><span>3.1</span> æŒ‡çº¹å“ˆå¸Œæ£€æµ‹</div>
                    <div class="step-item"><span>3.2</span> ç›¸ä¼¼åº¦ / å‘é‡æ¯”å¯¹</div>
                    <div class="step-item"><span>3.3</span> é‡å¤æ®µè½è£å‰ª</div>
                    <div class="step-item"><span>3.4</span> é‡å¤å®ä¾‹æŠ¥å‘Š</div>
                </div>
            </div>

            <div class="stage-card">
                <div class="stage-header">
                    <div class="stage-icon">âœ…</div>
                    <div class="stage-title">4. éªŒè¯ï¼ˆValidationï¼‰</div>
                </div>
                <div class="stage-desc">è´¨é‡æ ¡éªŒ + çœŸå®æ€§è¯„åˆ† + åˆè§„æ£€æŸ¥ï¼Œç¡®ä¿å¯ä¿¡å¯è¿½æº¯ã€‚</div>
                <div class="stage-status-row">
                    <span class="stage-status-chip" id="stage-status-validate">æœªå¯åŠ¨</span>
                    <span class="stage-updated" id="stage-updated-validate">--</span>
                </div>
                <div class="stage-steps">
                    <div class="step-item"><span>4.1</span> å†…å®¹å®Œæ•´æ€§æ£€æŸ¥</div>
                    <div class="step-item"><span>4.2</span> äº‹å®æ ¸éªŒ / å¯ä¿¡åº¦</div>
                    <div class="step-item"><span>4.3</span> åˆè§„ / æ•æ„Ÿé¡¹å®¡æŸ¥</div>
                    <div class="step-item"><span>4.4</span> å…¥åº“å‰ç­¾åä¸è½¨è¿¹</div>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="action-btn" onclick="triggerFullPipeline()">âš¡ ä¸€é”®ç¼–æ’</button>
            <button class="action-btn" onclick="openStage('clean')">ğŸ§¼ ç‹¬ç«‹æ‰§è¡Œæ¸…æ´—</button>
            <button class="action-btn" onclick="openStage('standardize')">ğŸ“ ç‹¬ç«‹æ‰§è¡Œæ ‡å‡†åŒ–</button>
            <button class="action-btn" onclick="openStage('deduplicate')">â™»ï¸ ç‹¬ç«‹æ‰§è¡Œå»é‡</button>
            <button class="action-btn" onclick="openStage('validate')">âœ… ç‹¬ç«‹æ‰§è¡ŒéªŒè¯</button>
        </div>

        <div class="timeline">
            <div class="timeline-title">ğŸš€ æµç¨‹ç¼–æ’ / Pipeline</div>
            <div class="pipeline-info">
                <div>çŠ¶æ€ï¼š<span class="pipeline-chip" id="pipeline-status-text">æœªå¯åŠ¨</span></div>
                <div>å½“å‰ï¼š<strong id="pipeline-current-stage">--</strong></div>
                <div>Run IDï¼š<span id="pipeline-run-id">--</span></div>
            </div>
            <div class="timeline-steps">
                <div class="timeline-step">
                    <span>STEP 01</span>
                    æ¸…æ´— -> ç»“æ„åŒ–è¾“å…¥
                </div>
                <div class="timeline-step">
                    <span>STEP 02</span>
                    æ ‡å‡†åŒ– -> ç»Ÿä¸€æ¨¡æ¿
                </div>
                <div class="timeline-step">
                    <span>STEP 03</span>
                    å»é‡ -> å»é™¤å†—ä½™
                </div>
                <div class="timeline-step">
                    <span>STEP 04</span>
                    éªŒè¯ -> è´¨é‡å…¥åº“
                </div>
            </div>
        </div>
    </div>

    <script>
        const STAGE_ORDER = ['clean', 'standardize', 'deduplicate', 'validate'];
        const STAGE_LABELS = {
            clean: 'æ¸…æ´—',
            standardize: 'æ ‡å‡†åŒ–',
            deduplicate: 'å»é‡',
            validate: 'éªŒè¯'
        };
        const STATUS_TEXT = {
            idle: 'å¾…å‘½',
            queued: 'æ’é˜Ÿ',
            running: 'æ‰§è¡Œä¸­',
            success: 'å·²å®Œæˆ',
            failed: 'å¤±è´¥',
            completed: 'å·²å®Œæˆ'
        };
        let refreshTimer = null;

        function formatStatus(status) {
            return STATUS_TEXT[status] || status || 'æœªå¯åŠ¨';
        }

        function formatTimestamp(ts) {
            if (!ts) return '--';
            return ts.replace('T', ' ').slice(0, 19);
        }

        function applyPreprocessState(state) {
            if (!state) return;
            const pipeline = state.pipeline || {};
            const stages = state.stages || {};
            const statusEl = document.getElementById('pipeline-status-text');
            const stageEl = document.getElementById('pipeline-current-stage');
            const runEl = document.getElementById('pipeline-run-id');
            if (statusEl) statusEl.textContent = formatStatus(pipeline.status);
            if (stageEl) {
                stageEl.textContent = pipeline.current_stage
                    ? (STAGE_LABELS[pipeline.current_stage] || pipeline.current_stage)
                    : '--';
            }
            if (runEl) runEl.textContent = pipeline.run_id || '--';

            STAGE_ORDER.forEach(stage => {
                const info = stages[stage];
                if (!info) return;
                const statusChip = document.getElementById(`stage-status-${stage}`);
                const updatedLabel = document.getElementById(`stage-updated-${stage}`);
                if (statusChip) {
                    statusChip.textContent = formatStatus(info.status);
                }
                if (updatedLabel) {
                    updatedLabel.textContent = formatTimestamp(info.updated_at);
                }
            });
        }

        async function refreshStageStatuses() {
            try {
                const resp = await fetch('/preprocess/status');
                if (!resp.ok) throw new Error('è·å–çŠ¶æ€å¤±è´¥');
                const data = await resp.json();
                applyPreprocessState(data);
            } catch (error) {
                console.warn('è·å–é¢„å¤„ç†çŠ¶æ€å¤±è´¥:', error);
            } finally {
                refreshTimer = setTimeout(refreshStageStatuses, 5000);
            }
        }

        async function triggerFullPipeline() {
            try {
                const resp = await fetch('/preprocess/pipeline/run', { method: 'POST' });
                const result = await resp.json();
                if (!resp.ok) {
                    throw new Error(result.detail || result.message || 'è§¦å‘å¤±è´¥');
                }
                alert(result.message || 'å·²è§¦å‘é¢„å¤„ç†å…¨æµç¨‹ç¼–æ’ï¼ˆæ¸…æ´—â†’æ ‡å‡†åŒ–â†’å»é‡â†’éªŒè¯ï¼‰');
                applyPreprocessState(result.state);
            } catch (error) {
                alert('è§¦å‘ç¼–æ’å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        function openStage(stage) {
            window.open(`/preprocess/${stage}`, '_blank');
        }

        refreshStageStatuses();
        window.addEventListener('beforeunload', () => {
            if (refreshTimer) {
                clearTimeout(refreshTimer);
            }
        });
    </script>
</body>
</html>

