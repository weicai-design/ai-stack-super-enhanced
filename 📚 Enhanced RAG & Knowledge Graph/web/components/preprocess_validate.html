<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>RAGé¢„å¤„ç† - éªŒè¯</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC"; margin: 0; background: #f3f5f9; color: #111827; }
        .hero { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 38px 42px; border-bottom-left-radius: 32px; border-bottom-right-radius: 32px; }
        .hero h1 { margin: 0; font-size: 30px; }
        .hero p { margin-top: 10px; opacity: 0.9; }
        .container { max-width: 1200px; margin: -40px auto 40px; padding: 0 25px; }
        .card { background: white; border-radius: 20px; padding: 28px 32px; margin-bottom: 25px; box-shadow: 0 15px 30px rgba(16,185,129,0.15); }
        .title { font-size: 20px; font-weight: 600; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
        .item { border: 1px solid #d1fae5; border-radius: 14px; padding: 18px; background: linear-gradient(180deg, rgba(16,185,129,0.08), rgba(16,185,129,0.0)); }
        .item strong { display: block; color: #047857; margin-bottom: 6px; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-top: 20px; }
        .config-item { display: flex; flex-direction: column; gap: 6px; font-size: 13px; }
        .config-item label { font-weight: 600; color: #065f46; }
        .config-item select,
        .config-item textarea,
        .config-item input[type="text"],
        .config-item input[type="range"] { border: 1px solid #c0e3d0; border-radius: 10px; padding: 10px; font-size: 13px; font-family: inherit; }
        .config-checkbox { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #065f46; }
        .actions { margin-top: 20px; display: flex; gap: 14px; flex-wrap: wrap; }
        button { border: none; border-radius: 999px; padding: 12px 30px; font-size: 14px; cursor: pointer; color: white; background: linear-gradient(135deg, #16a085, #1abc9c); box-shadow: 0 12px 22px rgba(26,188,156,0.35); }
        button.secondary { background: transparent; color: #047857; border: 1px solid rgba(4,120,87,0.5); box-shadow: none; }
        button.ghost { background: rgba(6,95,70,0.08); color: #047857; box-shadow: none; }
        .status { margin-top: 15px; font-size: 13px; color: #065f46; }
        .report-card { border: 1px solid #d1fae5; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .report-title { font-size: 22px; font-weight: 700; }
        .report-meta { font-size: 13px; color: #047857; margin-top: 4px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; }
        .summary-card { border: 1px solid #e0f5ec; border-radius: 16px; padding: 18px; background: #f6fffb; }
        .summary-label { font-size: 12px; color: #047857; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-value { font-size: 28px; font-weight: 700; margin-top: 8px; }
        .summary-sub { font-size: 11px; color: #6b9080; text-transform: uppercase; letter-spacing: 0.5px; }
        .progress-grid { margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .progress-item { padding: 4px 0; }
        .progress-label { font-size: 13px; color: #065f46; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .progress-bar { background: #e0f2f1; border-radius: 999px; height: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #11998e, #38ef7d); width: 0%; transition: width 0.4s ease; }
        .report-section { margin-top: 30px; }
        .section-subtitle { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #065f46; }
        .issues-table { border: 1px solid #e0f5ec; border-radius: 16px; overflow: hidden; background: #fff; }
        .issues-table table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .issues-table th, .issues-table td { padding: 12px 14px; text-align: left; }
        .issues-table th { background: #f0fdf4; color: #065f46; font-weight: 600; }
        .issues-table tr:nth-child(even) { background: #fafafa; }
        .badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 11px; text-transform: uppercase; }
        .badge-high { background: rgba(244, 67, 54, 0.15); color: #c62828; }
        .badge-medium { background: rgba(255, 193, 7, 0.15); color: #b26a00; }
        .badge-low { background: rgba(76, 175, 80, 0.15); color: #1b5e20; }
        .source-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        .source-card { border: 1px solid #e0f5ec; border-radius: 14px; padding: 16px; background: #f8fffb; }
        .source-title { font-weight: 600; margin-bottom: 6px; }
        .source-match { font-size: 14px; color: #047857; font-weight: 700; }
        .timeline { border-left: 3px solid #c8eedc; margin-top: 10px; padding-left: 20px; }
        .timeline-item { margin-bottom: 14px; position: relative; }
        .timeline-item::before { content: ""; width: 12px; height: 12px; background: #16a085; border-radius: 50%; position: absolute; left: -27px; top: 4px; }
        .timeline-stage { font-weight: 600; color: #065f46; }
        .timeline-duration { font-size: 12px; color: #4b6358; }
        .empty-state { text-align: center; padding: 40px 20px; border: 1px dashed #a7f3d0; border-radius: 16px; color: #4b6358; background: #f6fffb; }
        .focus-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .focus-tag { background: rgba(6, 95, 70, 0.1); color: #065f46; padding: 3px 10px; border-radius: 999px; font-size: 11px; }
    </style>
</head>
<body>
    <div class="hero">
        <h1>âœ… éªŒè¯ï¼ˆValidationï¼‰é˜¶æ®µ</h1>
        <p>å®Œæ•´æ€§ / çœŸå®æ€§ / åˆè§„æ€§ / å…¥åº“ç­¾å â€”â€” æ„å»ºå¯ä¿¡å¯è¿½æº¯çš„çŸ¥è¯†èµ„äº§ã€‚</p>
    </div>
    <div class="container">
        <div class="card">
            <div class="title">
                æ ¸å¿ƒä»»åŠ¡ <span style="font-size:12px; margin-left:10px; color:#a7f3d0;">Stage 4 / 4</span>
            </div>
            <div class="grid">
                <div class="item">
                    <strong>4.1 å®Œæ•´æ€§</strong>
                    æ£€æŸ¥ç¼ºå¤±ç« èŠ‚ã€æ–­è£‚æ®µè½ã€å¼•ç”¨æ— æ•ˆç­‰é—®é¢˜ã€‚
                </div>
                <div class="item">
                    <strong>4.2 çœŸå®æ€§</strong>
                    å¤šæºäº¤å‰æ¯”å¯¹ + RAGäº‹å®æ ¸éªŒï¼Œè¾“å‡ºå¯ä¿¡åº¦è¯„åˆ†ã€‚
                </div>
                <div class="item">
                    <strong>4.3 åˆè§„æ•æ„Ÿ</strong>
                    æ•æ„Ÿè¯ã€PIIã€ç‰ˆæƒã€ç›‘ç®¡æ¡æ¬¾è‡ªåŠ¨æ£€æµ‹ã€‚
                </div>
                <div class="item">
                    <strong>4.4 å…¥åº“ç­¾å</strong>
                    è®°å½•å…¥åº“ç­¾åã€æ ¡éªŒå’Œã€å®¡è®¡è·Ÿè¸ªè·¯å¾„ã€‚
                </div>
            </div>
            <div class="title" style="margin-top: 30px;">çœŸå®æ€§éªŒè¯é…ç½®</div>
            <div class="config-grid">
                <div class="config-item">
                    <label for="datasetSelect">éªŒè¯æ•°æ®é›†</label>
                    <select id="datasetSelect">
                        <option value="RAGç”Ÿäº§åº“">RAGç”Ÿäº§åº“</option>
                        <option value="ERPç»“æ„åŒ–æ•°æ®">ERPç»“æ„åŒ–æ•°æ®</option>
                        <option value="å¤–éƒ¨èµ„è®¯å¿«ç…§">å¤–éƒ¨èµ„è®¯å¿«ç…§</option>
                        <option value="å®æ—¶APIç»“æœ">å®æ—¶APIç»“æœ</option>
                    </select>
                </div>
                <div class="config-item">
                    <label for="confidenceInput">å¯ä¿¡åº¦é˜ˆå€¼ <span id="confidenceValue">85</span>%</label>
                    <input type="range" id="confidenceInput" min="60" max="99" value="85" oninput="updateConfidenceLabel(this.value)">
                </div>
                <div class="config-item">
                    <label for="focusInput">é‡ç‚¹å…³æ³¨ä¸»é¢˜</label>
                    <textarea id="focusInput" rows="3" placeholder="å¦‚ï¼šä¾›åº”é“¾äº¤ä»˜ã€è´¢åŠ¡é¢„æµ‹ã€åˆè§„å®¡è®¡..."></textarea>
                </div>
                <div class="config-item">
                    <label>é«˜çº§ç­–ç•¥</label>
                    <label class="config-checkbox">
                        <input type="checkbox" id="multiSourceCheck" checked>
                        å¯ç”¨å¤šæºäº¤å‰éªŒè¯
                    </label>
                    <label class="config-checkbox">
                        <input type="checkbox" id="sensitivityCheck" checked>
                        å¼ºåŒ–æ•æ„Ÿä¿¡æ¯æ£€æµ‹
                    </label>
                    <label class="config-checkbox">
                        <input type="checkbox" id="autoRewriteCheck">
                        å¯¹å†²çªæ®µè½è‡ªåŠ¨ç”Ÿæˆä¿®å¤å»ºè®®
                    </label>
                </div>
            </div>
            <div class="actions">
                <button onclick="runStage()">âš¡ æ‰§è¡ŒéªŒè¯é˜¶æ®µ</button>
                <button class="secondary" onclick="openPipeline()">è¿”å›é¢„å¤„ç†ç¼–æ’</button>
                <button class="ghost" onclick="loadLatestReport()">åˆ·æ–°æŠ¥å‘Š</button>
                <button onclick="generateValidationReport()">ğŸ“Š ç”ŸæˆçœŸå®æ€§æŠ¥å‘Š</button>
            </div>
            <div class="status" id="statusText">ç­‰å¾…ä»»åŠ¡...</div>
        </div>

        <div class="card report-card">
            <div class="report-header">
                <div>
                    <div class="report-title">çœŸå®æ€§éªŒè¯å¯è§†åŒ–</div>
                    <div class="report-meta" id="reportMeta">å°šæœªç”ŸæˆæŠ¥å‘Š</div>
                    <div class="focus-tags" id="focusTags"></div>
                </div>
                <div>
                    <div style="font-size:12px; color:#047857;">æŠ¥å‘ŠID</div>
                    <div id="reportId" style="font-weight:600;">--</div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">çœŸå®æ€§è¯„åˆ†</div>
                    <div class="summary-value" id="truthScore">--</div>
                    <div class="summary-sub">Truthfulness</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ä¸€è‡´æ€§è¯„åˆ†</div>
                    <div class="summary-value" id="consistencyScore">--</div>
                    <div class="summary-sub">Consistency</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">åˆè§„æ€§è¯„åˆ†</div>
                    <div class="summary-value" id="complianceScore">--</div>
                    <div class="summary-sub">Compliance</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">å·²éªŒè¯äº‹å®</div>
                    <div class="summary-value" id="verifiedFacts">--</div>
                    <div class="summary-sub">Facts</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">é£é™©é¡¹</div>
                    <div class="summary-value" id="issuesFound">--</div>
                    <div class="summary-sub">Issues</div>
                </div>
            </div>

            <div class="progress-grid">
                <div class="progress-item">
                    <div class="progress-label">
                        <span>çœŸå®æ€§</span><span id="truthPercent">--</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="truthBar"></div></div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>ä¸€è‡´æ€§</span><span id="consistencyPercent">--</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="consistencyBar"></div></div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>åˆè§„æ€§</span><span id="compliancePercent">--</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="complianceBar"></div></div>
                </div>
            </div>

            <div class="report-section">
                <div class="section-subtitle">é£é™© & å»ºè®®</div>
                <div class="issues-table" id="issuesTable">
                    <div class="empty-state">æš‚æ— é£é™©é¡¹ï¼Œç”ŸæˆæŠ¥å‘Šåå°†å±•ç¤ºå†²çªäº‹å®ã€ç¼ºå¤±å¼•ç”¨ç­‰ä¿¡æ¯ã€‚</div>
                </div>
            </div>

            <div class="report-section">
                <div class="section-subtitle">å¤šæºéªŒè¯åŒ¹é…åº¦</div>
                <div class="source-list" id="sourcesList">
                    <div class="empty-state">ç­‰å¾…æŠ¥å‘Šç”Ÿæˆ...</div>
                </div>
            </div>

            <div class="report-section">
                <div class="section-subtitle">æ‰§è¡Œæ—¶é—´çº¿</div>
                <div class="timeline" id="timelineList">
                    <div class="timeline-item">
                        <div class="timeline-stage">å°šæœªæ‰§è¡Œ</div>
                        <div class="timeline-duration">è§¦å‘éªŒè¯æµç¨‹åæ˜¾ç¤º</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const STATUS_MAP = {
            idle: 'å¾…å‘½',
            queued: 'æ’é˜Ÿ',
            running: 'æ‰§è¡Œä¸­',
            success: 'å·²å®Œæˆ',
            failed: 'å¤±è´¥'
        };

        async function runStage() {
            const status = document.getElementById('statusText');
            status.textContent = 'æ­£åœ¨è°ƒåº¦éªŒè¯ä»»åŠ¡...';
            try {
                const resp = await fetch('/preprocess/run/validate', { method: 'POST' });
                const result = await resp.json();
                if (!resp.ok) {
                    throw new Error(result.detail || result.message || 'è°ƒåº¦å¤±è´¥');
                }
                const stageState = result.stage_state || {};
                const statusText = STATUS_MAP[stageState.status] || stageState.status || 'å·²æäº¤';
                status.textContent = `${stageState.label || 'éªŒè¯'}ï¼š${stageState.detail || ''}ï¼ˆ${statusText}ï¼‰`;
            } catch (error) {
                status.textContent = 'è°ƒåº¦å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯');
            }
        }
        function openPipeline() {
            window.open('/preprocess', '_blank');
        }
        function updateConfidenceLabel(value) {
            document.getElementById('confidenceValue').textContent = value;
        }
        function collectValidationConfig() {
            const focusRaw = document.getElementById('focusInput').value || '';
            return {
                dataset: document.getElementById('datasetSelect').value,
                confidence: parseInt(document.getElementById('confidenceInput').value, 10),
                focus_topics: focusRaw.split(/[,ï¼Œ]/).map(t => t.trim()).filter(Boolean),
                enable_multi_source: document.getElementById('multiSourceCheck').checked,
                enable_sensitivity: document.getElementById('sensitivityCheck').checked,
                enable_auto_rewrite: document.getElementById('autoRewriteCheck').checked
            };
        }
        async function generateValidationReport() {
            const status = document.getElementById('statusText');
            status.textContent = 'æ­£åœ¨ç”ŸæˆçœŸå®æ€§éªŒè¯æŠ¥å‘Š...';
            try {
                const payload = collectValidationConfig();
                const resp = await fetch('/preprocess/validate/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();
                if (!resp.ok) throw new Error(result.detail || result.message || 'ç”Ÿæˆå¤±è´¥');
                status.textContent = 'æŠ¥å‘Šç”ŸæˆæˆåŠŸ';
                if (result.report) {
                    renderValidationReport(result.report);
                }
            } catch (error) {
                status.textContent = 'æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯');
            }
        }
        async function loadLatestReport() {
            try {
                const resp = await fetch('/preprocess/validate/report/latest');
                if (!resp.ok) throw new Error('æš‚æ— æœ€æ–°æŠ¥å‘Š');
                const result = await resp.json();
                if (result.report) {
                    renderValidationReport(result.report);
                }
            } catch (error) {
                document.getElementById('reportMeta').textContent = error.message || 'æš‚æ— æŠ¥å‘Š';
                document.getElementById('issuesTable').innerHTML = '<div class="empty-state">æš‚æ— å†å²æŠ¥å‘Šï¼Œè¯·å…ˆç”Ÿæˆä¸€æ¬¡ã€‚</div>';
                document.getElementById('sourcesList').innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                document.getElementById('timelineList').innerHTML = '<div class="timeline-item"><div class="timeline-stage">ç­‰å¾…æ‰§è¡Œ</div><div class="timeline-duration">è§¦å‘éªŒè¯åæ›´æ–°</div></div>';
            }
        }
        function renderValidationReport(report) {
            const meta = document.getElementById('reportMeta');
            meta.textContent = `${report.dataset} â€¢ ${formatDate(report.generated_at)}`;
            document.getElementById('reportId').textContent = report.report_id || '--';
            renderFocusTags(report.focus_topics || []);
            const summary = report.summary || {};
            setSummaryValue('truthScore', summary.truth_score, '%');
            setSummaryValue('consistencyScore', summary.consistency_score, '%');
            setSummaryValue('complianceScore', summary.compliance_score, '%');
            setSummaryValue('verifiedFacts', summary.verified_facts || '--', '');
            setSummaryValue('issuesFound', summary.issues_found || 0, 'é¡¹');
            updateProgressBar('truth', summary.truth_score || 0);
            updateProgressBar('consistency', summary.consistency_score || 0);
            updateProgressBar('compliance', summary.compliance_score || 0);
            renderIssues(report.issues || []);
            renderSources(report.sources || []);
            renderTimeline(report.timeline || []);
        }
        function renderFocusTags(topics) {
            const container = document.getElementById('focusTags');
            container.innerHTML = '';
            if (!topics.length) return;
            topics.forEach(topic => {
                const span = document.createElement('span');
                span.className = 'focus-tag';
                span.textContent = topic;
                container.appendChild(span);
            });
        }
        function setSummaryValue(id, value, suffix = '') {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = (value !== undefined && value !== null && value !== '') ? `${value}${suffix}` : '--';
        }
        function updateProgressBar(prefix, value) {
            const percent = Math.min(100, Math.max(0, value || 0));
            const bar = document.getElementById(`${prefix}Bar`);
            const label = document.getElementById(`${prefix}Percent`);
            if (bar) bar.style.width = `${percent}%`;
            if (label) label.textContent = `${percent}%`;
        }
        function renderIssues(issues) {
            const container = document.getElementById('issuesTable');
            if (!issues.length) {
                container.innerHTML = '<div class="empty-state">æœ¬æ¬¡éªŒè¯æœªæ£€æµ‹åˆ°é£é™©é¡¹ã€‚</div>';
                return;
            }
            const rows = issues.map(issue => `
                <tr>
                    <td>${issue.type || '--'}</td>
                    <td>${issue.detail || '--'}</td>
                    <td><span class="badge ${severityBadge(issue.severity)}">${issue.severity || 'æ™®é€š'}</span></td>
                    <td>${issue.suggestion || '--'}</td>
                </tr>
            `).join('');
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ç±»å‹</th>
                            <th>è¯¦æƒ…</th>
                            <th>ç­‰çº§</th>
                            <th>å»ºè®®åŠ¨ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }
        function severityBadge(severity = '') {
            const level = severity.toLowerCase();
            if (level === 'high') return 'badge-high';
            if (level === 'medium') return 'badge-medium';
            return 'badge-low';
        }
        function renderSources(sources) {
            const container = document.getElementById('sourcesList');
            if (!sources.length) {
                container.innerHTML = '<div class="empty-state">æš‚æ— å¤šæºå¯¹æ¯”ç»“æœã€‚</div>';
                return;
            }
            container.innerHTML = sources.map(src => `
                <div class="source-card">
                    <div class="source-title">${src.name || 'æœªçŸ¥æ¥æº'}</div>
                    <div>åŒ¹é…åº¦ï¼š<span class="source-match">${Math.round((src.match || 0) * 100)}%</span></div>
                    <div style="font-size:12px; color:#4b6358; margin-top:4px;">
                        çŠ¶æ€ï¼š${src.status === 'verified' ? 'âœ… å·²éªŒè¯' : 'âš ï¸ å¾…å¤æ ¸'}
                    </div>
                </div>
            `).join('');
        }
        function renderTimeline(timeline) {
            const container = document.getElementById('timelineList');
            if (!timeline.length) {
                container.innerHTML = '<div class="timeline-item"><div class="timeline-stage">ç­‰å¾…æ‰§è¡Œ</div><div class="timeline-duration">è§¦å‘éªŒè¯åæ›´æ–°</div></div>';
                return;
            }
            container.innerHTML = timeline.map(item => `
                <div class="timeline-item">
                    <div class="timeline-stage">${item.stage || '--'}</div>
                    <div class="timeline-duration">è€—æ—¶ ${item.duration || '--'} s</div>
                </div>
            `).join('');
        }
        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            if (Number.isNaN(date.getTime())) return dateStr;
            return date.toLocaleString('zh-CN', { hour12: false });
        }
        document.addEventListener('DOMContentLoaded', () => {
            loadLatestReport();
        });
    </script>
</body>
</html>

