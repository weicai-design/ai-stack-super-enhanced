# 四项预处理流程说明

根据需求1.2：**所有文件、数据进入RAG库前，进行四项预处理**

---

## 📋 当前实现状态

在 `multi_stage_preprocessor.py` 中已经实现了四项预处理：

### ✅ 阶段1: NormalizeStage - 规范化处理
- **功能**: 文本标准化
- **内容**:
  - 统一换行符（\r\n, \r → \n）
  - 去除多余空白字符
  - 去除行尾空白
  - 去除首尾空白

### ✅ 阶段2: SafetyFilterStage - 安全过滤
- **功能**: 内容安全过滤
- **内容**:
  - 邮箱脱敏（可选）
  - URL脱敏（可选）
  - 长度限制（默认20000字符）

### ✅ 阶段3: QualityAssessStage - 质量评估
- **功能**: 内容质量验证
- **内容**:
  - 字符数统计
  - 行数统计
  - 唯一字符比例计算
  - 质量评分（字符>=10且唯一比例>=0.1）

### ✅ 阶段4: MetadataUnifyStage - 元数据统一
- **功能**: 元数据标准化
- **内容**:
  - 计算MD5校验和
  - 统一元数据格式
  - 添加checksum标识

---

## 🎯 需求对齐

根据需求1.2，四项预处理应包含：

1. **文档清洗** ✅ (NormalizeStage)
2. **安全过滤** ✅ (SafetyFilterStage)  
3. **质量验证** ✅ (QualityAssessStage)
4. **去重处理** ⚠️ (需要增强 - 当前通过checksum，但需要更完善的去重机制)

---

## 🔧 需要增强的内容

### 1. 增强去重处理

当前仅通过checksum进行简单去重，需要：

- [ ] 实现语义相似度去重
- [ ] 实现内容相似度检测
- [ ] 实现重复片段识别
- [ ] 实现跨文档去重

### 2. 增强质量验证

当前质量评估较简单，可以增强：

- [ ] 语言检测和验证
- [ ] 内容完整性检查
- [ ] 编码格式验证
- [ ] 恶意内容检测

### 3. 增强文档清洗

- [ ] 去除HTML标签（如存在）
- [ ] 去除特殊字符和控制字符
- [ ] 统一编码格式
- [ ] 修复常见编码错误

---

## 📝 建议的四项预处理定义

基于当前实现和需求，建议四项预处理为：

1. **规范化清洗** (NormalizeStage)
   - 文本标准化
   - 编码统一
   - 格式清理

2. **安全过滤** (SafetyFilterStage)
   - 敏感信息处理
   - 内容安全检查
   - 长度限制

3. **质量验证** (QualityAssessStage)
   - 内容质量评估
   - 完整性检查
   - 有效性验证

4. **去重和元数据统一** (增强MetadataUnifyStage)
   - 语义去重
   - 重复检测
   - 元数据标准化

---

**状态**: ✅ 四项预处理基础已完成，需要增强去重机制

