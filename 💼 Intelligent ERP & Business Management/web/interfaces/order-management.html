<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•ç®¡ç† - ERPç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
    <script src="common-functions.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 24px; }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card .label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸ“¦ è®¢å•ç®¡ç†</h1>
        </div>
        
        <div class="container">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stat-cards">
                <div class="stat-card">
                    <div class="label">è®¢å•æ€»æ•°</div>
                    <div class="value">{{ statistics.total }}</div>
                </div>
                <div class="stat-card">
                    <div class="label">å¾…å¤„ç†</div>
                    <div class="value">{{ statistics.pending }}</div>
                </div>
                <div class="stat-card">
                    <div class="label">è¿›è¡Œä¸­</div>
                    <div class="value">{{ statistics.in_progress }}</div>
                </div>
                <div class="stat-card">
                    <div class="label">å·²å®Œæˆ</div>
                    <div class="value">{{ statistics.completed }}</div>
                </div>
            </div>

            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <el-form :inline="true">
                    <el-form-item label="è®¢å•çŠ¶æ€">
                        <el-select v-model="filters.status" clearable @change="loadOrders" style="width: 150px">
                            <el-option label="å…¨éƒ¨" value="" />
                            <el-option label="å¾…å¤„ç†" value="pending" />
                            <el-option label="å·²ç¡®è®¤" value="confirmed" />
                            <el-option label="ç”Ÿäº§ä¸­" value="in_production" />
                            <el-option label="å·²å®Œæˆ" value="completed" />
                        </el-select>
                    </el-form-item>
                    <el-form-item label="æ—¥æœŸèŒƒå›´">
                        <el-date-picker
                            v-model="dateRange"
                            type="daterange"
                            range-separator="è‡³"
                            start-placeholder="å¼€å§‹æ—¥æœŸ"
                            end-placeholder="ç»“æŸæ—¥æœŸ"
                            @change="loadOrders"
                        />
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="loadOrders">æŸ¥è¯¢</el-button>
                        <el-button type="success" @click="showAddDialog">æ–°å¢è®¢å•</el-button>
                        <el-button @click="exportData">å¯¼å‡º</el-button>
                    </el-form-item>
                </el-form>
            </div>

            <!-- è®¢å•è¡¨æ ¼ -->
            <div class="table-container">
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <el-button v-if="selectedOrders.length > 0" type="danger" size="small" @click="batchDelete">æ‰¹é‡åˆ é™¤ ({{ selectedOrders.length }})</el-button>
                        <el-button v-if="selectedOrders.length > 0" type="success" size="small" @click="batchExport">æ‰¹é‡å¯¼å‡º ({{ selectedOrders.length }})</el-button>
                    </div>
                    <div>
                        <el-button type="info" size="small" @click="showAdvancedFilter = !showAdvancedFilter">é«˜çº§ç­›é€‰</el-button>
                        <el-button type="warning" size="small" @click="importData">å¯¼å…¥æ•°æ®</el-button>
                    </div>
                </div>
                
                <!-- é«˜çº§ç­›é€‰ -->
                <div v-if="showAdvancedFilter" style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px;">
                    <el-form :inline="true">
                        <el-form-item label="è®¢å•é‡‘é¢èŒƒå›´">
                            <el-input-number v-model="advancedFilters.min_amount" :precision="2" placeholder="æœ€å°é‡‘é¢" style="width: 150px;" />
                            <span style="margin: 0 10px;">-</span>
                            <el-input-number v-model="advancedFilters.max_amount" :precision="2" placeholder="æœ€å¤§é‡‘é¢" style="width: 150px;" />
                        </el-form-item>
                        <el-form-item label="å®¢æˆ·åç§°">
                            <el-input v-model="advancedFilters.customer_name" placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°" clearable style="width: 200px;" />
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="applyAdvancedFilter">åº”ç”¨ç­›é€‰</el-button>
                            <el-button @click="resetAdvancedFilter">é‡ç½®</el-button>
                        </el-form-item>
                    </el-form>
                </div>
                
                <el-table 
                    :data="orders" 
                    v-loading="loading" 
                    stripe
                    @selection-change="handleSelectionChange"
                >
                    <el-table-column type="selection" width="55" />
                    <el-table-column prop="order_no" label="è®¢å•å·" width="150" />
                    <el-table-column prop="customer_name" label="å®¢æˆ·åç§°" width="150" />
                    <el-table-column prop="total_amount" label="è®¢å•é‡‘é¢" width="120">
                        <template #default="scope">
                            Â¥{{ scope.row.total_amount?.toFixed(2) }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="status" label="çŠ¶æ€" width="100">
                        <template #default="scope">
                            <el-tag :type="getStatusType(scope.row.status)">
                                {{ getStatusText(scope.row.status) }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="order_date" label="è®¢å•æ—¥æœŸ" width="120" />
                    <el-table-column prop="delivery_date" label="äº¤ä»˜æ—¥æœŸ" width="120" />
                    <el-table-column label="æ“ä½œ" width="200" fixed="right">
                        <template #default="scope">
                            <el-button size="small" @click="viewOrder(scope.row)">æŸ¥çœ‹</el-button>
                            <el-button size="small" type="primary" @click="editOrder(scope.row)">ç¼–è¾‘</el-button>
                            <el-button size="small" type="danger" @click="deleteOrder(scope.row)">åˆ é™¤</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <!-- åˆ†é¡µ -->
                <el-pagination
                    v-model:current-page="pagination.page"
                    v-model:page-size="pagination.size"
                    :total="pagination.total"
                    :page-sizes="[10, 20, 50, 100]"
                    layout="total, sizes, prev, pager, next, jumper"
                    @size-change="loadOrders"
                    @current-change="loadOrders"
                    style="margin-top: 20px; justify-content: flex-end;"
                />
            </div>
        </div>

        <!-- æ–°å¢/ç¼–è¾‘å¯¹è¯æ¡† -->
        <el-dialog v-model="dialogVisible" :title="dialogTitle" width="800px">
            <el-form :model="form" label-width="120px">
                <el-form-item label="å®¢æˆ·">
                    <el-select v-model="form.customer_id" filterable style="width: 100%">
                        <el-option v-for="c in customers" :key="c.id" :label="c.name" :value="c.id" />
                    </el-select>
                </el-form-item>
                <el-form-item label="è®¢å•æ—¥æœŸ">
                    <el-date-picker v-model="form.order_date" type="date" style="width: 100%" />
                </el-form-item>
                <el-form-item label="äº¤ä»˜æ—¥æœŸ">
                    <el-date-picker v-model="form.delivery_date" type="date" style="width: 100%" />
                </el-form-item>
                <el-form-item label="è®¢å•é‡‘é¢">
                    <el-input-number v-model="form.total_amount" :precision="2" style="width: 100%" />
                </el-form-item>
                <el-form-item label="å¤‡æ³¨">
                    <el-input v-model="form.remarks" type="textarea" :rows="3" />
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="saveOrder">ä¿å­˜</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    orders: [],
                    customers: [],
                    statistics: {
                        total: 0,
                        pending: 0,
                        in_progress: 0,
                        completed: 0
                    },
                    filters: {
                        status: ''
                    },
                    dateRange: null,
                    selectedOrders: [],
                    showAdvancedFilter: false,
                    advancedFilters: {
                        min_amount: null,
                        max_amount: null,
                        customer_name: ''
                    },
                    pagination: {
                        page: 1,
                        size: 20,
                        total: 0
                    },
                    dialogVisible: false,
                    dialogTitle: 'æ–°å¢è®¢å•',
                    form: {
                        id: null,
                        customer_id: null,
                        order_date: null,
                        delivery_date: null,
                        total_amount: 0,
                        remarks: ''
                    }
                }
            },
            mounted() {
                this.loadOrders();
                this.loadCustomers();
                this.loadStatistics();
            },
            methods: {
                async loadOrders() {
                    this.loading = true;
                    try {
                        const params = {
                            page: this.pagination.page,
                            size: this.pagination.size,
                            status: this.filters.status
                        };
                        if (this.dateRange) {
                            params.start_date = this.dateRange[0];
                            params.end_date = this.dateRange[1];
                        }
                        const res = await axios.get('/api/business/orders', { params });
                        this.orders = res.data.orders || [];
                        this.pagination.total = res.data.total || 0;
                    } catch (error) {
                        ElMessage.error('åŠ è½½è®¢å•å¤±è´¥: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                async loadCustomers() {
                    try {
                        const res = await axios.get('/api/business/customers');
                        this.customers = res.data.customers || [];
                    } catch (error) {
                        console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
                    }
                },
                async loadStatistics() {
                    try {
                        const res = await axios.get('/api/business/orders/statistics');
                        this.statistics = res.data || this.statistics;
                    } catch (error) {
                        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
                    }
                },
                showAddDialog() {
                    this.dialogTitle = 'æ–°å¢è®¢å•';
                    this.form = {
                        id: null,
                        customer_id: null,
                        order_date: new Date(),
                        delivery_date: null,
                        total_amount: 0,
                        remarks: ''
                    };
                    this.dialogVisible = true;
                },
                editOrder(row) {
                    this.dialogTitle = 'ç¼–è¾‘è®¢å•';
                    this.form = { ...row };
                    this.dialogVisible = true;
                },
                async saveOrder() {
                    try {
                        if (this.form.id) {
                            await axios.put(`/api/business/orders/${this.form.id}`, this.form);
                        } else {
                            await axios.post('/api/business/orders', this.form);
                        }
                        ElMessage.success('ä¿å­˜æˆåŠŸ');
                        this.dialogVisible = false;
                        this.loadOrders();
                        this.loadStatistics();
                    } catch (error) {
                        ElMessage.error('ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                },
                async deleteOrder(row) {
                    try {
                        await ElMessageBox.confirm('ç¡®å®šåˆ é™¤æ­¤è®¢å•å—ï¼Ÿ', 'æç¤º', {
                            type: 'warning'
                        });
                        await axios.delete(`/api/business/orders/${row.id}`);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        this.loadOrders();
                        this.loadStatistics();
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('åˆ é™¤å¤±è´¥: ' + error.message);
                        }
                    }
                },
                viewOrder(row) {
                    window.open(`/business/orders/${row.id}`, '_blank');
                },
                async exportData() {
                    await DataExport.exportToExcel(
                        this.orders,
                        `è®¢å•æ•°æ®_${Utils.formatDate(new Date(), 'YYYYMMDD')}.xlsx`,
                        'è®¢å•æ•°æ®'
                    );
                },
                async refreshData() {
                    await this.loadOrders();
                    ElementPlus.ElMessage.success('æ•°æ®å·²åˆ·æ–°');
                },
                handleSelectionChange(selection) {
                    this.selectedOrders = selection;
                },
                async batchDelete() {
                    if (this.selectedOrders.length === 0) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®¢å•');
                        return;
                    }
                    
                    try {
                        await CommonCRUD.batchDelete('/api/orders', this.selectedOrders.map(o => o.id), `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„${this.selectedOrders.length}ä¸ªè®¢å•å—ï¼Ÿ`);
                        this.selectedOrders = [];
                        await this.loadOrders();
                    } catch (error) {
                        // é”™è¯¯å·²åœ¨CommonCRUDä¸­å¤„ç†
                    }
                },
                async batchExport() {
                    if (this.selectedOrders.length === 0) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„è®¢å•');
                        return;
                    }
                    
                    await DataExport.exportToExcel(
                        this.selectedOrders,
                        `æ‰¹é‡è®¢å•_${Utils.formatDate(new Date(), 'YYYYMMDD')}.xlsx`,
                        `æ‰¹é‡è®¢å•æ•°æ® (${this.selectedOrders.length}æ¡)`
                    );
                },
                async applyAdvancedFilter() {
                    // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    this.pagination.page = 1;
                    await this.loadOrders();
                    ElementPlus.ElMessage.success('ç­›é€‰å·²åº”ç”¨');
                },
                resetAdvancedFilter() {
                    this.advancedFilters = {
                        min_amount: null,
                        max_amount: null,
                        customer_name: ''
                    };
                    this.loadOrders();
                },
                async importData() {
                    try {
                        const { value: fileInput } = await ElementPlus.ElMessageBox.prompt('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'å¯¼å…¥æ•°æ®', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ'
                        });
                        
                        // è¿™é‡Œåº”è¯¥å®ç°æ–‡ä»¶ä¸Šä¼ é€»è¾‘
                        ElementPlus.ElMessage.info('å¯¼å…¥åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·ä½¿ç”¨å¯¼å‡ºåŠŸèƒ½æŸ¥çœ‹æ•°æ®æ ¼å¼');
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('å¯¼å…¥å¤±è´¥:', error);
                        }
                    }
                },
                getStatusType(status) {
                    const types = {
                        'pending': 'info',
                        'confirmed': 'warning',
                        'in_production': 'primary',
                        'completed': 'success'
                    };
                    return types[status] || 'info';
                },
                getStatusText(status) {
                    const texts = {
                        'pending': 'å¾…å¤„ç†',
                        'confirmed': 'å·²ç¡®è®¤',
                        'in_production': 'ç”Ÿäº§ä¸­',
                        'completed': 'å·²å®Œæˆ'
                    };
                    return texts[status] || status;
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>

