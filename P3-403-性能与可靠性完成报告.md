# P3-403: 性能与可靠性完成报告

## 任务概述

建立性能测试、SLO报告、故障演练脚本（模拟Sidecar宕机、数据库降级、API超时等）。

## 完成内容

### 1. 性能测试框架 ✅

**核心文件**: `tests/performance/test_performance_suite.py`

**功能**:
- ✅ 负载测试（并发用户测试）
- ✅ 压力测试（递增负载测试）
- ✅ 稳定性测试（长时间运行测试）
- ✅ 基准测试（性能基准对比）

**测试类型**:

1. **负载测试** (`load_test`)
   - 支持并发用户数配置
   - 支持每个用户的请求数配置
   - 支持GET/POST/PUT等HTTP方法
   - 计算QPS、成功率、响应时间分布

2. **压力测试** (`stress_test`)
   - 递增负载（从初始用户数到最大用户数）
   - 可配置递增步长
   - 每个压力级别独立测试

3. **稳定性测试** (`stability_test`)
   - 长时间持续测试
   - 可配置测试时长和请求频率
   - 监控系统稳定性

4. **基准测试** (`benchmark_test`)
   - 多端点性能对比
   - 可配置测试次数
   - 生成性能基准数据

**性能指标**:
- 总请求数
- 成功/失败请求数
- 成功率
- 平均响应时间
- 最小/最大响应时间
- P50/P95/P99响应时间
- QPS（每秒查询数）
- 测试时长

**核心类**:
- `PerformanceTestSuite`: 性能测试套件
- `PerformanceMetrics`: 性能指标数据类

### 2. SLO报告生成器 ✅

**核心文件**: `core/slo_report_generator.py`

**功能**:
- ✅ SLO目标定义和管理
- ✅ 性能数据收集
- ✅ SLO状态计算
- ✅ SLO报告生成

**默认SLO目标**:

1. **2秒响应时间SLO**
   - 目标值: 2000ms（2秒）
   - 测量窗口: 30天
   - 错误预算: 1%
   - 描述: 95%的请求在2秒内完成

2. **99.9%可用性SLO**
   - 目标值: 99.9%
   - 测量窗口: 30天
   - 错误预算: 0.1%
   - 描述: 系统可用性达到99.9%

3. **错误率SLO**
   - 目标值: 0.1%
   - 测量窗口: 30天
   - 错误预算: 1%
   - 描述: 错误率低于0.1%

**SLO状态**:
- `MET`: 达标（错误预算消耗 < 80%）
- `AT_RISK`: 有风险（错误预算消耗 80-100%）
- `BREACHED`: 违反（错误预算消耗 >= 100%）

**核心方法**:
- `set_slo_target()`: 设置SLO目标
- `record_metric()`: 记录指标数据
- `calculate_slo_status()`: 计算SLO状态
- `generate_slo_report()`: 生成SLO报告

**报告内容**:
- 总体状态汇总
- 各SLO指标详情
- 错误预算消耗情况
- 测量周期数据

### 3. 故障演练脚本 ✅

**核心文件**: `scripts/chaos_engineering/chaos_test_runner.py`

**功能**:
- ✅ Sidecar宕机模拟
- ✅ 数据库降级模拟
- ✅ API超时模拟
- ✅ 系统弹性测试
- ✅ 恢复时间测量

**故障场景**:

1. **Sidecar宕机** (`test_sidecar_down`)
   - 停止Sidecar服务
   - 测试系统响应
   - 验证恢复机制
   - 测量恢复时间

2. **数据库降级** (`test_database_degraded`)
   - 慢查询模拟（添加延迟）
   - 连接数限制模拟
   - 磁盘满模拟
   - 测试系统降级处理

3. **API超时** (`test_api_timeout`)
   - 模拟API超时
   - 测试超时处理
   - 验证降级策略
   - 测量恢复时间

**测试流程**:
1. 记录故障前状态
2. 注入故障
3. 测试系统响应
4. 等待指定时长
5. 恢复服务
6. 验证恢复
7. 生成测试报告

**核心类**:
- `ChaosTestRunner`: 故障演练运行器
- `ChaosTestResult`: 测试结果数据类
- `ChaosScenario`: 故障场景枚举

### 4. 自动化脚本 ✅

**脚本文件**:

1. **`scripts/performance/run_performance_tests.sh`**
   - 性能测试自动化脚本
   - 支持多种测试类型
   - 自动生成测试报告

2. **`scripts/chaos_engineering/run_chaos_tests.sh`**
   - 故障演练自动化脚本
   - 支持多种故障场景
   - 安全确认机制

**使用方法**:

```bash
# 运行性能测试
./scripts/performance/run_performance_tests.sh [test_type] [base_url]

# 运行故障演练
./scripts/chaos_engineering/run_chaos_tests.sh [scenario] [duration]
```

### 5. API端点集成 ✅

**新增API端点**:

#### 性能测试API
1. **`POST /api/super-agent/performance/test/load`** - 运行负载测试
2. **`POST /api/super-agent/performance/test/stress`** - 运行压力测试

#### SLO报告API
1. **`GET /api/super-agent/slo/report`** - 获取SLO报告
2. **`POST /api/super-agent/slo/target`** - 设置SLO目标

#### 故障演练API
1. **`POST /api/super-agent/chaos/test/sidecar-down`** - Sidecar宕机测试
2. **`POST /api/super-agent/chaos/test/database-degraded`** - 数据库降级测试
3. **`POST /api/super-agent/chaos/test/api-timeout`** - API超时测试

## 架构设计

### 性能测试架构

```
性能测试请求
    ↓
PerformanceTestSuite
    ├── 负载测试
    ├── 压力测试
    ├── 稳定性测试
    └── 基准测试
    ↓
性能指标收集
    ↓
测试报告生成
```

### SLO监控架构

```
性能数据
    ↓
SLOReportGenerator
    ├── 记录指标
    ├── 计算状态
    └── 生成报告
    ↓
SLO报告
    ├── 总体状态
    ├── 各指标详情
    └── 错误预算
```

### 故障演练架构

```
故障场景
    ↓
ChaosTestRunner
    ├── 注入故障
    ├── 监控响应
    ├── 验证恢复
    └── 生成报告
    ↓
测试结果
    ├── 成功/失败
    ├── 恢复时间
    └── 影响指标
```

## 使用示例

### 1. 运行性能测试

```python
from tests.performance.test_performance_suite import PerformanceTestSuite

suite = PerformanceTestSuite(base_url="http://localhost:9000")

# 负载测试
result = await suite.load_test(
    endpoint="/health",
    concurrent_users=10,
    requests_per_user=10,
)

print(f"QPS: {result.qps:.2f}")
print(f"成功率: {result.success_rate:.2f}%")
print(f"平均响应时间: {result.avg_response_time:.2f}ms")

# 生成报告
report = suite.generate_report()
```

### 2. 生成SLO报告

```python
from core.slo_report_generator import get_slo_report_generator

generator = get_slo_report_generator()

# 记录指标
generator.record_metric("response_time_2s", 1500.0)  # 1.5秒
generator.record_metric("availability_99_9", 99.95)

# 生成报告
report = generator.generate_slo_report(measurement_period="30d")

print(f"总体状态: {report['summary']['overall_status']}")
print(f"达标: {report['summary']['met']}")
print(f"有风险: {report['summary']['at_risk']}")
print(f"违反: {report['summary']['breached']}")
```

### 3. 运行故障演练

```python
from scripts.chaos_engineering.chaos_test_runner import ChaosTestRunner

runner = ChaosTestRunner()

# Sidecar宕机测试
result = await runner.test_sidecar_down(
    sidecar_name="rag-sidecar",
    duration=60,
)

print(f"测试结果: {'成功' if result.success else '失败'}")
print(f"恢复时间: {result.recovery_time:.2f}秒")
print(f"影响指标: {result.impact_metrics}")

# 生成报告
report = runner.generate_chaos_report()
```

### 4. 使用API端点

```bash
# 运行负载测试
curl -X POST "http://localhost:9000/api/super-agent/performance/test/load" \
  -H "X-API-Key: your_key" \
  -d '{
    "endpoint": "/health",
    "concurrent_users": 10,
    "requests_per_user": 10
  }'

# 获取SLO报告
curl "http://localhost:9000/api/super-agent/slo/report" \
  -H "X-API-Key: your_key"

# 运行故障演练
curl -X POST "http://localhost:9000/api/super-agent/chaos/test/sidecar-down" \
  -H "X-API-Key: your_key" \
  -d '{
    "sidecar_name": "rag-sidecar",
    "duration": 60
  }'
```

## 验证结果

### 功能验证 ✅
- ✅ 性能测试框架已建立（负载/压力/稳定性/基准测试）
- ✅ SLO报告生成器已实现（目标定义/状态计算/报告生成）
- ✅ 故障演练脚本已创建（Sidecar宕机/数据库降级/API超时）
- ✅ 自动化脚本已创建
- ✅ API端点已集成

### 语法检查 ✅
- ✅ 所有代码通过语法检查
- ✅ 导入正确
- ✅ 类型提示完整

### 集成验证 ✅
- ✅ API端点已集成
- ✅ 脚本已添加执行权限
- ✅ 依赖关系正确

## 总结

P3-403 任务已**完全完成**，实现了：

1. ✅ **性能测试框架**: 支持负载、压力、稳定性、基准测试
2. ✅ **SLO报告生成器**: 支持SLO目标定义、状态计算、报告生成
3. ✅ **故障演练脚本**: 支持Sidecar宕机、数据库降级、API超时等场景
4. ✅ **自动化脚本**: 提供便捷的命令行工具
5. ✅ **API端点**: 提供RESTful API接口

系统现在具备了完整的性能测试和可靠性验证能力，支持：
- **性能测试**: 全面的性能测试框架，支持多种测试场景
- **SLO监控**: 完整的SLO目标管理和报告生成
- **故障演练**: 系统化的故障注入和恢复验证
- **自动化工具**: 便捷的命令行和API接口

