# 多租户认证和授权系统使用指南

## 概述

本系统实现了完整的多租户认证和授权功能，包括：

1. **JWT Token 校验** - 支持用户登录获取访问令牌
2. **API Key 管理** - 支持创建、验证、撤销 API Key
3. **命令白名单** - 基于租户的命令权限控制
4. **租户上下文绑定** - 确保所有 API 请求正确绑定租户上下文

## 功能特性

### 1. JWT Token 认证

#### 生成 Token

```bash
POST /api/tenant/auth/login
Content-Type: application/json
X-Tenant-ID: your-tenant-id

{
  "tenant_id": "your-tenant-id",
  "user_id": "user-123",
  "email": "user@example.com"
}
```

**响应：**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "bearer",
  "expires_in": 3600,
  "tenant_id": "your-tenant-id",
  "tenant_name": "Your Tenant"
}
```

#### 使用 Token

```bash
GET /api/protected-endpoint
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

#### 验证 Token

```bash
GET /api/tenant/auth/token/verify
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### 2. API Key 认证

#### 创建 API Key

```bash
POST /api/tenant/auth/api-keys
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "name": "My API Key",
  "scopes": ["read", "write"],
  "allowed_commands": ["查询订单", "创建订单"],
  "rate_limit": 100,
  "expires_days": 30
}
```

**响应：**
```json
{
  "api_key": "ak_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "api_key_info": {
    "id": "key-id-123",
    "name": "My API Key",
    "scopes": ["read", "write"],
    "allowed_commands": ["查询订单", "创建订单"],
    "rate_limit": 100,
    "is_active": true
  },
  "created_at": "2025-01-01T00:00:00",
  "expires_at": "2025-01-31T00:00:00"
}
```

**⚠️ 重要提示：** API Key 只在创建时显示一次，请妥善保管！

#### 使用 API Key

```bash
GET /api/protected-endpoint
X-API-Key: ak_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

或者使用 Authorization 头：

```bash
GET /api/protected-endpoint
Authorization: Bearer ak_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

#### 列出租户的 API Keys

```bash
GET /api/tenant/auth/api-keys
Authorization: Bearer <access_token>
```

#### 撤销 API Key

```bash
DELETE /api/tenant/auth/api-keys/{key_id}
Authorization: Bearer <access_token>
```

#### 验证 API Key

```bash
GET /api/tenant/auth/api-keys/verify
X-API-Key: ak_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 3. 命令白名单

#### 检查命令权限

```bash
POST /api/tenant/auth/command/check
X-API-Key: ak_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Content-Type: application/json

{
  "command": "查询订单"
}
```

**响应：**
```json
{
  "allowed": true,
  "command_type": "read",
  "reason": null
}
```

#### 获取命令白名单配置

```bash
GET /api/tenant/auth/command/whitelist
X-Tenant-ID: your-tenant-id
```

### 4. 租户上下文

#### 获取租户上下文

```bash
GET /api/tenant/auth/context
X-Tenant-ID: your-tenant-id
```

**响应：**
```json
{
  "context": {
    "tenant_id": "tenant-123",
    "tenant_name": "My Tenant",
    "tenant_plan": "enterprise",
    "tenant_status": "active",
    "quota": {
      "max_users": 9999999,
      "current_users": 10,
      "max_storage_gb": 999999.0,
      "current_storage_gb": 5.0,
      ...
    },
    "config": {
      "custom_domain": null,
      "enable_smart_qa": true,
      ...
    }
  },
  "tenant": {
    "id": "tenant-123",
    "name": "My Tenant",
    "plan": "enterprise",
    "status": "active"
  }
}
```

## 权限范围

### API Key 权限范围（Scopes）

- `read` - 只读权限，可以执行查询类命令
- `write` - 读写权限，可以执行创建、更新等命令
- `admin` - 管理员权限，可以执行配置和管理命令
- `full` - 完全访问权限，可以执行所有命令

### 命令分类

1. **只读命令（read）** - 查询、查看、获取、列表、搜索、统计
2. **写入命令（write）** - 创建、添加、更新、修改、删除、保存
3. **管理员命令（admin）** - 配置、设置、管理、授权、撤销
4. **危险命令（dangerous）** - 删除所有、清空、重置、格式化

## 认证优先级

API 网关会按以下顺序尝试识别租户：

1. **JWT Token** - 从 `Authorization: Bearer <token>` 头获取
2. **API Key** - 从 `X-API-Key` 或 `Authorization: Bearer <api_key>` 头获取
3. **请求头** - 从 `X-Tenant-ID` 头获取
4. **子域名** - 从请求的子域名提取租户标识
5. **查询参数** - 从 `tenant_id` 查询参数获取
6. **默认租户** - 开发环境下使用默认租户

## 环境变量配置

### JWT 配置

```bash
# JWT 密钥（生产环境必须修改！）
JWT_SECRET_KEY=your-secret-key-here

# JWT 算法
JWT_ALGORITHM=HS256

# 访问令牌过期时间（分钟）
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=60

# 刷新令牌过期时间（天）
JWT_REFRESH_TOKEN_EXPIRE_DAYS=30
```

### API Key 配置

```bash
# API Key 前缀
API_KEY_PREFIX=ak_

# API Key 长度（不含前缀）
API_KEY_LENGTH=32
```

## 安全最佳实践

### 1. JWT Token

- ✅ 使用 HTTPS 传输 Token
- ✅ 设置合理的过期时间
- ✅ 定期轮换 JWT 密钥
- ✅ 使用强密钥（至少 32 字符）
- ✅ 在生产环境禁用默认密钥

### 2. API Key

- ✅ 为每个应用程序创建独立的 API Key
- ✅ 设置最小权限范围（最小权限原则）
- ✅ 配置命令白名单
- ✅ 设置合理的过期时间
- ✅ 定期轮换 API Key
- ✅ 妥善保管 API Key，不要在代码中硬编码
- ✅ 使用环境变量或密钥管理服务存储 API Key
- ✅ 如果 API Key 泄露，立即撤销

### 3. 命令白名单

- ✅ 为每个 API Key 配置明确的允许命令列表
- ✅ 禁止执行危险命令（删除所有、清空等）
- ✅ 定期审查命令权限配置

### 4. 租户隔离

- ✅ 确保所有 API 请求都包含租户信息
- ✅ 在数据访问层强制租户隔离
- ✅ 记录所有跨租户访问尝试

## 集成到现有服务

### 1. 在 FastAPI 应用中使用

```python
from enterprise.tenancy.auth import (
    require_tenant_from_token,
    require_tenant_from_api_key,
    check_command_permission,
    get_tenant_context
)
from enterprise.tenancy.models import Tenant

app = FastAPI()

@app.get("/api/protected")
async def protected_endpoint(
    tenant: Tenant = Depends(require_tenant_from_token)
):
    """使用 JWT Token 认证"""
    return {
        "tenant_id": tenant.id,
        "tenant_name": tenant.name
    }

@app.get("/api/public")
async def public_endpoint(
    tenant_key: tuple = Depends(require_tenant_from_api_key)
):
    """使用 API Key 认证"""
    tenant, api_key = tenant_key
    return {
        "tenant_id": tenant.id,
        "api_key_name": api_key.name
    }

@app.post("/api/execute")
async def execute_command(
    command: str,
    request: Request,
    tenant: Tenant = Depends(require_tenant)
):
    """执行命令（需要权限检查）"""
    from enterprise.tenancy.auth import check_command_permission
    
    # 检查命令权限
    await check_command_permission(command, request)
    
    # 执行命令
    # ...
```

### 2. 在 API 网关中使用

API 网关已自动集成认证和授权中间件，无需额外配置。

## 故障排查

### Token 验证失败

1. 检查 Token 是否过期
2. 检查 Token 格式是否正确
3. 检查 JWT_SECRET_KEY 是否匹配
4. 检查租户状态是否正常

### API Key 验证失败

1. 检查 API Key 格式是否正确（必须以 `ak_` 开头）
2. 检查 API Key 是否已撤销
3. 检查 API Key 是否已过期
4. 检查租户状态是否正常

### 命令权限不足

1. 检查 API Key 的权限范围（scopes）
2. 检查命令是否在允许列表中
3. 检查命令类型是否需要更高权限

## API 端点汇总

| 端点 | 方法 | 描述 | 认证 |
|------|------|------|------|
| `/api/tenant/auth/login` | POST | 登录获取 Token | 租户ID |
| `/api/tenant/auth/token/verify` | GET | 验证 Token | JWT Token |
| `/api/tenant/auth/api-keys` | POST | 创建 API Key | JWT Token |
| `/api/tenant/auth/api-keys` | GET | 列出租户的 API Keys | JWT Token |
| `/api/tenant/auth/api-keys/{key_id}` | DELETE | 撤销 API Key | JWT Token |
| `/api/tenant/auth/api-keys/verify` | GET | 验证 API Key | API Key |
| `/api/tenant/auth/command/check` | POST | 检查命令权限 | 租户 |
| `/api/tenant/auth/command/whitelist` | GET | 获取命令白名单 | 租户 |
| `/api/tenant/auth/context` | GET | 获取租户上下文 | 租户 |

## 示例代码

### Python 客户端示例

```python
import httpx

# 1. 登录获取 Token
async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://localhost:8000/api/tenant/auth/login",
        headers={"X-Tenant-ID": "tenant-123"},
        json={
            "tenant_id": "tenant-123",
            "user_id": "user-456",
            "email": "user@example.com"
        }
    )
    token_data = response.json()
    access_token = token_data["access_token"]

# 2. 使用 Token 访问受保护端点
async with httpx.AsyncClient() as client:
    response = await client.get(
        "http://localhost:8000/api/protected",
        headers={"Authorization": f"Bearer {access_token}"}
    )
    data = response.json()

# 3. 创建 API Key
async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://localhost:8000/api/tenant/auth/api-keys",
        headers={"Authorization": f"Bearer {access_token}"},
        json={
            "name": "My API Key",
            "scopes": ["read", "write"],
            "allowed_commands": ["查询订单", "创建订单"]
        }
    )
    api_key_data = response.json()
    api_key = api_key_data["api_key"]

# 4. 使用 API Key 访问端点
async with httpx.AsyncClient() as client:
    response = await client.get(
        "http://localhost:8000/api/protected",
        headers={"X-API-Key": api_key}
    )
    data = response.json()
```

### cURL 示例

```bash
# 1. 登录
curl -X POST http://localhost:8000/api/tenant/auth/login \
  -H "X-Tenant-ID: tenant-123" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "tenant-123",
    "user_id": "user-456",
    "email": "user@example.com"
  }'

# 2. 使用 Token
curl -X GET http://localhost:8000/api/protected \
  -H "Authorization: Bearer <access_token>"

# 3. 创建 API Key
curl -X POST http://localhost:8000/api/tenant/auth/api-keys \
  -H "Authorization: Bearer <access_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "My API Key",
    "scopes": ["read", "write"]
  }'

# 4. 使用 API Key
curl -X GET http://localhost:8000/api/protected \
  -H "X-API-Key: ak_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

## 生产环境部署检查清单

- [ ] 修改 JWT_SECRET_KEY 为强密钥
- [ ] 配置 HTTPS
- [ ] 设置合理的 Token 过期时间
- [ ] 配置 API Key 默认过期时间
- [ ] 启用命令白名单
- [ ] 配置日志记录
- [ ] 配置监控和告警
- [ ] 进行安全审计
- [ ] 备份 API Key 和 Token 配置
- [ ] 制定密钥轮换计划

## 支持与反馈

如有问题或建议，请联系开发团队。




