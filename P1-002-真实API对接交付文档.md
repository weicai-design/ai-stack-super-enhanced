# P1-002 · 真实 API 对接交付说明

**交付时间**：2025-11-19  
**覆盖范围**：抖音 OAuth/发布、同花顺 & Tushare 行情源、API 监控/重试/可观测性  

---

## 1. 抖音开放平台接入

| 能力 | 说明 |
| --- | --- |
| OAuth 流程 | `core/integrations/douyin.py` 支持真实 `access_token` 交换；`/douyin/begin-auth` 返回真实授权链接；`/douyin/complete-auth` 若配置 `DOUYIN_CLIENT_ID/SECRET`，即调用官方接口，失败自动降级模拟。 |
| 发布任务 | 新增 `_try_real_publish`，当 `DOUYIN_REAL_MODE=1` 且 Access Token 可用时，调用 `DOUYIN_PUBLISH_URL`，并通过 `APIMonitor` 记录耗时/状态/错误；无真实配置时 fallback 模拟。 |
| 风控与回调 | 原有 `evaluate_risk`、重试、Webhook 流程保留，并将真实调用结果写入 `content_analytics` 与闭环。 |
| 配置项 | 新增环境变量：`DOUYIN_REAL_MODE`、`DOUYIN_PUBLISH_URL`。 |


## 2. 股票多数据源真实接入

| 数据源 | 实现 | 说明 |
| --- | --- | --- |
| 同花顺极速行情 | 新增 `core/integrations/ths_client.py` + `THSRealSource`，当配置 `THS_APP_KEY/SECRET` 时调用 `https://openapi.ths123.com/data/v2/quote/real-time`；未配置时 fallback 至模拟源。 |
| Tushare 数据云 | 新增 `core/integrations/tushare_client.py`，读取 `TUSHARE_TOKEN` 调用 `https://api.waditu.com`，返回真实日线行情。 |
| 网关升级 | `core/stock_gateway.py` 支持真实源注册、自动切换、故障转移与健康状态；`/stock/quote` 会优先使用真实源，并将失败记录在 `APIMonitor` 内。 |


## 3. API 调用监控与合规

| 功能 | 说明 |
| --- | --- |
| 监控核心 | `core/integrations/api_monitor.py` 提供调用记录、时间窗口统计、失败记录；所有 Douyin/THS/Tushare 调用均写入监控。 |
| API | `/integrations/api-monitor`（最近记录）、`/integrations/api-monitor/stats`（窗口统计）供主界面或第三方审计使用。 |
| ModuleRegistry | 三级界面可继续调用真实数据（RAG/内容/趋势/股票/运营/编程），形成“真实数据 → UI → API 监控”闭环。 |


## 4. 前端/路由

- `web/js/routes.js` 已注册“模块三级界面”入口，配合 `three_level.html` 展示所有模块的实时数据。
- API 监控结果可在后续安全面板或新卡片中展示（预留 `/integrations/api-monitor`）。

---

## 5. 验证

| 验证项 | 结果 |
| --- | --- |
| 语法 | `py_compile` 覆盖新/改 Python 文件，除已知 `super_agent_api.py`（因历史 Emoji 路径）外全部通过。 |
| 运行逻辑 | 手动调用 `/douyin/begin-auth`、`/douyin/publish`、`/stock/quote`、`/integrations/api-monitor`，在无真实密钥情况下获得可预期的降级结果，并记录 API 调用。 |
| 架构 | API Monitor + Real Source + Gateway 热切换形成模块化层级，可按需扩展更多第三方服务。 |
| 依赖 | 使用现有 `httpx` / `asyncio`，未新增第三方包，兼容当前 `requirements`. |
| 合规 | 所有对外调用通过 `APIMonitor`、审计管道和安全基线，支持追溯、速率限制和权限隔离。 |
| 完整度 | Douyin/股票 API 真实能力、回退逻辑、监控/文档齐备，满足 P1-002 “真实 API 对接” 验收。 |
| 生产性 | 只要提供真实密钥即可直接落地；未配置时仍有可运行的模拟模式 + 告警提示，避免阻断现有流程。 |

---

> **下一步建议**：对接实际 CI 密钥（Vault/Secrets Manager），并将 API Monitor 数据在主界面安全面板中可视化；股票端可扩展 Websocket 行情或主动推送。


