name: CI - æŒç»­é›†æˆ

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ==================== ä»£ç è´¨é‡æ£€æŸ¥ ====================
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black mypy bandit safety
    
    - name: ä»£ç æ ¼å¼æ£€æŸ¥ (Black)
      run: |
        black --check --diff .
      continue-on-error: true
    
    - name: ä»£ç é£æ ¼æ£€æŸ¥ (Flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: ç±»å‹æ£€æŸ¥ (MyPy)
      run: |
        mypy . --ignore-missing-imports
      continue-on-error: true
    
    - name: å®‰å…¨æ‰«æ (Bandit)
      run: |
        bandit -r . -f json -o bandit-report.json || true
      continue-on-error: true
    
    - name: ä¾èµ–å®‰å…¨æ£€æŸ¥ (Safety)
      run: |
        pip install -r requirements.txt
        safety check --json || true
      continue-on-error: true
    
    - name: ä¸Šä¼ BanditæŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json

  # ==================== å•å…ƒæµ‹è¯• ====================
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-asyncio
        pip install -r requirements.txt
    
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        pytest -v -m "unit and not slow" \
          --cov=. \
          --cov-report=xml \
          --cov-report=html \
          --junitxml=junit.xml
    
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ°Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
    
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit.xml
          htmlcov/
    
    # ==================== P3-016: CI è¯æ®ä¸Šä¼  ====================
    - name: ä¸Šä¼ CIè¯æ®
      if: always()
      run: |
        mkdir -p artifacts/evidence/ci/P3-016
        # å¤åˆ¶æµ‹è¯•ç»“æœæ–‡ä»¶
        if [ -f junit.xml ]; then
          cp junit.xml artifacts/evidence/ci/P3-016/test_report_${{ matrix.python-version }}_$(date +%Y%m%d_%H%M%S).xml
        fi
        if [ -d htmlcov ]; then
          cp -r htmlcov artifacts/evidence/ci/P3-016/coverage_${{ matrix.python-version }}_$(date +%Y%m%d_%H%M%S)/
        fi
        # åˆ›å»ºå…ƒæ•°æ®æ–‡ä»¶
        cat > artifacts/evidence/ci/P3-016/ci_metadata.json << EOF
        {
          "requirement_id": "P3-016",
          "python_version": "${{ matrix.python-version }}",
          "workflow": "unit-tests",
          "build_id": "${{ github.run_id }}",
          "commit_sha": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "uploaded_at": "$(date -Iseconds)"
        }
        EOF
      continue-on-error: true
    
    - name: ä¸Šä¼ è¯æ®åˆ°Artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ci-evidence-${{ matrix.python-version }}
        path: artifacts/evidence/ci/

  # ==================== é›†æˆæµ‹è¯• ====================
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      # RedisæœåŠ¡
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev
    
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio
        pip install -r requirements.txt
    
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        pytest -v -m "integration" --maxfail=5
      env:
        REDIS_HOST: localhost
        REDIS_PORT: 6379
    
  # ==================== E2Eæµ‹è¯• ====================
  e2e-tests:
    name: ç«¯åˆ°ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio
        pip install -r requirements.txt
    
    - name: è¿è¡ŒE2Eæµ‹è¯•
      run: |
        pytest -v -m "e2e" --maxfail=3
      continue-on-error: true

  # ==================== Dockeræ„å»ºæµ‹è¯• ====================
  docker-build:
    name: Dockeræ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: æ„å»ºDockeré•œåƒ
      run: |
        docker build -t ai-stack:test .
    
    - name: æµ‹è¯•Dockeré•œåƒ
      run: |
        docker run --rm ai-stack:test --version || true
    
  # ==================== å®‰å…¨æ‰«æ ====================
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è¿è¡ŒTrivyæ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: ä¸Šä¼ Trivyæ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # ==================== æ€§èƒ½æµ‹è¯• ====================
  performance-tests:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-json-report httpx
        pip install -r "ğŸš€ Super Agent Main Interface/requirements.txt"
    
    - name: åˆ›å»ºevidenceç›®å½•
      run: |
        mkdir -p "ğŸš€ Super Agent Main Interface/evidence/performance"
        mkdir -p "ğŸš€ Super Agent Main Interface/evidence/screenshots"
    
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      working-directory: "ğŸš€ Super Agent Main Interface"
      run: |
        chmod +x scripts/performance/run_performance_tests.sh
        ./scripts/performance/run_performance_tests.sh
      continue-on-error: true
      env:
        BASE_URL: http://localhost:8000
    
    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•è¯æ®
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-evidence
        path: |
          ğŸš€ Super Agent Main Interface/evidence/performance/**
          ğŸš€ Super Agent Main Interface/performance_results/**
          ğŸš€ Super Agent Main Interface/logs/performance/**
        retention-days: 30

  # ==================== Chaoså·¥ç¨‹æµ‹è¯• ====================
  chaos-tests:
    name: Chaoså·¥ç¨‹æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio httpx
        pip install -r "ğŸš€ Super Agent Main Interface/requirements.txt"
    
    - name: åˆ›å»ºevidenceç›®å½•
      run: |
        mkdir -p "ğŸš€ Super Agent Main Interface/evidence/chaos"
        mkdir -p "ğŸš€ Super Agent Main Interface/evidence/screenshots"
    
    - name: å¯åŠ¨æµ‹è¯•æœåŠ¡ï¼ˆæ¨¡æ‹Ÿï¼‰
      working-directory: "ğŸš€ Super Agent Main Interface"
      run: |
        # è¿™é‡Œå¯ä»¥å¯åŠ¨å®é™…æœåŠ¡æˆ–ä½¿ç”¨mock
        echo "å¯åŠ¨æµ‹è¯•æœåŠ¡..."
      continue-on-error: true
    
    - name: è¿è¡ŒChaosæµ‹è¯•
      working-directory: "ğŸš€ Super Agent Main Interface"
      run: |
        chmod +x scripts/chaos_engineering/run_chaos_tests.sh
        ./scripts/chaos_engineering/run_chaos_tests.sh
      continue-on-error: true
      env:
        BASE_URL: http://localhost:8000
    
    - name: ä¸Šä¼ Chaosæµ‹è¯•è¯æ®
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: chaos-evidence
        path: |
          ğŸš€ Super Agent Main Interface/evidence/chaos/**
        retention-days: 30

  # ==================== æµ‹è¯•æŠ¥å‘Šæ±‡æ€» ====================
  test-report:
    name: æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, chaos-tests]
    if: always()
    
    steps:
    - name: ä¸‹è½½æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v3
    
    - name: åˆ›å»ºevidenceæ±‡æ€»ç›®å½•
      run: |
        mkdir -p evidence/ci_summary
    
    - name: æ±‡æ€»æµ‹è¯•è¯æ®
      run: |
        # æ±‡æ€»æ‰€æœ‰æµ‹è¯•è¯æ®
        echo "æ±‡æ€»æµ‹è¯•è¯æ®..." > evidence/ci_summary/summary.txt
        echo "æ„å»ºID: ${{ github.run_id }}" >> evidence/ci_summary/summary.txt
        echo "æäº¤SHA: ${{ github.sha }}" >> evidence/ci_summary/summary.txt
        echo "åˆ†æ”¯: ${{ github.ref_name }}" >> evidence/ci_summary/summary.txt
        echo "æ—¶é—´: $(date -Iseconds)" >> evidence/ci_summary/summary.txt
    
    - name: ä¸Šä¼ æ±‡æ€»è¯æ®
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ci-evidence-summary
        path: evidence/ci_summary/**
        retention-days: 90
    
    - name: å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: æµ‹è¯•ç»“æœæ±‡æ€»
        path: '**/junit.xml'
        reporter: java-junit
