name: Release - å‘å¸ƒç®¡ç†

on:
  push:
    tags:
      - 'v*'

jobs:
  # ==================== åˆ›å»ºRelease ====================
  create-release:
    name: åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªtag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        
        echo "ä» $PREVIOUS_TAG åˆ° $CURRENT_TAG çš„å˜æ›´:"
        
        if [ -n "$PREVIOUS_TAG" ]; then
          git log $PREVIOUS_TAG..$CURRENT_TAG --pretty=format:"- %s (%h)" > CHANGELOG_TEMP.md
        else
          git log --pretty=format:"- %s (%h)" > CHANGELOG_TEMP.md
        fi
        
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG_TEMP.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»ºRelease
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## ğŸ‰ AI Stack ${{ github.ref }} å‘å¸ƒï¼
          
          ### ğŸ“ å˜æ›´æ—¥å¿—
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ### ğŸ“¦ å®‰è£…æ–¹å¼
          
          **Dockeræ–¹å¼**:
          ```bash
          docker pull aistack/ai-stack:${{ github.ref }}
          docker-compose up -d
          ```
          
          **K8sæ–¹å¼**:
          ```bash
          kubectl apply -f https://raw.githubusercontent.com/your-org/ai-stack/${{ github.ref }}/infra/k8s/
          ```
          
          ### ğŸ“š æ–‡æ¡£
          - [ç”¨æˆ·æ‰‹å†Œ](https://github.com/your-org/ai-stack/blob/${{ github.ref }}/USER_MANUAL.md)
          - [APIæ–‡æ¡£](https://github.com/your-org/ai-stack/blob/${{ github.ref }}/API_ENDPOINTS.md)
          - [éƒ¨ç½²æŒ‡å—](https://github.com/your-org/ai-stack/blob/${{ github.ref }}/QUICK_START.md)
        draft: false
        prerelease: false
    
  # ==================== å‘å¸ƒåˆ°PyPI ====================
  publish-pypi:
    name: å‘å¸ƒåˆ°PyPI
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…æ„å»ºå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: æ„å»ºåŒ…
      run: |
        python -m build
    
    - name: å‘å¸ƒåˆ°PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*
    
  # ==================== æ›´æ–°æ–‡æ¡£ ====================
  update-docs:
    name: æ›´æ–°æ–‡æ¡£ç«™ç‚¹
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…MkDocs
      run: |
        pip install mkdocs mkdocs-material
    
    - name: æ„å»ºæ–‡æ¡£
      run: |
        mkdocs build
    
    - name: éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site

