<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>任务详情</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px 12px; margin: 8px 0; }
        .kv .k { color: #aaa; }
        .section { margin: 12px 0; }
        .log { background: #0f0f0f; border: 1px solid #222; padding: 8px; border-radius: 6px; }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 999px; font-size: 12px; margin-right: 6px; background:#222; }
        .ok { color: #7CFC00; } .err { color: #ff6b6b; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 6px 8px; border-bottom: 1px solid #333; text-align: left; }
        .small { color:#aaa; font-size:12px; }
    </style>
    </head>
<body>
    <div class="app-container" style="padding:16px;">
        <h2>任务详情</h2>
        <div id="basic" class="section"></div>
        <div id="deps" class="section"></div>
        <div id="steps" class="section"></div>
        <div id="exec" class="section"></div>
        <div id="retro" class="section"></div>
        <div id="push-steps" class="section" style="display:none;">
            <h3>推送步骤数组到编排器任务</h3>
            <div class="small">说明：可将规划任务的 steps 或自行编辑的 steps 数组写入到当前编排器任务的元数据中（自动更新 total_steps）。</div>
            <div style="margin:8px 0;">
                <button id="btn-import-planning" class="action-btn-small">从规划任务导入步骤</button>
                <span class="small">（输入规划任务ID后，将读取其 steps 并填入下方）</span>
            </div>
            <textarea id="push-steps-text" placeholder='在此粘贴步骤数组（JSON），如：[{"name":"步骤A","estimated_duration":10},{"name":"步骤B"}]' style="width:100%;height:20vh;font-family:monospace;"></textarea>
            <div style="margin-top:8px;display:flex;gap:8px;">
                <button id="btn-push-steps" class="action-btn-small">推送到当前编排器任务</button>
                <button id="btn-reload-task" class="action-btn-small">刷新当前详情</button>
            </div>
            <div id="push-steps-tip" class="small" style="margin-top:6px;color:#aaa;"></div>
        </div>
    </div>
    <script>
        const API = '/api/super-agent';
        const url = new URL(location.href);
        const oid = url.searchParams.get('oid'); // orchestrator task id (如 task_xxx)
        const pid = url.searchParams.get('pid'); // planning task id (数字)
        const anyId = url.searchParams.get('id'); // 自动识别：task_ 前缀→orchestrator，否则当作数字planning
        let mode = null, id = null;
        if (oid) { mode = 'orchestrator'; id = oid; }
        else if (pid) { mode = 'planning'; id = parseInt(pid, 10); }
        else if (anyId) { if (String(anyId).startsWith('task_')) { mode='orchestrator'; id = anyId; } else { mode='planning'; id=parseInt(anyId,10);} }
        else { alert('缺少参数：?id= 或 ?oid= / ?pid='); }

        function el(tag, cls, text){ const e=document.createElement(tag); if(cls) e.className=cls; if(text!==undefined) e.textContent=text; return e; }
        function renderKV(target, kvs){ const wrap = document.getElementById(target); wrap.innerHTML=''; const grid = el('div','kv'); kvs.forEach(([k,v])=>{ grid.appendChild(el('div','k',k)); grid.appendChild(el('div',null,String(v??'')));}); wrap.appendChild(grid);}
        function renderDeps(deps){ const wrap=document.getElementById('deps'); wrap.innerHTML='<h3>依赖</h3>'; if(!deps||deps.length===0){ wrap.appendChild(el('div','small','无')); return;} const ul=el('ul'); deps.forEach(d=>{ const li=el('li'); li.textContent=String(d); ul.appendChild(li);}); wrap.appendChild(ul);}
        function renderSteps(steps){ const wrap=document.getElementById('steps'); wrap.innerHTML='<h3>步骤</h3>'; if(!steps||steps.length===0){ wrap.appendChild(el('div','small','无')); return;} const table=document.createElement('table'); table.innerHTML='<thead><tr><th>#</th><th>名称</th><th>预计时长</th><th>属性</th></tr></thead>'; const tb=el('tbody'); steps.forEach((s,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${s.name||s.description||''}</td><td>${s.estimated_duration??s.duration??''}</td><td class="small">${s.retries?('retries='+s.retries+' '):''}${s.retry_backoff_sec?('backoff='+s.retry_backoff_sec+'s'):''}</td>`; tb.appendChild(tr);}); table.appendChild(tb); wrap.appendChild(table);}
        function renderExecLog(log){ const wrap=document.getElementById('exec'); wrap.innerHTML='<h3>执行日志</h3>'; if(!log||log.length===0){ wrap.appendChild(el('div','small','暂无执行日志')); return;} const box=el('div','log'); log.forEach(item=>{ const line=el('div'); const ok=item.success; line.innerHTML = `<span class="${ok?'ok':'err'}">${ok?'✔':'✖'}</span> [${item.ts||''}] ${item.step||item.step_name||''} (attempt ${item.attempt||1}) - ${ok?(item.result||'成功'):(item.error||'失败')}`; box.appendChild(line);}); wrap.appendChild(box);}
        function renderRetro(retro){ const wrap=document.getElementById('retro'); wrap.innerHTML='<h3>复盘</h3>'; if(!retro){ wrap.appendChild(el('div','small','未复盘')); return;} const box=el('div','log'); box.appendChild(el('div',null,`结果：${retro.success ? '成功' : '失败'}`)); if (retro.summary) box.appendChild(el('div',null,'总结：'+retro.summary)); if (retro.lessons && retro.lessons.length) box.appendChild(el('div',null,'经验：'+retro.lessons.join('，'))); box.appendChild(el('div','small','时间：'+(retro.retrospected_at||''))); wrap.appendChild(box);}

        async function load(){
            try{
                let data=null;
                if (mode==='orchestrator'){
                    const r = await fetch(`${API}/tasks/${encodeURIComponent(id)}`);
                    if (!r.ok) throw new Error('编排器任务不存在');
                    const j = await r.json(); data = j.task || {};
                    renderKV('basic', [
                        ['任务ID', data.task_id], ['标题', data.title], ['状态', data.status],
                        ['优先级', data.priority], ['来源', data.source],
                        ['创建时间', data.created_at], ['更新时间', data.updated_at],
                        ['total_steps（元数据）', (data.metadata && data.metadata.total_steps) || '—']
                    ]);
                    renderDeps(data.dependencies||[]);
                    // Orchestrator侧可能有 execution_history
                    renderSteps([]);
                    renderExecLog((data.metadata && data.metadata.execution_history) || []);
                    // 无复盘位
                    renderRetro(null);
                    // 显示推送步骤UI
                    document.getElementById('push-steps').style.display = '';
                    const tip = document.getElementById('push-steps-tip');
                    if (tip) tip.textContent = '建议先“从规划任务导入步骤”，或直接粘贴steps数组后点击“推送”。';
                } else {
                    // planning 任务
                    const r = await fetch(`${API}/planning/tasks/${encodeURIComponent(id)}`);
                    if (!r.ok) throw new Error('任务不存在');
                    const j = await r.json(); data = j.task || {};
                    renderKV('basic', [
                        ['任务ID', data.id], ['标题', data.title], ['状态', data.status],
                        ['优先级', data.priority], ['来源', data.source],
                        ['创建时间', data.created_at], ['开始时间', data.started_at||''], ['完成时间', data.completed_at||''],
                        ['进度', (data.progress!=null?data.progress+'%':'')]
                    ]);
                    renderDeps(data.dependencies||[]);
                    renderSteps(data.steps||[]);
                    renderExecLog(data.execution_log||[]);
                    renderRetro(data.retrospect||null);
                }
            }catch(e){
                document.getElementById('basic').innerHTML = `<div class="log err">加载失败：${e.message}</div>`;
            }
        }
        // 推送步骤逻辑
        async function importFromPlanning() {
            try {
                const pid = prompt('输入规划任务ID（数字）：', '');
                if (!pid) return;
                const r = await fetch(`${API}/planning/tasks/${encodeURIComponent(pid)}`);
                const j = await r.json();
                if (!r.ok || !j.task) { alert('未找到该规划任务'); return; }
                const steps = j.task.steps || [];
                document.getElementById('push-steps-text').value = JSON.stringify(steps, null, 2);
            } catch (e) {
                alert('导入失败：' + e.message);
            }
        }
        async function pushStepsToOrchestrator() {
            try {
                const txt = document.getElementById('push-steps-text').value.trim();
                if (!txt) { alert('请先填写步骤数组（JSON）'); return; }
                let steps;
                try { steps = JSON.parse(txt); } catch(e) { alert('JSON解析失败'); return; }
                if (!Array.isArray(steps)) { alert('必须是数组'); return; }
                const body = { updates: { steps } };
                const r = await fetch(`${API}/tasks/${encodeURIComponent(id)}/metadata`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const j = await r.json();
                if (!r.ok) { alert('推送失败：' + (j.detail || '未知错误')); return; }
                alert('✅ 已推送步骤并更新 total_steps=' + ((j.task && j.task.metadata && j.task.metadata.total_steps) || '未知'));
                load();
            } catch (e) {
                alert('推送异常：' + e.message);
            }
        }
        function bindPushUI(){
            const btnImport = document.getElementById('btn-import-planning');
            const btnPush = document.getElementById('btn-push-steps');
            const btnReload = document.getElementById('btn-reload-task');
            if (btnImport) btnImport.onclick = importFromPlanning;
            if (btnPush) btnPush.onclick = pushStepsToOrchestrator;
            if (btnReload) btnReload.onclick = load;
        }
        bindPushUI();
        load();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>任务详情</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        .kv { display: grid; grid-template-columns: 120px 1fr; gap: 6px 12px; margin: 8px 0; }
        .kv div { padding: 4px 0; }
        .log-item { border-left: 3px solid #4c8bf5; padding: 8px 12px; margin: 8px 0; background: #101010; }
        .log-meta { color: #aaa; font-size: 12px; }
        .section { margin-top: 16px; }
        .badge { display:inline-block; padding:2px 6px; border-radius: 4px; background:#1e1e1e; margin-left:8px; font-size:12px; color:#bbb; }
        .success { color:#26a269; }
        .error { color:#e5534b; }
        pre { background:#0d0d0d; color:#e6e6e6; padding:10px; overflow:auto; }
    </style>
</head>
<body>
    <div class="app-container" style="padding:16px;">
        <h2>任务详情 <span id="taskTitle"></span></h2>
        <div class="kv">
            <div>任务ID</div><div id="taskId"></div>
            <div>状态</div><div id="taskStatus"></div>
            <div>优先级</div><div id="taskPriority"></div>
            <div>来源</div><div id="taskSource"></div>
            <div>创建时间</div><div id="taskCreated"></div>
            <div>开始时间</div><div id="taskStarted"></div>
            <div>完成时间</div><div id="taskCompleted"></div>
            <div>进度</div><div id="taskProgress"></div>
        </div>

        <div class="section">
            <h3>步骤与执行日志 <span class="badge" id="logCount">0</span></h3>
            <div id="log"></div>
        </div>

        <div class="section">
            <h3>复盘报告</h3>
            <div id="retro">
                <div class="kv">
                    <div>是否成功</div><div id="retroSuccess">-</div>
                    <div>总结</div><div id="retroSummary">-</div>
                    <div>经验要点</div><div id="retroLessons">-</div>
                    <div>指标</div><div><pre id="retroMetrics">-</pre></div>
                    <div>复盘时间</div><div id="retroTs">-</div>
                </div>
            </div>
        </div>

        <div class="section">
            <button id="btnExec">执行任务</button>
            <button id="btnRetro">填写复盘</button>
        </div>
    </div>
    <script>
        const API = '/api/super-agent';
        const params = new URLSearchParams(location.search);
        const idRaw = params.get('id');
        const id = idRaw ? parseInt(idRaw, 10) : NaN;

        function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text ?? ''; }
        async function load() {
            if (!Number.isFinite(id)) { alert('缺少任务ID'); return; }
            // 规划任务详情
            const r = await fetch(`${API}/planning/tasks/${id}`);
            const data = await r.json();
            if (!data.task) { alert('未找到任务'); return; }
            const t = data.task;
            setText('taskTitle', t.title || '');
            setText('taskId', String(t.id));
            setText('taskStatus', t.status || '');
            setText('taskPriority', t.priority || '');
            setText('taskSource', t.source || 'memo');
            setText('taskCreated', t.created_at || '');
            setText('taskStarted', t.started_at || '-');
            setText('taskCompleted', t.completed_at || '-');
            setText('taskProgress', (t.progress ?? 0) + '%');
            // 日志
            const log = document.getElementById('log');
            log.innerHTML = '';
            const logs = (t.execution_log || []).slice().reverse();
            document.getElementById('logCount').textContent = String(logs.length);
            if (logs.length === 0) {
                log.innerHTML = '<div class="log-item">暂无执行日志</div>';
            } else {
                logs.forEach(l => {
                    const div = document.createElement('div');
                    div.className = 'log-item';
                    const ok = l.success ? 'success' : 'error';
                    div.innerHTML = `
                        <div><strong>${l.step || ''}</strong> <span class="${ok}">(${l.success ? '成功' : '失败'})</span></div>
                        <div class="log-meta">尝试：${l.attempt || 1} · 时间：${l.ts || ''}</div>
                        <div>${l.result || l.error || ''}</div>
                    `;
                    log.appendChild(div);
                });
            }
            // 复盘
            const retro = t.retrospect || {};
            setText('retroSuccess', retro.success === true ? '是' : (retro.success === false ? '否' : '-'));
            setText('retroSummary', retro.summary || '-');
            setText('retroLessons', (retro.lessons || []).join('，') || '-');
            document.getElementById('retroMetrics').textContent = JSON.stringify(retro.metrics || {}, null, 2);
            setText('retroTs', retro.retrospected_at || '-');
        }
        document.getElementById('btnExec').onclick = async () => {
            if (!Number.isFinite(id)) return;
            const r = await fetch(`${API}/tasks/${id}/execute`, { method: 'POST' });
            const data = await r.json();
            if (r.ok && data.success) { alert('已执行'); load(); } else { alert('执行失败：' + (data.detail || data.error || '未知')); }
        };
        document.getElementById('btnRetro').onclick = async () => {
            if (!Number.isFinite(id)) return;
            const success = confirm('任务是否成功？确定=成功，取消=失败');
            const summary = prompt('请输入复盘总结：', '') || '';
            const lessonsRaw = prompt('请输入经验要点（用中文逗号分隔）：', '') || '';
            const lessons = lessonsRaw ? lessonsRaw.split('，').map(s => s.trim()).filter(Boolean) : [];
            const r = await fetch(`${API}/tasks/${id}/retrospect`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ success, summary, lessons, metrics: {} })
            });
            const data = await r.json();
            if (r.ok && data.success) { alert('已保存复盘'); load(); } else { alert('复盘失败：' + (data.detail || '未知')); }
        };
        load();
    </script>
</body>
</html>

