<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资源自动调节器 - AI-STACK 智能资源管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }
        
        .status-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            border-radius: 10px;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .status-healthy { border-left: 4px solid var(--success-color); }
        .status-warning { border-left: 4px solid var(--warning-color); }
        .status-critical { border-left: 4px solid var(--danger-color); }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .progress-custom {
            height: 8px;
            border-radius: 4px;
        }
        
        .issue-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .suggestion-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .refresh-btn {
            background-color: var(--primary-color);
            border: none;
        }
        
        .auto-refresh-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .auto-refresh-active {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .config-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-cpu-fill text-primary me-2"></i>
                        资源自动调节器
                        <span class="badge bg-success ms-2">AI-STACK 优化版</span>
                    </h1>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="auto-refresh-indicator" id="autoRefreshIndicator"></span>
                            <small class="text-muted">自动刷新</small>
                        </div>
                        <button class="btn btn-primary refresh-btn" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                </div>
                <p class="text-muted">智能资源监控与自动调节系统，基于AI-STACK架构优化</p>
            </div>
        </div>

        <!-- 系统状态卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card status-healthy">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-label">CPU使用率</div>
                                <div class="metric-value" id="cpuUsage">--</div>
                            </div>
                            <i class="bi bi-cpu text-primary" style="font-size: 2rem;"></i>
                        </div>
                        <div class="progress progress-custom mt-2">
                            <div id="cpuProgress" class="progress-bar bg-primary" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-healthy">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-label">内存使用率</div>
                                <div class="metric-value" id="memoryUsage">--</div>
                            </div>
                            <i class="bi bi-memory text-info" style="font-size: 2rem;"></i>
                        </div>
                        <div class="progress progress-custom mt-2">
                            <div id="memoryProgress" class="progress-bar bg-info" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-healthy">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-label">磁盘使用率</div>
                                <div class="metric-value" id="diskUsage">--</div>
                            </div>
                            <i class="bi bi-hdd text-warning" style="font-size: 2rem;"></i>
                        </div>
                        <div class="progress progress-custom mt-2">
                            <div id="diskProgress" class="progress-bar bg-warning" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-healthy">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-label">系统健康度</div>
                                <div class="metric-value" id="systemHealth">--</div>
                            </div>
                            <i class="bi bi-heart-pulse text-success" style="font-size: 2rem;"></i>
                        </div>
                        <div class="mt-2">
                            <span class="badge" id="healthBadge">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：问题列表和调节建议 -->
            <div class="col-lg-8">
                <!-- 问题列表 -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            检测到的问题
                        </h5>
                        <span class="badge bg-primary" id="issuesCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="issuesList" class="issues-container">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                                <p class="mt-2">暂无资源问题</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 调节建议 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-lightbulb text-info me-2"></i>
                            调节建议
                        </h5>
                        <span class="badge bg-info" id="suggestionsCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="suggestionsList" class="suggestions-container">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-emoji-smile text-info" style="font-size: 2rem;"></i>
                                <p class="mt-2">暂无调节建议</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：配置和统计 -->
            <div class="col-lg-4">
                <!-- 配置面板 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-gear text-secondary me-2"></i>
                            配置设置
                        </h5>
                    </div>
                    <div class="card-body config-panel">
                        <div class="mb-3">
                            <label class="form-label">自动调节</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoAdjustToggle" onchange="toggleAutoAdjust()">
                                <label class="form-check-label" for="autoAdjustToggle">启用自动调节</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">监控间隔（秒）</label>
                            <input type="number" class="form-control" id="monitoringInterval" value="5" min="1" max="60">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">自动调节阈值</label>
                            <select class="form-select" id="adjustThreshold">
                                <option value="low">低（仅关键问题）</option>
                                <option value="medium" selected>中（警告及以上）</option>
                                <option value="high">高（所有问题）</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="updateConfiguration()">
                            <i class="bi bi-check-lg"></i> 应用配置
                        </button>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up text-success me-2"></i>
                            统计信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="metric-value text-primary" id="totalIssues">0</div>
                                <div class="metric-label">总问题数</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-value text-success" id="resolvedIssues">0</div>
                                <div class="metric-label">已解决</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-value text-info" id="totalAdjustments">0</div>
                                <div class="metric-label">调节次数</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-value text-warning" id="cacheHitRate">0%</div>
                                <div class="metric-label">缓存命中率</div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <canvas id="issuesChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let autoRefreshInterval = null;
        let issuesChart = null;

        // API基础URL
        const API_BASE = '/api/resource-adjuster';

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            startAutoRefresh();
            initializeChart();
        });

        // 加载初始数据
        async function loadInitialData() {
            try {
                await Promise.all([
                    loadStatus(),
                    loadIssues(),
                    loadSuggestions(),
                    loadStatistics()
                ]);
            } catch (error) {
                console.error('加载数据失败:', error);
                showError('数据加载失败');
            }
        }

        // 加载系统状态
        async function loadStatus() {
            const response = await fetch(`${API_BASE}/status`);
            const result = await response.json();
            
            if (result.status === 'success') {
                updateStatusDisplay(result.data);
            }
        }

        // 加载问题列表
        async function loadIssues() {
            const response = await fetch(`${API_BASE}/issues?limit=10`);
            const result = await response.json();
            
            if (result.status === 'success') {
                updateIssuesDisplay(result.data);
            }
        }

        // 加载调节建议
        async function loadSuggestions() {
            // 这里简化实现，实际应该从API获取
            updateSuggestionsDisplay([]);
        }

        // 加载统计信息
        async function loadStatistics() {
            const response = await fetch(`${API_BASE}/statistics`);
            const result = await response.json();
            
            if (result.status === 'success') {
                updateStatisticsDisplay(result.data);
            }
        }

        // 更新状态显示
        function updateStatusDisplay(data) {
            // 更新CPU使用率
            const cpuUsage = data.statistics?.monitoring_metrics?.cpu_usage || 0;
            document.getElementById('cpuUsage').textContent = `${cpuUsage}%`;
            document.getElementById('cpuProgress').style.width = `${cpuUsage}%`;
            
            // 更新内存使用率
            const memoryUsage = data.statistics?.monitoring_metrics?.memory_usage || 0;
            document.getElementById('memoryUsage').textContent = `${memoryUsage}%`;
            document.getElementById('memoryProgress').style.width = `${memoryUsage}%`;
            
            // 更新磁盘使用率
            const diskUsage = data.statistics?.monitoring_metrics?.disk_usage || 0;
            document.getElementById('diskUsage').textContent = `${diskUsage}%`;
            document.getElementById('diskProgress').style.width = `${diskUsage}%`;
            
            // 更新系统健康度
            const systemHealth = data.system_health || 'healthy';
            document.getElementById('systemHealth').textContent = 
                systemHealth === 'healthy' ? '健康' : systemHealth === 'warning' ? '警告' : '危险';
            
            const healthBadge = document.getElementById('healthBadge');
            healthBadge.textContent = systemHealth === 'healthy' ? '健康' : systemHealth === 'warning' ? '警告' : '危险';
            healthBadge.className = `badge bg-${systemHealth === 'healthy' ? 'success' : systemHealth === 'warning' ? 'warning' : 'danger'}`;
        }

        // 更新问题显示
        function updateIssuesDisplay(data) {
            const issuesList = document.getElementById('issuesList');
            const issuesCount = document.getElementById('issuesCount');
            
            issuesCount.textContent = data.total_issues || 0;
            
            if (!data.issues || data.issues.length === 0) {
                issuesList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                        <p class="mt-2">暂无资源问题</p>
                    </div>
                `;
                return;
            }
            
            issuesList.innerHTML = data.issues.map(issue => `
                <div class="issue-card p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-${getSeverityColor(issue.severity)} me-2">${issue.severity}</span>
                                <small class="text-muted">${formatDate(issue.detected_at)}</small>
                            </div>
                            <h6 class="mb-1">${issue.description}</h6>
                            <small class="text-muted">类型: ${issue.type} | 当前值: ${issue.current_value}%</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="analyzeIssue('${issue.id}')">
                            分析
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 更新建议显示
        function updateSuggestionsDisplay(suggestions) {
            const suggestionsList = document.getElementById('suggestionsList');
            const suggestionsCount = document.getElementById('suggestionsCount');
            
            suggestionsCount.textContent = suggestions.length;
            
            if (suggestions.length === 0) {
                suggestionsList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-emoji-smile text-info" style="font-size: 2rem;"></i>
                        <p class="mt-2">暂无调节建议</p>
                    </div>
                `;
                return;
            }
            
            suggestionsList.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${suggestion.description}</h6>
                            <small class="text-muted">预计改善: ${suggestion.estimated_improvement}%</small>
                        </div>
                        <button class="btn btn-sm btn-success" onclick="executeSuggestion('${suggestion.id}')">
                            执行
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 更新统计显示
        function updateStatisticsDisplay(data) {
            document.getElementById('totalIssues').textContent = data.total_issues_detected || 0;
            document.getElementById('resolvedIssues').textContent = data.total_issues_resolved || 0;
            document.getElementById('totalAdjustments').textContent = data.total_adjustments_executed || 0;
            document.getElementById('cacheHitRate').textContent = `${data.cache_hit_rate || 0}%`;
            
            updateChart(data);
        }

        // 初始化图表
        function initializeChart() {
            const ctx = document.getElementById('issuesChart').getContext('2d');
            issuesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['CPU问题', '内存问题', '磁盘问题'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#3498db', '#2ecc71', '#f39c12']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 更新图表
        function updateChart(data) {
            if (issuesChart) {
                issuesChart.data.datasets[0].data = [
                    data.issue_distribution?.cpu || 0,
                    data.issue_distribution?.memory || 0,
                    data.issue_distribution?.disk || 0
                ];
                issuesChart.update();
            }
        }

        // 分析问题
        async function analyzeIssue(issueId) {
            try {
                const response = await fetch(`${API_BASE}/issues/${issueId}/analyze`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSuccess('问题分析完成');
                    updateSuggestionsDisplay(result.data.suggestions);
                }
            } catch (error) {
                console.error('分析问题失败:', error);
                showError('分析失败');
            }
        }

        // 执行建议
        async function executeSuggestion(suggestionId) {
            try {
                const response = await fetch(`${API_BASE}/suggestions/${suggestionId}/execute?approved=true`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSuccess('调节执行完成');
                    refreshData();
                }
            } catch (error) {
                console.error('执行建议失败:', error);
                showError('执行失败');
            }
        }

        // 更新配置
        async function updateConfiguration() {
            const configUpdates = {
                'monitoring.enable_auto_adjust': document.getElementById('autoAdjustToggle').checked,
                'monitoring.interval': parseInt(document.getElementById('monitoringInterval').value),
                'monitoring.auto_adjust_threshold': document.getElementById('adjustThreshold').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/configuration`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configUpdates)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSuccess('配置更新成功');
                }
            } catch (error) {
                console.error('更新配置失败:', error);
                showError('配置更新失败');
            }
        }

        // 切换自动调节
        function toggleAutoAdjust() {
            const isEnabled = document.getElementById('autoAdjustToggle').checked;
            if (isEnabled) {
                showInfo('自动调节已启用');
            } else {
                showWarning('自动调节已禁用');
            }
        }

        // 刷新数据
        function refreshData() {
            loadInitialData();
            showInfo('数据已刷新');
        }

        // 启动自动刷新
        function startAutoRefresh() {
            const indicator = document.getElementById('autoRefreshIndicator');
            indicator.classList.add('auto-refresh-active');
            
            autoRefreshInterval = setInterval(() => {
                loadStatus();
            }, 5000); // 5秒刷新一次
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                
                const indicator = document.getElementById('autoRefreshIndicator');
                indicator.classList.remove('auto-refresh-active');
            }
        }

        // 工具函数
        function getSeverityColor(severity) {
            switch (severity) {
                case 'critical': return 'danger';
                case 'warning': return 'warning';
                default: return 'secondary';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '--';
            return new Date(dateString).toLocaleString('zh-CN');
        }

        // 消息提示函数
        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'danger');
        }

        function showWarning(message) {
            showAlert(message, 'warning');
        }

        function showInfo(message) {
            showAlert(message, 'info');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 添加到页面顶部
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 页面卸载时清理
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>