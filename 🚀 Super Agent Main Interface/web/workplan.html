<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å·¥ä½œè®¡åˆ’ç®¡ç† - AI-STACK</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/confirmation.css">
    <style>
        .workplan-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .workplan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .workplan-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .workplan-actions {
            display: flex;
            gap: 12px;
        }
        
        .workplan-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .workplan-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .filter-group select,
        .filter-group input {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
        }
        
        .plans-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .plan-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            transition: all 0.2s;
        }
        
        .plan-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .plan-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .plan-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .plan-actions {
            display: flex;
            gap: 8px;
        }
        
        .plan-status {
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-executing {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .plan-tasks {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }
        
        .task-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .task-title {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .task-duration {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-color-hover);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background: #dc3545;
        }
        
        .plan-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .plan-dialog.show {
            display: flex;
        }
        
        .plan-dialog-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dialog-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .dialog-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <div class="workplan-container">
        <div class="workplan-header">
            <h2>ğŸ“‹ æ™ºèƒ½å·¥ä½œè®¡åˆ’ç®¡ç†</h2>
            <div class="workplan-actions">
                <button class="btn btn-primary" onclick="openCreatePlanDialog()">â• æ–°å»ºè®¡åˆ’</button>
                <button class="btn btn-secondary" onclick="refreshPlans()">ğŸ”„ åˆ·æ–°</button>
            </div>
        </div>
        
        <div class="workplan-stats">
            <div class="stat-card">
                <div class="stat-label">æ€»è®¡åˆ’æ•°</div>
                <div class="stat-value" id="total-plans">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¾…ç¡®è®¤</div>
                <div class="stat-value" id="pending-plans">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ‰§è¡Œä¸­</div>
                <div class="stat-value" id="executing-plans">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å·²å®Œæˆ</div>
                <div class="stat-value" id="completed-plans">0</div>
            </div>
        </div>
        
        <div class="workplan-filters">
            <div class="filter-group">
                <label>çŠ¶æ€:</label>
                <select id="status-filter" onchange="filterPlans()">
                    <option value="">å…¨éƒ¨</option>
                    <option value="pending">å¾…ç¡®è®¤</option>
                    <option value="confirmed">å·²ç¡®è®¤</option>
                    <option value="executing">æ‰§è¡Œä¸­</option>
                    <option value="completed">å·²å®Œæˆ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>åˆ†ç±»:</label>
                <select id="category-filter" onchange="filterPlans()">
                    <option value="">å…¨éƒ¨</option>
                    <option value="work">å·¥ä½œ</option>
                    <option value="personal">ä¸ªäºº</option>
                    <option value="project">é¡¹ç›®</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
            <div class="filter-group">
                <label>æœç´¢:</label>
                <input type="text" id="search-input" placeholder="æœç´¢è®¡åˆ’..." oninput="filterPlans()">
            </div>
        </div>
        
        <div class="plans-list" id="plans-list">
            <!-- è®¡åˆ’åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- åˆ›å»º/ç¼–è¾‘è®¡åˆ’å¯¹è¯æ¡† -->
    <div class="plan-dialog" id="plan-dialog">
        <div class="plan-dialog-content">
            <div class="dialog-header">
                <h3 id="dialog-title">æ–°å»ºå·¥ä½œè®¡åˆ’</h3>
                <button class="dialog-close" onclick="closePlanDialog()">Ã—</button>
            </div>
            <form id="plan-form" onsubmit="savePlan(event)">
                <input type="hidden" id="plan-id" value="">
                <div class="form-group">
                    <label>è®¡åˆ’æ ‡é¢˜ *</label>
                    <input type="text" id="plan-title" required>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="plan-category">
                        <option value="work">å·¥ä½œ</option>
                        <option value="personal">ä¸ªäºº</option>
                        <option value="project">é¡¹ç›®</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="plan-description"></textarea>
                </div>
                <div class="form-group">
                    <label>ä¼˜å…ˆçº§</label>
                    <select id="plan-priority">
                        <option value="low">ä½</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="high">é«˜</option>
                        <option value="urgent">ç´§æ€¥</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePlanDialog()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="js/modal.js"></script>
    <script src="js/confirmation.js"></script>
    <script>
        const API_BASE = '/api/super-agent';
        let plans = [];
        let filteredPlans = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadPlans();
        });
        
        // åŠ è½½è®¡åˆ’åˆ—è¡¨
        async function loadPlans() {
            try {
                const response = await fetch(`${API_BASE}/task-planning/plans`);
                const data = await response.json();
                plans = data.plans || [];
                filteredPlans = plans;
                renderPlans();
                updateStats();
            } catch (error) {
                console.error('åŠ è½½è®¡åˆ’å¤±è´¥:', error);
                if (window.modalSystem) {
                    window.modalSystem.show({
                        type: 'error',
                        title: 'åŠ è½½å¤±è´¥',
                        message: 'æ— æ³•åŠ è½½å·¥ä½œè®¡åˆ’åˆ—è¡¨',
                        duration: 3000
                    });
                }
            }
        }
        
        // æ¸²æŸ“è®¡åˆ’åˆ—è¡¨
        function renderPlans() {
            const plansList = document.getElementById('plans-list');
            if (filteredPlans.length === 0) {
                plansList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— å·¥ä½œè®¡åˆ’</div>';
                return;
            }
            
            plansList.innerHTML = filteredPlans.map(plan => `
                <div class="plan-card">
                    <div class="plan-header">
                        <div>
                            <div class="plan-title">${plan.title || 'æœªå‘½åè®¡åˆ’'}</div>
                            <div class="plan-meta">
                                <span>ğŸ“… ${plan.created_at ? new Date(plan.created_at).toLocaleDateString() : 'æœªçŸ¥æ—¥æœŸ'}</span>
                                <span>ğŸ“‹ ${plan.total_tasks || 0} ä¸ªä»»åŠ¡</span>
                                <span>â±ï¸ ${formatDuration(plan.total_duration_minutes || 0)}</span>
                            </div>
                        </div>
                        <div class="plan-actions">
                            <span class="plan-status status-${plan.status || 'pending'}">${getStatusText(plan.status)}</span>
                            ${plan.status === 'pending' ? `
                                <button class="btn btn-primary" onclick="confirmPlan(${plan.id})">ç¡®è®¤</button>
                            ` : ''}
                            <button class="btn btn-secondary" onclick="editPlan(${plan.id})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deletePlan(${plan.id})">åˆ é™¤</button>
                        </div>
                    </div>
                    ${plan.tasks && plan.tasks.length > 0 ? `
                        <div class="plan-tasks">
                            ${plan.tasks.slice(0, 5).map(task => `
                                <div class="task-item">
                                    <input type="checkbox" class="task-checkbox" ${task.status === 'completed' ? 'checked' : ''} 
                                           onchange="toggleTask(${plan.id}, ${task.id || task.step_number})">
                                    <span class="task-title">${task.title || task.description || 'æœªå‘½åä»»åŠ¡'}</span>
                                    ${task.estimated_duration ? `<span class="task-duration">${task.estimated_duration}åˆ†é’Ÿ</span>` : ''}
                                </div>
                            `).join('')}
                            ${plan.tasks.length > 5 ? `<div style="text-align: center; padding: 8px; color: var(--text-secondary);">è¿˜æœ‰ ${plan.tasks.length - 5} ä¸ªä»»åŠ¡...</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('total-plans').textContent = plans.length;
            document.getElementById('pending-plans').textContent = plans.filter(p => p.status === 'pending').length;
            document.getElementById('executing-plans').textContent = plans.filter(p => p.status === 'executing').length;
            document.getElementById('completed-plans').textContent = plans.filter(p => p.status === 'completed').length;
        }
        
        // ç­›é€‰è®¡åˆ’
        function filterPlans() {
            const statusFilter = document.getElementById('status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            
            filteredPlans = plans.filter(plan => {
                const matchStatus = !statusFilter || plan.status === statusFilter;
                const matchCategory = !categoryFilter || plan.category === categoryFilter;
                const matchSearch = !searchInput || (plan.title || '').toLowerCase().includes(searchInput);
                return matchStatus && matchCategory && matchSearch;
            });
            
            renderPlans();
        }
        
        // æ‰“å¼€åˆ›å»ºè®¡åˆ’å¯¹è¯æ¡†
        function openCreatePlanDialog() {
            document.getElementById('dialog-title').textContent = 'æ–°å»ºå·¥ä½œè®¡åˆ’';
            document.getElementById('plan-id').value = '';
            document.getElementById('plan-form').reset();
            document.getElementById('plan-dialog').classList.add('show');
        }
        
        // å…³é—­è®¡åˆ’å¯¹è¯æ¡†
        function closePlanDialog() {
            document.getElementById('plan-dialog').classList.remove('show');
        }
        
        // ç¼–è¾‘è®¡åˆ’
        function editPlan(planId) {
            const plan = plans.find(p => p.id === planId);
            if (!plan) return;
            
            document.getElementById('dialog-title').textContent = 'ç¼–è¾‘å·¥ä½œè®¡åˆ’';
            document.getElementById('plan-id').value = planId;
            document.getElementById('plan-title').value = plan.title || '';
            document.getElementById('plan-description').value = plan.description || '';
            document.getElementById('plan-category').value = plan.category || 'work';
            document.getElementById('plan-priority').value = plan.priority || 'medium';
            document.getElementById('plan-dialog').classList.add('show');
        }
        
        // ä¿å­˜è®¡åˆ’
        async function savePlan(event) {
            event.preventDefault();
            
            const planId = document.getElementById('plan-id').value;
            const planData = {
                title: document.getElementById('plan-title').value,
                description: document.getElementById('plan-description').value,
                category: document.getElementById('plan-category').value,
                priority: document.getElementById('plan-priority').value
            };
            
            try {
                if (planId) {
                    // æ›´æ–°è®¡åˆ’
                    const response = await fetch(`${API_BASE}/task-planning/plans/${planId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(planData)
                    });
                    
                    if (!response.ok) throw new Error('æ›´æ–°å¤±è´¥');
                } else {
                    // åˆ›å»ºè®¡åˆ’
                    const response = await fetch(`${API_BASE}/task-planning/plans`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(planData)
                    });
                    
                    if (!response.ok) throw new Error('åˆ›å»ºå¤±è´¥');
                }
                
                closePlanDialog();
                await loadPlans();
                
                if (window.modalSystem) {
                    window.modalSystem.show({
                        type: 'success',
                        title: 'æˆåŠŸ',
                        message: planId ? 'è®¡åˆ’å·²æ›´æ–°' : 'è®¡åˆ’å·²åˆ›å»º',
                        duration: 2000
                    });
                }
            } catch (error) {
                console.error('ä¿å­˜è®¡åˆ’å¤±è´¥:', error);
                if (window.modalSystem) {
                    window.modalSystem.show({
                        type: 'error',
                        title: 'å¤±è´¥',
                        message: 'ä¿å­˜è®¡åˆ’æ—¶å‘ç”Ÿé”™è¯¯',
                        duration: 3000
                    });
                }
            }
        }
        
        // ç¡®è®¤è®¡åˆ’
        async function confirmPlan(planId) {
            if (window.confirmationSystem) {
                const plan = plans.find(p => p.id === planId);
                const result = await window.confirmationSystem.showTaskPlanConfirmation(plan);
                if (result.confirmed) {
                    await loadPlans();
                }
            } else {
                // å¦‚æœæ²¡æœ‰ç¡®è®¤ç³»ç»Ÿï¼Œç›´æ¥ç¡®è®¤
                try {
                    const response = await fetch(`${API_BASE}/task-planning/plans/${planId}/confirm`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ confirmed: true })
                    });
                    
                    if (response.ok) {
                        await loadPlans();
                    }
                } catch (error) {
                    console.error('ç¡®è®¤è®¡åˆ’å¤±è´¥:', error);
                }
            }
        }
        
        // åˆ é™¤è®¡åˆ’
        async function deletePlan(planId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¡åˆ’å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/task-planning/plans/${planId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadPlans();
                    if (window.modalSystem) {
                        window.modalSystem.show({
                            type: 'success',
                            title: 'å·²åˆ é™¤',
                            message: 'è®¡åˆ’å·²åˆ é™¤',
                            duration: 2000
                        });
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤è®¡åˆ’å¤±è´¥:', error);
            }
        }
        
        // åˆ‡æ¢ä»»åŠ¡çŠ¶æ€
        async function toggleTask(planId, taskId) {
            // TODO: å®ç°ä»»åŠ¡çŠ¶æ€åˆ‡æ¢
            console.log('åˆ‡æ¢ä»»åŠ¡çŠ¶æ€:', planId, taskId);
        }
        
        // åˆ·æ–°è®¡åˆ’
        function refreshPlans() {
            loadPlans();
        }
        
        // å·¥å…·å‡½æ•°
        function getStatusText(status) {
            const statusMap = {
                pending: 'å¾…ç¡®è®¤',
                confirmed: 'å·²ç¡®è®¤',
                executing: 'æ‰§è¡Œä¸­',
                completed: 'å·²å®Œæˆ'
            };
            return statusMap[status] || 'æœªçŸ¥';
        }
        
        function formatDuration(minutes) {
            if (minutes < 60) return `${minutes}åˆ†é’Ÿ`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours}å°æ—¶${mins}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
        }
    </script>
</body>
</html>

