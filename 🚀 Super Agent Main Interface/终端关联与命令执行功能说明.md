# 终端关联与命令执行功能说明

**完成时间**: 2025-01-XX  
**状态**: ✅ 已完成（本地沙箱、白名单、审计日志）

---

## 🎯 功能概述

实现了完整的终端命令执行系统，包含：
1. **本地沙箱机制**：工作目录隔离、资源限制
2. **白名单管理系统**：可配置、可扩展的命令白名单
3. **审计日志系统**：独立的审计日志存储、查询、导出
4. **安全策略配置**：完整的API接口

---

## ✅ 已完成功能

### 1. 本地沙箱机制

#### 1.1 工作目录隔离
- ✅ 独立的沙箱工作目录（`.terminal_sandbox`）
- ✅ 所有命令在沙箱目录中执行
- ✅ 防止访问工作区外的目录
- ✅ 支持清理沙箱目录

#### 1.2 资源限制
- ✅ 内存限制：最大512MB
- ✅ CPU时间限制：最大30秒
- ✅ 文件大小限制：最大100MB
- ✅ 输出限制：最大10,000字符，400行
- ✅ 并发限制：最多2个并发命令

#### 1.3 环境变量清理
- ✅ 自动过滤敏感环境变量（API_KEY、SECRET、TOKEN等）
- ✅ 防止泄露敏感信息

---

### 2. 白名单管理系统

#### 2.1 可配置白名单
- ✅ 白名单配置存储在 `data/terminal_whitelist.json`
- ✅ 支持动态添加/移除命令
- ✅ 默认包含常用安全命令

#### 2.2 默认白名单
```json
{
  "allowed_commands": [
    "ls", "pwd", "cd", "cat", "grep", "find", "ps", "top",
    "df", "du", "free", "uptime", "whoami", "date", "echo",
    "git", "python", "python3", "pip", "pip3", "node", "npm",
    "docker", "docker-compose", "kubectl", "curl", "wget",
    "head", "tail", "wc", "env", "which", "mkdir", "touch",
    "cp", "mv", "rm", "chmod", "chown", "tar", "zip", "unzip"
  ]
}
```

#### 2.3 危险命令检测
- ✅ 检测危险命令模式（`rm -rf`、`sudo`、`shutdown`等）
- ✅ 检测禁止的token（`&&`、`||`、`;`、`|`、`>`、`<`等）
- ✅ 自动阻止不安全命令

---

### 3. 审计日志系统

#### 3.1 日志存储
- ✅ 按日期分割日志文件（`audit_YYYYMMDD.jsonl`）
- ✅ JSONL格式，便于查询和分析
- ✅ 自动日志轮转（100MB限制）
- ✅ 自动清理旧日志（保留30天）

#### 3.2 记录的事件类型
- `command_start` - 命令开始执行
- `command_blocked` - 命令被阻止
- `command_completed` - 命令成功完成
- `command_failed` - 命令执行失败
- `command_timeout` - 命令执行超时
- `whitelist_update` - 白名单更新
- `security_alert` - 安全告警
- `policy_violation` - 策略违规

#### 3.3 严重程度级别
- `info` - 信息
- `low` - 低
- `medium` - 中
- `high` - 高
- `critical` - 严重

#### 3.4 日志查询
- ✅ 支持按时间范围查询
- ✅ 支持按事件类型过滤
- ✅ 支持按严重程度过滤
- ✅ 支持按命令ID、用户ID过滤
- ✅ 支持按成功/失败状态过滤

#### 3.5 日志导出
- ✅ 支持导出为JSON格式
- ✅ 支持导出为CSV格式
- ✅ 支持按时间范围导出

---

## 📡 API 接口

### 1. 命令执行接口

**端点**: `POST /api/super-agent/terminal/execute`

**参数**:
```json
{
  "command": "ls -la",
  "timeout": 30,
  "cwd": "/path/to/dir"
}
```

**响应**:
```json
{
  "success": true,
  "command": "ls -la",
  "command_id": "uuid",
  "stdout": "输出内容",
  "stderr": "",
  "return_code": 0,
  "timestamp": "2025-01-01T12:00:00",
  "work_directory": "/path/to/sandbox",
  "duration": 0.123,
  "sandbox": true
}
```

---

### 2. 白名单管理接口

#### 2.1 获取白名单
**端点**: `GET /api/super-agent/terminal/whitelist`

**响应**:
```json
{
  "success": true,
  "allowed_commands": ["ls", "pwd", ...],
  "dangerous_commands": ["rm -rf", ...],
  "forbidden_tokens": ["&&", "||", ...],
  "count": 30
}
```

#### 2.2 更新白名单
**端点**: `POST /api/super-agent/terminal/whitelist/update`

**参数**:
```json
{
  "add_commands": ["new_command"],
  "remove_commands": ["old_command"]
}
```

---

### 3. 沙箱管理接口

**端点**: `POST /api/super-agent/terminal/sandbox/clear`

**响应**:
```json
{
  "success": true,
  "message": "沙箱已清理",
  "sandbox_dir": "/path/to/.terminal_sandbox"
}
```

---

### 4. 审计日志接口

#### 4.1 查询日志
**端点**: `GET /api/super-agent/terminal/audit/logs`

**参数**:
- `start_time`: 开始时间（ISO格式）
- `end_time`: 结束时间（ISO格式）
- `event_type`: 事件类型
- `severity`: 严重程度
- `command_id`: 命令ID
- `user_id`: 用户ID
- `success`: 是否成功
- `limit`: 返回数量限制

**响应**:
```json
{
  "success": true,
  "logs": [
    {
      "log_id": "audit_20250101120000",
      "timestamp": "2025-01-01T12:00:00",
      "event_type": "command_start",
      "severity": "info",
      "command_id": "uuid",
      "command": "ls -la",
      "cwd": "/path/to/sandbox",
      "success": true
    }
  ],
  "count": 1
}
```

#### 4.2 获取统计信息
**端点**: `GET /api/super-agent/terminal/audit/statistics`

**参数**:
- `start_time`: 开始时间（ISO格式）
- `end_time`: 结束时间（ISO格式）

**响应**:
```json
{
  "success": true,
  "total": 100,
  "by_event_type": {
    "command_start": 50,
    "command_completed": 40,
    "command_blocked": 10
  },
  "by_severity": {
    "info": 80,
    "medium": 15,
    "high": 5
  },
  "blocked_count": 10,
  "failed_count": 5,
  "success_count": 85,
  "block_rate": 10.0,
  "success_rate": 85.0
}
```

#### 4.3 导出日志
**端点**: `POST /api/super-agent/terminal/audit/export`

**参数**:
```json
{
  "output_path": "/path/to/export.json",
  "start_time": "2025-01-01T00:00:00",
  "end_time": "2025-01-01T23:59:59",
  "format": "json"
}
```

---

## 🔒 安全特性

### 1. 命令安全检查
- ✅ 白名单验证（仅允许列表中的命令）
- ✅ 危险命令检测
- ✅ 禁止token检测
- ✅ 路径遍历防护（`../`、`~`等）

### 2. 资源限制
- ✅ 内存限制（512MB）
- ✅ CPU时间限制（30秒）
- ✅ 文件大小限制（100MB）
- ✅ 输出截断（防止DoS攻击）

### 3. 审计追踪
- ✅ 所有命令执行记录
- ✅ 命令阻止记录
- ✅ 白名单更新记录
- ✅ 安全事件记录

---

## 📝 使用示例

### Python 示例
```python
import requests

# 执行命令
response = requests.post(
    "http://localhost:8000/api/super-agent/terminal/execute",
    json={"command": "ls -la", "timeout": 30}
)
result = response.json()
print(result["stdout"])

# 查询审计日志
response = requests.get(
    "http://localhost:8000/api/super-agent/terminal/audit/logs",
    params={"limit": 10}
)
logs = response.json()["logs"]
for log in logs:
    print(f"{log['timestamp']}: {log['command']} - {log['event_type']}")

# 更新白名单
response = requests.post(
    "http://localhost:8000/api/super-agent/terminal/whitelist/update",
    json={"add_commands": ["new_command"]}
)
```

### JavaScript 示例
```javascript
// 执行命令
fetch('http://localhost:8000/api/super-agent/terminal/execute', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ command: 'ls -la' })
})
.then(res => res.json())
.then(result => {
  console.log(result.stdout);
});

// 查询审计日志
fetch('http://localhost:8000/api/super-agent/terminal/audit/logs?limit=10')
.then(res => res.json())
.then(data => {
  data.logs.forEach(log => {
    console.log(`${log.timestamp}: ${log.command}`);
  });
});
```

---

## ⚠️ 注意事项

1. **沙箱模式**：默认启用，所有命令在隔离目录中执行
2. **白名单**：只有白名单中的命令才能执行
3. **资源限制**：大文件或长时间运行的命令可能被限制
4. **审计日志**：所有命令执行都会被记录
5. **安全策略**：危险命令和禁止token会被自动阻止

---

## 🚀 后续优化方向

- [ ] 支持命令别名
- [ ] 支持命令参数验证
- [ ] 支持命令执行权限控制
- [ ] 支持实时命令输出流
- [ ] 支持命令执行结果缓存
- [ ] 支持命令执行模板

---

## 📞 技术支持

如有问题，请查看：
- API 文档: `/api/super-agent/docs`
- 审计日志: `data/terminal_audit/`
- 白名单配置: `data/terminal_whitelist.json`

---

**版本**: v1.0.0  
**最后更新**: 2025-01-XX

