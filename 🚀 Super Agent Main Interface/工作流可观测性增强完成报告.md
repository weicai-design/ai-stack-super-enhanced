# å·¥ä½œæµå¯è§‚æµ‹æ€§å¢å¼ºå®ŒæˆæŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

å·²æˆåŠŸä¸ºå·¥ä½œæµç³»ç»Ÿæ·»åŠ å®Œæ•´çš„å¯è§‚æµ‹æ€§æ”¯æŒï¼ŒåŒ…æ‹¬è¯¦ç»†çš„æ—¥å¿—ã€æŒ‡æ ‡å’Œé“¾è·¯è¿½è¸ªåŠŸèƒ½ã€‚

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. å·¥ä½œæµå¯è§‚æµ‹æ€§æ¨¡å— (`workflow_observability.py`)

#### æ ¸å¿ƒåŠŸèƒ½
- **ç»“æ„åŒ–æ—¥å¿—è®°å½•**: JSONæ ¼å¼æ—¥å¿—ï¼ŒåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ä¿¡æ¯
- **æ€§èƒ½æŒ‡æ ‡æ”¶é›†**: è‡ªåŠ¨æ”¶é›†å·¥ä½œæµå’Œæ­¥éª¤çš„æ€§èƒ½æŒ‡æ ‡
- **é“¾è·¯è¿½è¸ªå¢å¼º**: å®Œæ•´çš„Traceå’ŒSpanç®¡ç†
- **é•¿ä»»åŠ¡è¿›åº¦è¿½è¸ª**: æ”¯æŒå·¥ä½œæµè¿›åº¦å®æ—¶æ›´æ–°

#### ä¸»è¦æ–¹æ³•
- `start_workflow_trace()`: å¼€å§‹å·¥ä½œæµè¿½è¸ª
- `start_workflow_step()`: å¼€å§‹æ­¥éª¤è¿½è¸ª
- `complete_workflow_step()`: å®Œæˆæ­¥éª¤è¿½è¸ª
- `complete_workflow_trace()`: å®Œæˆå·¥ä½œæµè¿½è¸ª
- `update_workflow_progress()`: æ›´æ–°å·¥ä½œæµè¿›åº¦
- `get_workflow_observability_data()`: è·å–å®Œæ•´å¯è§‚æµ‹æ€§æ•°æ®

### 2. å·¥ä½œæµå¼•æ“é›†æˆ

#### é›†æˆç‚¹
- âœ… å·¥ä½œæµå¼€å§‹æ—¶åˆ›å»ºTrace
- âœ… æ¯ä¸ªæ­¥éª¤åˆ›å»ºSpan
- âœ… æ­¥éª¤æ‰§è¡Œå‰åè®°å½•äº‹ä»¶
- âœ… å·¥ä½œæµå®Œæˆæ—¶è®°å½•æŒ‡æ ‡
- âœ… é”™è¯¯æ—¶è®°å½•å¤±è´¥ä¿¡æ¯

#### è¿½è¸ªçš„æ­¥éª¤
1. RAGæ£€ç´¢1
2. ä¸“å®¶è·¯ç”±1
3. æ¨¡å—æ‰§è¡Œ
4. ä¸“å®¶è·¯ç”±2
5. RAGæ£€ç´¢2
6. å“åº”ç”Ÿæˆ

### 3. å¯è§‚æµ‹æ€§API (`workflow_observability_api.py`)

#### APIç«¯ç‚¹

##### è·å–å·¥ä½œæµTrace
- **ç«¯ç‚¹**: `GET /api/workflow/observability/trace/{workflow_id}`
- **åŠŸèƒ½**: è·å–å·¥ä½œæµå®Œæ•´çš„å¯è§‚æµ‹æ€§æ•°æ®ï¼ˆTraceã€Spanã€æŒ‡æ ‡ï¼‰

##### è·å–å·¥ä½œæµSpan
- **ç«¯ç‚¹**: `GET /api/workflow/observability/spans/{workflow_id}`
- **åŠŸèƒ½**: è·å–å·¥ä½œæµæ‰€æœ‰Span

##### è·å–å·¥ä½œæµæŒ‡æ ‡
- **ç«¯ç‚¹**: `GET /api/workflow/observability/metrics/{workflow_id}`
- **åŠŸèƒ½**: è·å–å·¥ä½œæµç›¸å…³æŒ‡æ ‡

##### è·å–å·¥ä½œæµæ‘˜è¦
- **ç«¯ç‚¹**: `GET /api/workflow/observability/summary/{workflow_id}`
- **åŠŸèƒ½**: è·å–å·¥ä½œæµæ‘˜è¦ä¿¡æ¯ï¼ˆçŠ¶æ€ã€å¯è§‚æµ‹æ€§æ•°æ®ã€æ‰§è¡Œå†å²ï¼‰

##### è·å–å·¥ä½œæµæ—¥å¿—
- **ç«¯ç‚¹**: `GET /api/workflow/observability/logs/{workflow_id}?limit=100`
- **åŠŸèƒ½**: ä»æ—¥å¿—æ–‡ä»¶ä¸­è¯»å–å·¥ä½œæµç›¸å…³æ—¥å¿—

##### å¯è§‚æµ‹æ€§ä»ªè¡¨æ¿
- **ç«¯ç‚¹**: `GET /api/workflow/observability/dashboard?limit=50`
- **åŠŸèƒ½**: è·å–å¯è§‚æµ‹æ€§ä»ªè¡¨æ¿æ•°æ®ï¼ˆç»Ÿè®¡ä¿¡æ¯ã€æœ€è¿‘å·¥ä½œæµã€æ€§èƒ½æŒ‡æ ‡ï¼‰

## ğŸ“Š å¯è§‚æµ‹æ€§æ•°æ®

### 1. æ—¥å¿—

#### æ—¥å¿—ä½ç½®
- `logs/workflow/workflow_observability_YYYYMMDD.jsonl`

#### æ—¥å¿—æ ¼å¼
```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "event_type": "workflow.step.started",
  "workflow_id": "wf_intelligent_xxx",
  "trace_id": "trace_xxx",
  "span_id": "span_xxx",
  "request_id": "req_xxx",
  "data": {
    "step_name": "rag_retrieval_1",
    "step_type": "rag_retrieval",
    "input_data_size": 150
  }
}
```

#### äº‹ä»¶ç±»å‹
- `workflow.started`: å·¥ä½œæµå¼€å§‹
- `workflow.step.started`: æ­¥éª¤å¼€å§‹
- `workflow.step.completed`: æ­¥éª¤å®Œæˆ
- `workflow.step.failed`: æ­¥éª¤å¤±è´¥
- `workflow.completed`: å·¥ä½œæµå®Œæˆ
- `workflow.failed`: å·¥ä½œæµå¤±è´¥

### 2. æŒ‡æ ‡

#### è‡ªåŠ¨æ”¶é›†çš„æŒ‡æ ‡
- `workflow.started`: å·¥ä½œæµå¯åŠ¨æ¬¡æ•°
- `workflow.total`: å·¥ä½œæµæ€»æ•°ï¼ˆæŒ‰ç±»å‹å’ŒçŠ¶æ€ï¼‰
- `workflow.duration`: å·¥ä½œæµæ‰§è¡Œæ—¶é•¿
- `workflow.step.{step_name}.duration`: æ­¥éª¤æ‰§è¡Œæ—¶é•¿
- `workflow.step.{step_name}.total`: æ­¥éª¤æ‰§è¡Œæ¬¡æ•°ï¼ˆæŒ‰çŠ¶æ€ï¼‰

#### æŒ‡æ ‡æ ‡ç­¾
- `workflow_type`: å·¥ä½œæµç±»å‹ï¼ˆintelligent/directï¼‰
- `step_name`: æ­¥éª¤åç§°
- `status`: çŠ¶æ€ï¼ˆsuccess/failedï¼‰
- `workflow_id`: å·¥ä½œæµID

### 3. é“¾è·¯è¿½è¸ª

#### Traceç»“æ„
```json
{
  "trace_id": "trace_xxx",
  "request_id": "req_xxx",
  "service_name": "workflow-engine",
  "start_time": 1234567890.123,
  "end_time": 1234567891.456,
  "duration": 1.333,
  "status": "ok",
  "tags": {
    "workflow_id": "wf_intelligent_xxx",
    "workflow_type": "intelligent",
    "user_input_length": 150
  },
  "spans": [...]
}
```

#### Spanç»“æ„
```json
{
  "span_id": "span_xxx",
  "trace_id": "trace_xxx",
  "parent_span_id": "parent_span_xxx",
  "name": "workflow.step.rag_retrieval_1",
  "type": "internal",
  "status": "ok",
  "start_time": 1234567890.123,
  "end_time": 1234567890.456,
  "duration": 0.333,
  "tags": {
    "workflow_id": "wf_intelligent_xxx",
    "step_name": "rag_retrieval_1",
    "step_type": "rag_retrieval"
  },
  "logs": [...],
  "error": null
}
```

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### 1. æ‰§è¡Œå·¥ä½œæµï¼ˆè‡ªåŠ¨è¿½è¸ªï¼‰

```python
from core.dual_loop_workflow_engine import get_dual_loop_workflow_engine

engine = get_dual_loop_workflow_engine()

# æ‰§è¡Œå·¥ä½œæµï¼ˆè‡ªåŠ¨åˆ›å»ºTraceå’ŒSpanï¼‰
result = await engine.execute_intelligent_workflow(
    user_input="åˆ†ææœ¬æœˆé”€å”®è¶‹åŠ¿",
    context={},
)

# è·å–Trace ID
trace_id = result.trace_id
```

### 2. æŸ¥è¯¢å¯è§‚æµ‹æ€§æ•°æ®

```python
from core.workflow_observability import get_workflow_observability

observability = get_workflow_observability()

# è·å–å®Œæ•´å¯è§‚æµ‹æ€§æ•°æ®
data = observability.get_workflow_observability_data(workflow_id)

print(f"Trace: {data['trace']}")
print(f"Spans: {len(data['spans'])}")
print(f"Metrics: {len(data['metrics'])}")
```

### 3. APIè°ƒç”¨ç¤ºä¾‹

```bash
# è·å–å·¥ä½œæµTrace
curl http://localhost:8000/api/workflow/observability/trace/wf_intelligent_xxx

# è·å–å·¥ä½œæµæ‘˜è¦
curl http://localhost:8000/api/workflow/observability/summary/wf_intelligent_xxx

# è·å–å¯è§‚æµ‹æ€§ä»ªè¡¨æ¿
curl http://localhost:8000/api/workflow/observability/dashboard
```

## ğŸ“ æ–‡ä»¶æ¸…å•

1. **æ ¸å¿ƒæ¨¡å—**:
   - `core/workflow_observability.py` - å·¥ä½œæµå¯è§‚æµ‹æ€§æ¨¡å—ï¼ˆæ–°å»ºï¼‰
   - `core/dual_loop_workflow_engine.py` - å·¥ä½œæµå¼•æ“ï¼ˆå·²æ›´æ–°ï¼Œé›†æˆå¯è§‚æµ‹æ€§ï¼‰

2. **APIæ¥å£**:
   - `api/workflow_observability_api.py` - å¯è§‚æµ‹æ€§APIæ¥å£ï¼ˆæ–°å»ºï¼‰
   - `api/main.py` - ä¸»åº”ç”¨ï¼ˆå·²æ›´æ–°ï¼Œæ³¨å†Œå¯è§‚æµ‹æ€§è·¯ç”±ï¼‰

## âœ… å®ŒæˆçŠ¶æ€

- [x] åˆ›å»ºå·¥ä½œæµå¯è§‚æµ‹æ€§å¢å¼ºæ¨¡å—
- [x] é›†æˆå¯è§‚æµ‹æ€§ç³»ç»Ÿåˆ°å·¥ä½œæµå¼•æ“
- [x] å¢å¼ºæ—¥å¿—è®°å½•ï¼ˆç»“æ„åŒ–æ—¥å¿—ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰
- [x] å¢å¼ºæŒ‡æ ‡æ”¶é›†ï¼ˆæ€§èƒ½æŒ‡æ ‡ã€ä¸šåŠ¡æŒ‡æ ‡ï¼‰
- [x] å¢å¼ºé“¾è·¯è¿½è¸ªï¼ˆSpanåˆ›å»ºã€å…³è”ï¼‰
- [x] åˆ›å»ºå¯è§‚æµ‹æ€§APIç«¯ç‚¹

## ğŸš€ ä¸‹ä¸€æ­¥

1. **2.3 ä¸»ç•Œé¢å‘ˆç°**: åœ¨ä¸»ç•Œé¢ä¸Šå‘ˆç°å·¥ä½œæµå®æ—¶çŠ¶æ€ï¼ˆæ™ºèƒ½çº¿ & ç›´æ¥æ“ä½œçº¿ï¼‰

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **å¯è§‚æµ‹æ€§ç³»ç»Ÿ**: ä¸ºå¯é€‰ä¾èµ–ï¼Œå¦‚æœæ²¡æœ‰å¯è§‚æµ‹æ€§ç³»ç»Ÿä¼šä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬
2. **æ—¥å¿—ç›®å½•**: é»˜è®¤ä½¿ç”¨ `logs/workflow/`ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
3. **æ€§èƒ½å½±å“**: å¯è§‚æµ‹æ€§åŠŸèƒ½å¯¹æ€§èƒ½å½±å“å¾ˆå°ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
4. **æ•°æ®ä¿ç•™**: Traceå’ŒSpanæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºåˆ°æŒä¹…åŒ–å­˜å‚¨

