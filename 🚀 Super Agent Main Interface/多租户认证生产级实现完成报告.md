# å¤šç§Ÿæˆ·è®¤è¯ç”Ÿäº§çº§å®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å‰ç½®æ ¡éªŒç»“æœ

### âœ… ç°æœ‰å®ç°æ£€æŸ¥
- âœ… `core/tenant_context.py` - ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼ˆContextVarå®ç°ï¼‰
- âœ… `core/tenant_middleware.py` - ç§Ÿæˆ·ä¸­é—´ä»¶ï¼ˆå·²æ›´æ–°ï¼‰
- âœ… `core/security/permission_guard.py` - æƒé™å®ˆå«
- âœ… `core/security/middleware.py` - å®‰å…¨ä¸­é—´ä»¶
- âœ… `core/tenant_manager.py` - ç§Ÿæˆ·ç®¡ç†å™¨

## âœ… ç”Ÿäº§çº§å®ç°å®Œæˆ

### 1. å¤šç§Ÿæˆ·Tokenæ ¡éªŒ âœ…

**å®ç°å†…å®¹**:
- âœ… JWT Tokenåˆ›å»ºï¼ˆ`create_token`ï¼‰
  - æ”¯æŒç§Ÿæˆ·IDã€ç”¨æˆ·IDã€è§’è‰²ã€æƒé™
  - æ”¯æŒè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´
  - è‡ªåŠ¨éªŒè¯ç§Ÿæˆ·å­˜åœ¨æ€§å’Œæ¿€æ´»çŠ¶æ€
- âœ… JWT TokenéªŒè¯ï¼ˆ`verify_token`ï¼‰
  - éªŒè¯Tokenç­¾å
  - éªŒè¯Tokenè¿‡æœŸæ—¶é—´
  - éªŒè¯ç§Ÿæˆ·å­˜åœ¨æ€§å’Œæ¿€æ´»çŠ¶æ€
  - è¿”å›Tokenè½½è·ï¼ˆåŒ…å«ç§Ÿæˆ·ä¿¡æ¯ï¼‰
- âœ… Tokenåˆ·æ–°æœºåˆ¶ï¼ˆé€šè¿‡é‡æ–°åˆ›å»ºTokenå®ç°ï¼‰

**å®‰å…¨ç‰¹æ€§**:
- ä½¿ç”¨JWTæ ‡å‡†ï¼ˆHS256ç®—æ³•ï¼‰
- TokenåŒ…å«ç§Ÿæˆ·IDã€ç”¨æˆ·IDã€è§’è‰²ã€æƒé™
- è‡ªåŠ¨è¿‡æœŸæ£€æŸ¥
- ç§Ÿæˆ·æ¿€æ´»çŠ¶æ€éªŒè¯

### 2. API KeyéªŒè¯ âœ…

**å®ç°å†…å®¹**:
- âœ… API Keyåˆ›å»ºï¼ˆ`create_api_key`ï¼‰
  - ç”Ÿæˆå®‰å…¨çš„API Keyï¼ˆä½¿ç”¨secrets.token_urlsafeï¼‰
  - å­˜å‚¨API Keyå“ˆå¸Œå€¼ï¼ˆä¸å­˜å‚¨æ˜æ–‡ï¼‰
  - æ”¯æŒæƒé™åˆ—è¡¨
  - æ”¯æŒå‘½ä»¤ç™½åå•
  - è‡ªåŠ¨éªŒè¯ç§Ÿæˆ·å­˜åœ¨æ€§å’Œæ¿€æ´»çŠ¶æ€
- âœ… API KeyéªŒè¯ï¼ˆ`verify_api_key`ï¼‰
  - ä½¿ç”¨hmac.compare_digestè¿›è¡Œå®‰å…¨æ¯”è¾ƒï¼ˆé˜²æ­¢æ—¶åºæ”»å‡»ï¼‰
  - éªŒè¯API Keyæ¿€æ´»çŠ¶æ€
  - éªŒè¯ç§Ÿæˆ·å­˜åœ¨æ€§å’Œæ¿€æ´»çŠ¶æ€
  - è‡ªåŠ¨æ›´æ–°ä½¿ç”¨ç»Ÿè®¡ï¼ˆæœ€åä½¿ç”¨æ—¶é—´ã€ä½¿ç”¨æ¬¡æ•°ï¼‰
- âœ… API Keyæ’¤é”€ï¼ˆ`revoke_api_key`ï¼‰
  - æ ‡è®°API Keyä¸ºæœªæ¿€æ´»
  - æŒä¹…åŒ–å­˜å‚¨

**å®‰å…¨ç‰¹æ€§**:
- API Keyå“ˆå¸Œå­˜å‚¨ï¼ˆSHA256ï¼‰
- å®‰å…¨æ¯”è¾ƒï¼ˆhmac.compare_digestï¼‰
- ä½¿ç”¨ç»Ÿè®¡è·Ÿè¸ª
- ç§Ÿæˆ·æ¿€æ´»çŠ¶æ€éªŒè¯

### 3. å‘½ä»¤ç™½åå• âœ…

**å®ç°å†…å®¹**:
- âœ… å‘½ä»¤ç™½åå•å­˜å‚¨ï¼ˆ`update_command_whitelist`ï¼‰
  - æ”¯æŒæŒ‰ç§Ÿæˆ·å­˜å‚¨å‘½ä»¤ç™½åå•
  - æŒä¹…åŒ–å­˜å‚¨ï¼ˆJSONæ–‡ä»¶ï¼‰
  - è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³
- âœ… å‘½ä»¤ç™½åå•éªŒè¯ï¼ˆ`check_command_allowed`ï¼‰
  - æ£€æŸ¥å®Œæ•´å‘½ä»¤
  - æ£€æŸ¥å‘½ä»¤å‰ç¼€ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
  - è¿”å›æ˜¯å¦å…è®¸
- âœ… å‘½ä»¤ç™½åå•æŸ¥è¯¢ï¼ˆ`get_command_whitelist`ï¼‰
  - è·å–ç§Ÿæˆ·çš„å‘½ä»¤ç™½åå•
  - è¿”å›é»˜è®¤ç™½åå•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

**å®‰å…¨ç‰¹æ€§**:
- æŒ‰ç§Ÿæˆ·éš”ç¦»
- æŒä¹…åŒ–å­˜å‚¨
- æ”¯æŒå‘½ä»¤å‰ç¼€åŒ¹é…

### 4. Tenant Contextç»‘å®š âœ…

**å®ç°å†…å®¹**:
- âœ… ä»Tokenæå–ç§Ÿæˆ·ä¿¡æ¯ï¼ˆ`bind_tenant_context`ï¼‰
  - ä»Tokenè½½è·ä¸­æå–tenant_id
  - åˆ›å»ºTenantContextå¯¹è±¡
  - è®¾ç½®åˆ°ContextVar
  - è®¾ç½®åˆ°è¯·æ±‚çŠ¶æ€
- âœ… ä»API Keyæå–ç§Ÿæˆ·ä¿¡æ¯ï¼ˆ`bind_tenant_context`ï¼‰
  - ä»API Keyä¿¡æ¯ä¸­æå–tenant_id
  - åˆ›å»ºTenantContextå¯¹è±¡
  - è®¾ç½®åˆ°ContextVar
  - è®¾ç½®åˆ°è¯·æ±‚çŠ¶æ€
- âœ… å‘åå…¼å®¹ï¼ˆ`TenantContextMiddleware`ï¼‰
  - æ”¯æŒX-Tenant-IDå¤´
  - æ”¯æŒæŸ¥è¯¢å‚æ•°tenant_id
  - é»˜è®¤ç§Ÿæˆ·ä¸º"global"

**é›†æˆç‰¹æ€§**:
- è‡ªåŠ¨ä»è®¤è¯ä¿¡æ¯æå–ç§Ÿæˆ·
- è‡ªåŠ¨ç»‘å®šTenant Context
- å‘åå…¼å®¹ç°æœ‰å®ç°

### 5. APIç«¯ç‚¹ âœ…

**å®ç°å†…å®¹**:
- âœ… Tokenç®¡ç†ç«¯ç‚¹
  - `POST /api/tenant/auth/token/create` - åˆ›å»ºToken
  - `POST /api/tenant/auth/token/verify` - éªŒè¯Token
- âœ… API Keyç®¡ç†ç«¯ç‚¹
  - `POST /api/tenant/auth/api-key/create` - åˆ›å»ºAPI Key
  - `GET /api/tenant/auth/api-key/list` - åˆ—å‡ºAPI Key
  - `POST /api/tenant/auth/api-key/revoke` - æ’¤é”€API Key
- âœ… å‘½ä»¤ç™½åå•ç®¡ç†ç«¯ç‚¹
  - `GET /api/tenant/auth/command-whitelist` - è·å–å‘½ä»¤ç™½åå•
  - `POST /api/tenant/auth/command-whitelist/update` - æ›´æ–°å‘½ä»¤ç™½åå•
  - `POST /api/tenant/auth/command-whitelist/check` - æ£€æŸ¥å‘½ä»¤æ˜¯å¦å…è®¸

**æƒé™æ§åˆ¶**:
- åªèƒ½ä¸ºè‡ªå·±çš„ç§Ÿæˆ·åˆ›å»º/æŸ¥çœ‹èµ„æº
- ç®¡ç†å‘˜ï¼ˆglobalç§Ÿæˆ·ï¼‰å¯ä»¥ç®¡ç†æ‰€æœ‰ç§Ÿæˆ·
- è‡ªåŠ¨æƒé™éªŒè¯

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### Tokenè®¤è¯

**åˆ›å»ºToken**:
```python
POST /api/tenant/auth/token/create
{
    "tenant_id": "tenant_123",
    "user_id": "user_456",
    "roles": ["admin", "user"],
    "permissions": ["read", "write"],
    "expiration_hours": 24
}
```

**ä½¿ç”¨Token**:
```http
Authorization: Bearer <token>
```

### API Keyè®¤è¯

**åˆ›å»ºAPI Key**:
```python
POST /api/tenant/auth/api-key/create
{
    "tenant_id": "tenant_123",
    "name": "My API Key",
    "permissions": ["read", "write"],
    "commands_whitelist": ["ls", "cat", "grep"]
}
```

**ä½¿ç”¨API Key**:
```http
X-API-Key: <api_key>
```

### å‘½ä»¤ç™½åå•

**æ›´æ–°å‘½ä»¤ç™½åå•**:
```python
POST /api/tenant/auth/command-whitelist/update
{
    "tenant_id": "tenant_123",
    "commands": ["ls", "cat", "grep", "find"]
}
```

**æ£€æŸ¥å‘½ä»¤**:
```python
POST /api/tenant/auth/command-whitelist/check
{
    "command": "ls -la",
    "tenant_id": "tenant_123"
}
```

## ğŸ“ æ–‡ä»¶æ¸…å•

1. **æ ¸å¿ƒæ¨¡å—**:
   - `core/security/tenant_auth.py` - å¤šç§Ÿæˆ·è®¤è¯ç®¡ç†å™¨ï¼ˆæ–°åˆ›å»ºï¼‰
     - Tokenç®¡ç†ï¼ˆåˆ›å»ºã€éªŒè¯ï¼‰
     - API Keyç®¡ç†ï¼ˆåˆ›å»ºã€éªŒè¯ã€æ’¤é”€ï¼‰
     - å‘½ä»¤ç™½åå•ç®¡ç†ï¼ˆå­˜å‚¨ã€éªŒè¯ã€æŸ¥è¯¢ï¼‰
     - Tenant Contextç»‘å®š
   - `core/tenant_middleware.py` - ç§Ÿæˆ·ä¸­é—´ä»¶ï¼ˆå·²æ›´æ–°ï¼‰
     - é›†æˆæ–°çš„è®¤è¯ç³»ç»Ÿ
     - è‡ªåŠ¨ä»Token/API Keyæå–ç§Ÿæˆ·ä¿¡æ¯
     - å‘åå…¼å®¹

2. **APIç«¯ç‚¹**:
   - `api/tenant_auth_api.py` - å¤šç§Ÿæˆ·è®¤è¯APIï¼ˆæ–°åˆ›å»ºï¼‰
     - Tokenç®¡ç†ç«¯ç‚¹
     - API Keyç®¡ç†ç«¯ç‚¹
     - å‘½ä»¤ç™½åå•ç®¡ç†ç«¯ç‚¹

3. **ä¸»åº”ç”¨**:
   - `api/main.py` - ä¸»åº”ç”¨ï¼ˆå·²æ›´æ–°ï¼‰
     - æ³¨å†Œå¤šç§Ÿæˆ·è®¤è¯APIè·¯ç”±

## âœ… å®ŒæˆçŠ¶æ€

- [x] å‰ç½®æ ¡éªŒï¼šæ£€æŸ¥å¤šç§Ÿæˆ·è®¤è¯å®ç°çŠ¶æ€
- [x] å®ç°å¤šç§Ÿæˆ·Tokenæ ¡éªŒï¼ˆJWTéªŒè¯ã€ç§Ÿæˆ·ç»‘å®šã€è¿‡æœŸæ£€æŸ¥ï¼‰
- [x] å®ç°API KeyéªŒè¯ï¼ˆå­˜å‚¨ã€éªŒè¯ã€ç§Ÿæˆ·ç»‘å®šã€æƒé™æ§åˆ¶ï¼‰
- [x] å®ç°å‘½ä»¤ç™½åå•ï¼ˆå­˜å‚¨ã€éªŒè¯ã€ç§Ÿæˆ·ç»‘å®šã€æ›´æ–°æœºåˆ¶ï¼‰
- [x] æ›´æ–°Tenant Contextç»‘å®šï¼ˆä»token/API Keyæå–ç§Ÿæˆ·ä¿¡æ¯ï¼‰

## ğŸ¯ ç”Ÿäº§çº§æ ‡å‡†è¾¾æˆ

### å®Œæ•´æ€§
- âœ… Tokenè®¤è¯å®Œæ•´å®ç°
- âœ… API Keyè®¤è¯å®Œæ•´å®ç°
- âœ… å‘½ä»¤ç™½åå•å®Œæ•´å®ç°
- âœ… Tenant Contextç»‘å®šå®Œæ•´å®ç°

### å¯é æ€§
- âœ… å®Œå–„çš„å‚æ•°éªŒè¯
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… ç§Ÿæˆ·æ¿€æ´»çŠ¶æ€éªŒè¯
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

### å®‰å…¨æ€§
- âœ… JWT Tokenç­¾åéªŒè¯
- âœ… API Keyå“ˆå¸Œå­˜å‚¨ï¼ˆSHA256ï¼‰
- âœ… å®‰å…¨æ¯”è¾ƒï¼ˆhmac.compare_digestï¼‰
- âœ… å‘½ä»¤ç™½åå•éš”ç¦»
- âœ… æƒé™æ§åˆ¶ï¼ˆåªèƒ½ç®¡ç†è‡ªå·±çš„ç§Ÿæˆ·ï¼‰

### å¯ç»´æŠ¤æ€§
- âœ… æ¸…æ™°çš„ä»£ç ç»“æ„
- âœ… å®Œå–„çš„æ–‡æ¡£æ³¨é‡Š
- âœ… ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

## ğŸ“Œ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºToken

```python
import requests

response = requests.post(
    "http://localhost:8000/api/tenant/auth/token/create",
    json={
        "tenant_id": "tenant_123",
        "user_id": "user_456",
        "roles": ["admin"],
        "permissions": ["read", "write"],
        "expiration_hours": 24
    }
)

token = response.json()["token"]
```

### 2. ä½¿ç”¨Tokenè®¤è¯

```python
import requests

headers = {
    "Authorization": f"Bearer {token}"
}

response = requests.get(
    "http://localhost:8000/api/some-endpoint",
    headers=headers
)
```

### 3. åˆ›å»ºAPI Key

```python
import requests

response = requests.post(
    "http://localhost:8000/api/tenant/auth/api-key/create",
    json={
        "tenant_id": "tenant_123",
        "name": "My API Key",
        "permissions": ["read", "write"],
        "commands_whitelist": ["ls", "cat"]
    },
    headers={"Authorization": f"Bearer {token}"}
)

api_key = response.json()["api_key"]
```

### 4. ä½¿ç”¨API Keyè®¤è¯

```python
import requests

headers = {
    "X-API-Key": api_key
}

response = requests.get(
    "http://localhost:8000/api/some-endpoint",
    headers=headers
)
```

### 5. æ›´æ–°å‘½ä»¤ç™½åå•

```python
import requests

response = requests.post(
    "http://localhost:8000/api/tenant/auth/command-whitelist/update",
    json={
        "tenant_id": "tenant_123",
        "commands": ["ls", "cat", "grep", "find"]
    },
    headers={"Authorization": f"Bearer {token}"}
)
```

### 6. æ£€æŸ¥å‘½ä»¤æ˜¯å¦å…è®¸

```python
import requests

response = requests.post(
    "http://localhost:8000/api/tenant/auth/command-whitelist/check",
    json={
        "command": "ls -la",
        "tenant_id": "tenant_123"
    },
    headers={"Authorization": f"Bearer {token}"}
)

allowed = response.json()["allowed"]
```

## ğŸš€ ä¸‹ä¸€æ­¥

ç³»ç»Ÿå·²è¾¾åˆ°ç”Ÿäº§æ°´å¹³ï¼Œå¯ä»¥ï¼š
1. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
2. é…ç½®JWTå¯†é’¥ï¼ˆJWT_SECRET_KEYç¯å¢ƒå˜é‡ï¼‰
3. ä¸ºç§Ÿæˆ·åˆ›å»ºTokenå’ŒAPI Key
4. é…ç½®å‘½ä»¤ç™½åå•
5. ç›‘æ§è®¤è¯ä½¿ç”¨æƒ…å†µ

