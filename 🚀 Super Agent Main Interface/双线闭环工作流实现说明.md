# åŒçº¿é—­ç¯å·¥ä½œæµå®ç°è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

å·²æˆåŠŸå®ç°"RAGâ†’ä¸“å®¶â†’æ¨¡å—â†’ä¸“å®¶â†’RAG"çš„åŒçº¿é—­ç¯å·¥ä½œæµç³»ç»Ÿï¼ŒåŒ…å«å®Œæ•´çš„æ•°æ®ç»“æ„ã€è°ƒç”¨é“¾è·¯å’ŒAPIæ¥å£ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒç»„ä»¶

#### 1.1 å·¥ä½œæµç¼–æ’å™¨ (`workflow_orchestrator.py`)
- **åŠŸèƒ½**: ç®¡ç†å·¥ä½œæµçŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸå’Œäº‹ä»¶å‘å¸ƒ
- **æ•°æ®ç»“æ„**:
  - `IntelligentWorkflowData`: æ™ºèƒ½çº¿å·¥ä½œæµæ•°æ®
  - `DirectWorkflowData`: ç›´æ¥æ“ä½œçº¿å·¥ä½œæµæ•°æ®
  - `WorkflowStep`: å·¥ä½œæµæ­¥éª¤è®°å½•
- **çŠ¶æ€ç®¡ç†**: å®Œæ•´çš„çŠ¶æ€æœºå®ç°ï¼Œæ”¯æŒçŠ¶æ€è½¬æ¢éªŒè¯
- **å¯è§‚æµ‹æ€§**: æ”¯æŒ trace_idã€span_id åŸ‹ç‚¹ï¼Œæ—¥å¿—å†™å…¥ `logs/workflow/`
- **æŒ‡æ ‡**: Prometheus æŒ‡æ ‡å’Œ JSON API

#### 1.2 åŒçº¿é—­ç¯å·¥ä½œæµå¼•æ“ (`dual_loop_workflow_engine.py`)
- **åŠŸèƒ½**: æ‰§è¡Œå®Œæ•´çš„å·¥ä½œæµé—­ç¯æµç¨‹
- **æ™ºèƒ½çº¿æµç¨‹**:
  1. **RAGæ£€ç´¢1**: ç†è§£ç”¨æˆ·éœ€æ±‚ï¼Œæ£€ç´¢ç›¸å…³çŸ¥è¯†
  2. **ä¸“å®¶è·¯ç”±1**: æ ¹æ®RAGç»“æœé€‰æ‹©ä¸“å®¶å’Œæ¨¡å—
  3. **æ¨¡å—æ‰§è¡Œ**: æ‰§è¡Œå…·ä½“åŠŸèƒ½æ¨¡å—
  4. **ä¸“å®¶è·¯ç”±2**: ä¸“å®¶ç³»ç»Ÿå¯¹æ‰§è¡Œç»“æœè¿›è¡Œåå¤„ç†
  5. **RAGæ£€ç´¢2**: æ•´åˆå†å²ç»éªŒå’Œæœ€ä½³å®è·µ
  6. **å“åº”ç”Ÿæˆ**: ç»¼åˆæ‰€æœ‰ä¿¡æ¯ç”Ÿæˆæœ€ç»ˆå“åº”
- **ç›´æ¥æ“ä½œçº¿æµç¨‹**:
  1. **æ¨¡å—æ‰§è¡Œ**: ç›´æ¥æ‰§è¡Œç›®æ ‡æ¨¡å—
  2. **å“åº”ç”Ÿæˆ**: ç”Ÿæˆå“åº”

### 2. æ•°æ®ç»“æ„

#### 2.1 æ™ºèƒ½çº¿å·¥ä½œæµæ•°æ®
```python
@dataclass
class IntelligentWorkflowData:
    workflow_id: str
    workflow_type: WorkflowType = WorkflowType.INTELLIGENT
    state: WorkflowState
    user_input: str
    context: Dict[str, Any]
    
    # å¯è§‚æµ‹æ€§å­—æ®µ
    trace_id: Optional[str]
    span_id: Optional[str]
    parent_span_id: Optional[str]
    
    # æ­¥éª¤æ•°æ®
    rag_result_1: Optional[Dict[str, Any]]  # ç¬¬ä¸€æ¬¡RAGæ£€ç´¢ç»“æœ
    expert_routing_result: Optional[Dict[str, Any]]  # ä¸“å®¶è·¯ç”±ç»“æœ
    module_execution_result: Optional[Dict[str, Any]]  # æ¨¡å—æ‰§è¡Œç»“æœ
    rag_result_2: Optional[Dict[str, Any]]  # ç¬¬äºŒæ¬¡RAGæ£€ç´¢ç»“æœ
    response: Optional[str]  # æœ€ç»ˆå“åº”
    
    # æ—¶é—´æˆ³å’Œæ­¥éª¤è®°å½•
    created_at: str
    updated_at: str
    started_at: Optional[str]
    completed_at: Optional[str]
    steps: List[WorkflowStep]
```

#### 2.2 å·¥ä½œæµæ­¥éª¤ç»“æœ
```python
@dataclass
class WorkflowStepResult:
    step_type: WorkflowStepType
    success: bool
    data: Dict[str, Any]
    error: Optional[str]
    duration: float
    started_at: str
    completed_at: Optional[str]
```

### 3. è°ƒç”¨é“¾è·¯

#### 3.1 æ™ºèƒ½çº¿è°ƒç”¨é“¾è·¯
```
ç”¨æˆ·è¾“å…¥
  â†“
[RAGæ£€ç´¢1] â†’ ç†è§£éœ€æ±‚ï¼Œæ£€ç´¢ç›¸å…³çŸ¥è¯†
  â†“
[ä¸“å®¶è·¯ç”±1] â†’ é€‰æ‹©ä¸“å®¶å’Œæ¨¡å—
  â†“
[æ¨¡å—æ‰§è¡Œ] â†’ æ‰§è¡Œå…·ä½“åŠŸèƒ½
  â†“
[ä¸“å®¶è·¯ç”±2] â†’ ä¸“å®¶ç³»ç»Ÿåå¤„ç†
  â†“
[RAGæ£€ç´¢2] â†’ æ•´åˆå†å²ç»éªŒå’Œæœ€ä½³å®è·µ
  â†“
[å“åº”ç”Ÿæˆ] â†’ ç»¼åˆæ‰€æœ‰ä¿¡æ¯ç”Ÿæˆæœ€ç»ˆå“åº”
  â†“
è¿”å›ç»“æœ
```

#### 3.2 ç›´æ¥æ“ä½œçº¿è°ƒç”¨é“¾è·¯
```
ç”¨æˆ·è¾“å…¥
  â†“
[æ¨¡å—æ‰§è¡Œ] â†’ ç›´æ¥æ‰§è¡Œç›®æ ‡æ¨¡å—
  â†“
[å“åº”ç”Ÿæˆ] â†’ ç”Ÿæˆå“åº”
  â†“
è¿”å›ç»“æœ
```

## ğŸ”Œ APIæ¥å£

### 1. æ™ºèƒ½çº¿å·¥ä½œæµ
**ç«¯ç‚¹**: `POST /api/workflow/intelligent`

**è¯·æ±‚**:
```json
{
  "user_input": "åˆ†ææœ¬æœˆé”€å”®è¶‹åŠ¿",
  "context": {},
  "trace_id": "optional",
  "parent_span_id": "optional"
}
```

**å“åº”**:
```json
{
  "workflow_id": "wf_intelligent_xxx",
  "workflow_type": "intelligent",
  "success": true,
  "response": "æ‰§è¡Œç»“æœ...",
  "total_duration": 2.5,
  "steps": [
    {
      "step_type": "rag_retrieval_1",
      "success": true,
      "duration": 0.3
    },
    ...
  ],
  "trace_id": "xxx"
}
```

### 2. ç›´æ¥æ“ä½œçº¿å·¥ä½œæµ
**ç«¯ç‚¹**: `POST /api/workflow/direct`

**è¯·æ±‚**:
```json
{
  "user_input": "æŸ¥è¯¢è®¢å•åˆ—è¡¨",
  "target_module": "erp",
  "context": {},
  "trace_id": "optional",
  "parent_span_id": "optional"
}
```

### 3. è·å–å·¥ä½œæµçŠ¶æ€
**ç«¯ç‚¹**: `GET /api/workflow/status/{workflow_id}`

### 4. è·å–æ‰§è¡Œå†å²
**ç«¯ç‚¹**: `GET /api/workflow/history?workflow_id=xxx&limit=100`

### 5. è·å–å·¥ä½œæµæŒ‡æ ‡
**ç«¯ç‚¹**: `GET /api/workflow/metrics`

## ğŸ“Š å¯è§‚æµ‹æ€§

### 1. æ—¥å¿—
- **ä½ç½®**: `logs/workflow/workflow_YYYYMMDD.log`
- **æ ¼å¼**: JSON Lines (JSONL)
- **å†…å®¹**: åŒ…å« trace_idã€span_idã€äº‹ä»¶ç±»å‹ã€æ•°æ®ç­‰

### 2. æŒ‡æ ‡
- **Prometheusæ ¼å¼**: `/api/workflow/metrics` (Prometheusæ ¼å¼)
- **JSONæ ¼å¼**: `/api/workflow/metrics` (JSONæ ¼å¼)
- **æŒ‡æ ‡ç±»å‹**:
  - `workflow_total`: å·¥ä½œæµæ€»æ•°ï¼ˆæŒ‰ç±»å‹å’ŒçŠ¶æ€ï¼‰
  - `workflow_duration_seconds`: å·¥ä½œæµæ‰§è¡Œæ—¶é•¿
  - `workflow_active`: æ´»è·ƒå·¥ä½œæµæ•°é‡
  - `workflow_steps_total`: å·¥ä½œæµæ­¥éª¤æ€»æ•°

### 3. é“¾è·¯è¿½è¸ª
- **Trace ID**: æ¯ä¸ªå·¥ä½œæµæœ‰å”¯ä¸€çš„ trace_id
- **Span ID**: æ¯ä¸ªæ­¥éª¤æœ‰ç‹¬ç«‹çš„ span_id
- **çˆ¶Span ID**: æ”¯æŒåµŒå¥—çš„spanå…³ç³»

## ğŸ”§ é›†æˆè¯´æ˜

### 1. å·²é›†æˆç»„ä»¶
- âœ… RAGæœåŠ¡é€‚é…å™¨ (`RAGServiceAdapter`)
- âœ… ä¸“å®¶è·¯ç”±å™¨ (`ExpertRouter`)
- âœ… æ¨¡å—æ‰§è¡Œå™¨ (`ModuleExecutor`)
- âœ… ä¸“å®¶ç³»ç»Ÿ (`RAGExpertSystem`) - å¯é€‰
- âœ… å·¥ä½œæµç¼–æ’å™¨ (`WorkflowOrchestrator`)

### 2. ä½¿ç”¨ç¤ºä¾‹

```python
from core.dual_loop_workflow_engine import get_dual_loop_workflow_engine
from core.workflow_orchestrator import get_workflow_orchestrator
from core.rag_service_adapter import RAGServiceAdapter
from core.expert_router import ExpertRouter
from core.module_executor import ModuleExecutor

# åˆå§‹åŒ–ç»„ä»¶
orchestrator = get_workflow_orchestrator()
rag_service = RAGServiceAdapter()
expert_router = ExpertRouter()
module_executor = ModuleExecutor()

# è·å–å·¥ä½œæµå¼•æ“
engine = get_dual_loop_workflow_engine(
    workflow_orchestrator=orchestrator,
    rag_service=rag_service,
    expert_router=expert_router,
    module_executor=module_executor,
)

# æ‰§è¡Œæ™ºèƒ½çº¿å·¥ä½œæµ
result = await engine.execute_intelligent_workflow(
    user_input="åˆ†ææœ¬æœˆé”€å”®è¶‹åŠ¿",
    context={},
)

print(f"å·¥ä½œæµID: {result.workflow_id}")
print(f"å“åº”: {result.response}")
print(f"æ€»æ—¶é•¿: {result.total_duration}ç§’")
```

## ğŸ“ æ–‡ä»¶æ¸…å•

1. **æ ¸å¿ƒå¼•æ“**:
   - `core/dual_loop_workflow_engine.py` - åŒçº¿é—­ç¯å·¥ä½œæµå¼•æ“
   - `core/workflow_orchestrator.py` - å·¥ä½œæµç¼–æ’å™¨ï¼ˆå·²å­˜åœ¨ï¼Œå·²ä¿®å¤ï¼‰

2. **APIæ¥å£**:
   - `api/workflow_api.py` - å·¥ä½œæµAPIæ¥å£

3. **é›†æˆ**:
   - `api/main.py` - ä¸»åº”ç”¨ï¼ˆå·²æ³¨å†Œå·¥ä½œæµè·¯ç”±ï¼‰

## âœ… å®ŒæˆçŠ¶æ€

- [x] è®¾è®¡åŒçº¿é—­ç¯å·¥ä½œæµæ•°æ®ç»“æ„
- [x] å®ç°å·¥ä½œæµæ ¸å¿ƒå¼•æ“
- [x] å®ç°RAGèŠ‚ç‚¹å¤„ç†å™¨
- [x] å®ç°ä¸“å®¶èŠ‚ç‚¹å¤„ç†å™¨
- [x] å®ç°æ¨¡å—èŠ‚ç‚¹å¤„ç†å™¨
- [x] å®ç°å·¥ä½œæµçŠ¶æ€ç®¡ç†å’Œè¿½è¸ª
- [x] åˆ›å»ºå·¥ä½œæµAPIæ¥å£
- [x] é›†æˆåˆ°ä¸»åº”ç”¨

## ğŸš€ ä¸‹ä¸€æ­¥

1. **2.2 å¯è§‚æµ‹æ€§å¢å¼º**: æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ã€æŒ‡æ ‡å’Œé“¾è·¯è¿½è¸ª
2. **2.3 ä¸»ç•Œé¢å‘ˆç°**: åœ¨ä¸»ç•Œé¢ä¸Šå‘ˆç°å·¥ä½œæµå®æ—¶çŠ¶æ€ï¼ˆæ™ºèƒ½çº¿ & ç›´æ¥æ“ä½œçº¿ï¼‰

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **RAGä¸“å®¶ç³»ç»Ÿ**: ä¸ºå¯é€‰ä¾èµ–ï¼Œå¦‚æœå¯¼å…¥å¤±è´¥ä¼šä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬
2. **æ—¥å¿—ç›®å½•**: é»˜è®¤ä½¿ç”¨ `logs/workflow/`ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡ `WORKFLOW_LOG_DIR` é…ç½®
3. **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ­¥éª¤éƒ½æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
4. **å¼‚æ­¥æ‰§è¡Œ**: æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ”¯æŒé«˜å¹¶å‘

