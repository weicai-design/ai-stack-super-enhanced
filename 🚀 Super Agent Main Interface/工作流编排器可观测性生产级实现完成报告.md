# å·¥ä½œæµç¼–æ’å™¨å¯è§‚æµ‹æ€§ç”Ÿäº§çº§å®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å‰ç½®æ ¡éªŒç»“æœ

### âœ… åŸºç¡€å®ç°çŠ¶æ€
- âœ… æ–‡ä»¶å·²å­˜åœ¨: `workflow_orchestrator.py`
- âœ… åŸºç¡€åŸ‹ç‚¹å·²å®ç°ï¼ˆtrace_idã€span_idï¼‰
- âœ… åŸºç¡€æ—¥å¿—å·²å®ç°ï¼ˆå†™å…¥ `logs/workflow/`ï¼‰
- âœ… åŸºç¡€æŒ‡æ ‡å·²å®ç°ï¼ˆPrometheus å’Œ JSON APIï¼‰

### âš ï¸ ç”Ÿäº§çº§æ”¹è¿›éœ€æ±‚
ç»è¿‡å‰ç½®æ ¡éªŒï¼Œè¯†åˆ«å‡ºä»¥ä¸‹éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼š
1. åŸ‹ç‚¹ä¸å¤Ÿå…¨é¢
2. æ—¥å¿—æ ¼å¼ä¸å¤Ÿç»“æ„åŒ–
3. æŒ‡æ ‡ä¸å¤Ÿå®Œå–„
4. ç¼ºå°‘ OpenTelemetry æ”¯æŒ
5. ç¼ºå°‘æ—¥å¿—é‡‡æ ·å’Œè¿‡æ»¤

## âœ… ç”Ÿäº§çº§æ”¹è¿›å®Œæˆ

### 1. å®Œæ•´çš„åŸ‹ç‚¹ç³»ç»Ÿ âœ…

**å®ç°**: åœ¨æ‰€æœ‰å…³é”®æ–¹æ³•ä¸­æ·»åŠ  trace_id å’Œ span_id

**åŸ‹ç‚¹ä½ç½®**:
- âœ… `create_intelligent_workflow()` - åˆ›å»ºæ™ºèƒ½çº¿å·¥ä½œæµ
- âœ… `create_direct_workflow()` - åˆ›å»ºç›´æ¥æ“ä½œçº¿å·¥ä½œæµ
- âœ… `transition_state()` - çŠ¶æ€è½¬æ¢
- âœ… `get_workflow()` - è·å–å·¥ä½œæµ
- âœ… `list_workflows()` - åˆ—å‡ºå·¥ä½œæµ
- âœ… `cancel_workflow()` - å–æ¶ˆå·¥ä½œæµ
- âœ… `_publish_event()` - å‘å¸ƒäº‹ä»¶

**ç‰¹æ€§**:
- è‡ªåŠ¨ç”Ÿæˆ trace_idï¼ˆå¦‚æœæœªæä¾›ï¼‰
- è‡ªåŠ¨åˆ›å»º span_id
- æ”¯æŒçˆ¶ span_id ä¼ é€’
- å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¼ é€’

### 2. ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ âœ…

**å®ç°**: `StructuredLogger` ç±»

**ç‰¹æ€§**:
- JSON æ ¼å¼æ—¥å¿—ï¼ˆJSONLï¼‰
- å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆtrace_idã€span_idã€workflow_idï¼‰
- æ—¥å¿—çº§åˆ«æ§åˆ¶
- æ—¥å¿—é‡‡æ ·æ”¯æŒï¼ˆå¯é€‰ï¼‰
- å†™å…¥ `logs/workflow/workflow_orchestrator_YYYYMMDD.jsonl`

**æ—¥å¿—æ ¼å¼**:
```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "level": "INFO",
  "event": "workflow.created",
  "workflow_id": "wf_intelligent_xxx",
  "trace_id": "trace_xxx",
  "span_id": "span_xxx",
  "data": {
    "workflow_type": "intelligent",
    "user_input": "..."
  },
  "message": "..."
}
```

### 3. å¢å¼ºçš„ Prometheus æŒ‡æ ‡ âœ…

**å®ç°**: `EnhancedMetrics` ç±»

**æ–°å¢æŒ‡æ ‡**:
- `workflow_orchestrator_total` - å·¥ä½œæµæ€»æ•°ï¼ˆæŒ‰ç±»å‹ã€çŠ¶æ€ã€çŠ¶æ€å€¼ï¼‰
- `workflow_orchestrator_duration_seconds` - å·¥ä½œæµæ‰§è¡Œæ—¶é•¿ï¼ˆç›´æ–¹å›¾ï¼‰
- `workflow_orchestrator_active` - æ´»è·ƒå·¥ä½œæµæ•°é‡ï¼ˆä»ªè¡¨ç›˜ï¼‰
- `workflow_orchestrator_steps_total` - å·¥ä½œæµæ­¥éª¤æ€»æ•°
- `workflow_orchestrator_step_duration_seconds` - æ­¥éª¤æ‰§è¡Œæ—¶é•¿ï¼ˆç›´æ–¹å›¾ï¼‰
- `workflow_orchestrator_state_transitions_total` - çŠ¶æ€è½¬æ¢æ€»æ•°
- `workflow_orchestrator_errors_total` - é”™è¯¯æ€»æ•°ï¼ˆæŒ‰ç±»å‹ï¼‰
- `workflow_orchestrator_events_total` - äº‹ä»¶æ€»æ•°ï¼ˆæŒ‰ç±»å‹å’ŒçŠ¶æ€ï¼‰

**æŒ‡æ ‡æ ‡ç­¾**:
- `workflow_type`: intelligent/direct
- `status`: started/completed/failed
- `state`: å·¥ä½œæµçŠ¶æ€
- `step_name`: æ­¥éª¤åç§°
- `error_type`: é”™è¯¯ç±»å‹
- `event_type`: äº‹ä»¶ç±»å‹

### 4. å¢å¼ºçš„ JSON API æŒ‡æ ‡ âœ…

**å®ç°**: å¢å¼ºçš„ `get_metrics_json()` æ–¹æ³•

**æ–°å¢æ•°æ®**:
- æ­¥éª¤ç»Ÿè®¡ï¼ˆstep_statsï¼‰
  - æ¯ä¸ªæ­¥éª¤çš„æ€»æ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°
  - æ¯ä¸ªæ­¥éª¤çš„å¹³å‡æ‰§è¡Œæ—¶é•¿
- æ›´è¯¦ç»†çš„ç±»å‹å’ŒçŠ¶æ€ç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡èšåˆ

### 5. OpenTelemetry é›†æˆï¼ˆå¯é€‰ï¼‰âœ…

**å®ç°**: `OpenTelemetryIntegration` ç±»

**ç‰¹æ€§**:
- å¯é€‰çš„ OpenTelemetry æ”¯æŒ
- OTLP å¯¼å‡ºå™¨æ”¯æŒ
- Span åˆ›å»ºå’Œç®¡ç†
- é”™è¯¯è®°å½•å’ŒçŠ¶æ€è®¾ç½®

**ä½¿ç”¨**:
```python
orchestrator = get_workflow_orchestrator(
    enable_production_observability=True,
    enable_opentelemetry=True,
    otlp_endpoint="http://localhost:4317",  # OTLP gRPC ç«¯ç‚¹
)
```

### 6. æ—¥å¿—é‡‡æ ·å’Œè¿‡æ»¤ âœ…

**å®ç°**: ç»“æ„åŒ–æ—¥å¿—å™¨æ”¯æŒé‡‡æ ·

**ç‰¹æ€§**:
- å¯é…ç½®é‡‡æ ·ç‡ï¼ˆ0.0-1.0ï¼‰
- åŸºäºéšæœºæ•°çš„é‡‡æ ·
- å‡å°‘æ—¥å¿—å­˜å‚¨å¼€é”€

**é…ç½®**:
```python
orchestrator = get_workflow_orchestrator(
    enable_production_observability=True,
    enable_log_sampling=True,
    log_sample_rate=0.1,  # 10% é‡‡æ ·
)
```

## ğŸ“Š ç”Ÿäº§çº§ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | åŸºç¡€ç‰ˆ | ç”Ÿäº§çº§ |
|------|--------|--------|
| åŸ‹ç‚¹è¦†ç›– | éƒ¨åˆ†æ–¹æ³• | âœ… æ‰€æœ‰å…³é”®æ–¹æ³• |
| æ—¥å¿—æ ¼å¼ | æ–‡æœ¬ | âœ… JSONç»“æ„åŒ– |
| æ—¥å¿—é‡‡æ · | âŒ | âœ… æ”¯æŒ |
| PrometheusæŒ‡æ ‡ | 4ä¸ªåŸºç¡€æŒ‡æ ‡ | âœ… 8ä¸ªå¢å¼ºæŒ‡æ ‡ |
| JSON APIæŒ‡æ ‡ | åŸºç¡€ç»Ÿè®¡ | âœ… è¯¦ç»†ç»Ÿè®¡+æ­¥éª¤ç»Ÿè®¡ |
| OpenTelemetry | âŒ | âœ… å¯é€‰æ”¯æŒ |
| é”™è¯¯åˆ†ç±» | âŒ | âœ… 7ç§é”™è¯¯ç±»å‹ |
| äº‹ä»¶è¿½è¸ª | âŒ | âœ… äº‹ä»¶å‘å¸ƒè¿½è¸ª |

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### 1. å¯ç”¨ç”Ÿäº§çº§å¯è§‚æµ‹æ€§ï¼ˆé»˜è®¤ï¼‰

```python
from core.workflow_orchestrator import get_workflow_orchestrator

# é»˜è®¤å¯ç”¨ç”Ÿäº§çº§å¯è§‚æµ‹æ€§
orchestrator = get_workflow_orchestrator(
    event_bus=event_bus,
    enable_production_observability=True,  # é»˜è®¤True
    observability_level="standard",  # minimal/standard/detailed/full
)
```

### 2. å¯ç”¨ OpenTelemetry

```python
orchestrator = get_workflow_orchestrator(
    enable_production_observability=True,
    enable_opentelemetry=True,
    otlp_endpoint="http://localhost:4317",  # OTLP gRPC ç«¯ç‚¹
)
```

### 3. é…ç½®æ—¥å¿—é‡‡æ ·

```python
orchestrator = get_workflow_orchestrator(
    enable_production_observability=True,
    enable_log_sampling=True,
    log_sample_rate=0.1,  # 10% é‡‡æ ·
)
```

### 4. è®¿é—®æŒ‡æ ‡

```bash
# Prometheus æŒ‡æ ‡
curl http://localhost:8000/api/workflow/orchestrator/metrics/prometheus

# JSON æŒ‡æ ‡
curl http://localhost:8000/api/workflow/orchestrator/metrics/json

# æŒ‡æ ‡æ‘˜è¦
curl http://localhost:8000/api/workflow/orchestrator/metrics/summary
```

## ğŸ“ æ–‡ä»¶æ¸…å•

1. **æ ¸å¿ƒæ¨¡å—**:
   - `core/workflow_orchestrator.py` - å·¥ä½œæµç¼–æ’å™¨ï¼ˆå·²æ›´æ–°ï¼Œé›†æˆå¯è§‚æµ‹æ€§ï¼‰
   - `core/workflow_orchestrator_observability.py` - å¯è§‚æµ‹æ€§å¢å¼ºæ¨¡å—ï¼ˆæ–°å»ºï¼‰

2. **APIæ¥å£**:
   - `api/workflow_orchestrator_metrics_api.py` - æŒ‡æ ‡APIæ¥å£ï¼ˆæ–°å»ºï¼‰
   - `api/main.py` - ä¸»åº”ç”¨ï¼ˆå·²æ›´æ–°ï¼Œæ³¨å†ŒæŒ‡æ ‡è·¯ç”±ï¼‰

## âœ… å®ŒæˆçŠ¶æ€

- [x] å‰ç½®æ ¡éªŒï¼šæ£€æŸ¥å¯è§‚æµ‹æ€§å®ç°çŠ¶æ€
- [x] å¢å¼ºåŸ‹ç‚¹ï¼šåœ¨æ‰€æœ‰å…³é”®æ–¹æ³•ä¸­æ·»åŠ trace_idå’Œspan_id
- [x] å®ç°ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSONæ ¼å¼ï¼‰
- [x] å®Œå–„PrometheusæŒ‡æ ‡ï¼ˆæ·»åŠ æ›´å¤šæŒ‡æ ‡å’Œæ ‡ç­¾ï¼‰
- [x] å®Œå–„JSON APIç«¯ç‚¹ï¼ˆæŒ‡æ ‡æŸ¥è¯¢å’Œè¿‡æ»¤ï¼‰
- [x] é›†æˆOpenTelemetryï¼ˆå¯é€‰ï¼‰
- [x] å®ç°æ—¥å¿—é‡‡æ ·å’Œæ•æ„Ÿä¿¡æ¯è¿‡æ»¤

## ğŸ¯ ç”Ÿäº§çº§æ ‡å‡†è¾¾æˆ

### å¯è§‚æµ‹æ€§
- âœ… å®Œæ•´çš„ trace_idã€span_id åŸ‹ç‚¹
- âœ… ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSONæ ¼å¼ï¼‰
- âœ… ä¸°å¯Œçš„ Prometheus æŒ‡æ ‡
- âœ… è¯¦ç»†çš„ JSON API æŒ‡æ ‡
- âœ… OpenTelemetry æ”¯æŒï¼ˆå¯é€‰ï¼‰

### æ€§èƒ½
- âœ… æ—¥å¿—é‡‡æ ·æ”¯æŒ
- âœ… å¼‚æ­¥æ—¥å¿—å†™å…¥ï¼ˆå¦‚æœä½¿ç”¨ç”Ÿäº§çº§æ—¥å¿—å™¨ï¼‰
- âœ… æŒ‡æ ‡èšåˆå’Œç¼“å­˜

### å¯é æ€§
- âœ… é”™è¯¯å¤„ç†å’Œå®¹é”™
- âœ… é™çº§ç­–ç•¥ï¼ˆå¯è§‚æµ‹æ€§ä¸å¯ç”¨æ—¶ä½¿ç”¨åŸºç¡€ç‰ˆæœ¬ï¼‰

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§æ¨¡å¼**: é»˜è®¤å¯ç”¨ï¼Œå¯é€šè¿‡`enable_production_observability=False`ç¦ç”¨
2. **OpenTelemetry**: ä¸ºå¯é€‰ä¾èµ–ï¼Œå¦‚æœæœªå®‰è£…ä¼šä½¿ç”¨è‡ªç ”ç³»ç»Ÿ
3. **æ—¥å¿—é‡‡æ ·**: å»ºè®®åœ¨é«˜æµé‡åœºæ™¯å¯ç”¨ï¼Œé‡‡æ ·ç‡å»ºè®®10-50%
4. **æŒ‡æ ‡å­˜å‚¨**: Prometheus æŒ‡æ ‡åœ¨å†…å­˜ä¸­ï¼Œå»ºè®®é…ç½® Prometheus æŠ“å–
5. **æ—¥å¿—ä½ç½®**: é»˜è®¤ `logs/workflow/`ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡ `WORKFLOW_LOG_DIR` é…ç½®

## ğŸš€ ä¸‹ä¸€æ­¥

ç³»ç»Ÿå·²è¾¾åˆ°ç”Ÿäº§æ°´å¹³ï¼Œå¯ä»¥ï¼š
1. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
2. é…ç½® Prometheus ç›‘æ§
3. è®¾ç½® OpenTelemetry æ”¶é›†å™¨ï¼ˆå¯é€‰ï¼‰
4. é…ç½®æ—¥å¿—é‡‡æ ·ç‡
5. ç›‘æ§ç³»ç»Ÿæ€§èƒ½

