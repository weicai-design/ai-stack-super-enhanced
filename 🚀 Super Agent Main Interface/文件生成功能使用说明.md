# 文件生成功能使用说明

**完成时间**: 2025-01-XX  
**状态**: ✅ 最小可用集已完成

---

## 🎯 功能概述

文件生成最小可用集已实现，支持生成 **DOCX/XLSX/PPTX/PDF** 四种格式的文件，并与 RAG 知识库和内容创作模块打通。

---

## ✅ 已完成功能

### 1. 文件生成核心功能

#### 1.1 Word文档生成 (DOCX)
- ✅ 支持 Markdown 格式内容
- ✅ 支持标题、段落、列表
- ✅ 自动保存到 RAG 知识库
- ✅ 备用方案：HTML 格式（当 python-docx 未安装时）

#### 1.2 Excel表格生成 (XLSX)
- ✅ 支持表头和数据行
- ✅ 自动调整列宽
- ✅ 表格数据自动转换为文本保存到 RAG
- ✅ 备用方案：CSV 格式（当 openpyxl 未安装时）

#### 1.3 PPT演示文稿生成 (PPTX)
- ✅ 支持多幻灯片
- ✅ 支持标题、内容、要点列表
- ✅ 幻灯片内容自动转换为文本保存到 RAG
- ✅ 备用方案：HTML 格式（当 python-pptx 未安装时）

#### 1.4 PDF文档生成 (PDF)
- ✅ 支持 HTML/Markdown 转 PDF
- ✅ 优先使用 weasyprint，备用 reportlab
- ✅ 自动保存到 RAG 知识库
- ✅ 备用方案：HTML 格式（当 PDF 库未安装时）

---

### 2. RAG 知识库集成

#### 2.1 自动保存功能
- ✅ 生成的文件内容自动保存到 RAG 知识库
- ✅ 保存文件元数据（格式、大小、生成时间等）
- ✅ 失败时仅记录警告，不影响文件生成

#### 2.2 保存内容格式
- **Word/PDF**: 直接保存文本内容
- **Excel**: 表格数据转换为文本格式
- **PPT**: 幻灯片内容转换为文本格式

---

### 3. 内容创作模块集成

#### 3.1 内容导出接口
- ✅ 新增 `/api/super-agent/content/export` 接口
- ✅ 支持从内容模块导出为 DOCX/XLSX/PPTX/PDF
- ✅ 支持通过 content_id 获取内容
- ✅ 支持直接传入 content_data

---

## 📡 API 接口

### 1. 生成文件接口

**端点**: `POST /api/super-agent/generate/file`

**参数**:
```json
{
  "file_type": "word|excel|ppt|pdf",
  "content": "文件内容（文本或JSON格式）",
  "template": "模板名称（可选）",
  "title": "文档标题（可选）",
  "output_path": "输出路径（可选）",
  "save_to_rag": true  // 是否自动保存到RAG（默认true）
}
```

**示例 - Word文档**:
```bash
curl -X POST "http://localhost:8000/api/super-agent/generate/file" \
  -H "Content-Type: application/json" \
  -d '{
    "file_type": "word",
    "content": "# 标题\n\n这是文档内容。",
    "title": "测试文档"
  }'
```

**示例 - Excel表格**:
```bash
curl -X POST "http://localhost:8000/api/super-agent/generate/file" \
  -H "Content-Type: application/json" \
  -d '{
    "file_type": "excel",
    "content": "{\"headers\": [\"姓名\", \"年龄\"], \"data\": [[\"张三\", 25], [\"李四\", 30]]}"
  }'
```

**示例 - PPT演示文稿**:
```bash
curl -X POST "http://localhost:8000/api/super-agent/generate/file" \
  -H "Content-Type: application/json" \
  -d '{
    "file_type": "ppt",
    "content": "{\"slides\": [{\"title\": \"第一页\", \"content\": \"内容\", \"bullet_points\": [\"要点1\", \"要点2\"]}]}"
  }'
```

**响应格式**:
```json
{
  "success": true,
  "file_data_base64": "base64编码的文件数据",
  "format": "docx",
  "filename": "document_20250101_120000.docx",
  "size": 12345,
  "timestamp": "2025-01-01T12:00:00"
}
```

---

### 2. 内容导出接口

**端点**: `POST /api/super-agent/content/export`

**参数**:
```json
{
  "content_id": "内容ID（可选）",
  "content_data": {
    "title": "标题",
    "content": "内容",
    "tags": ["标签1", "标签2"]
  },
  "file_type": "docx|xlsx|pptx|pdf",
  "output_path": "输出路径（可选）"
}
```

**示例**:
```bash
curl -X POST "http://localhost:8000/api/super-agent/content/export" \
  -H "Content-Type: application/json" \
  -d '{
    "content_data": {
      "title": "AI技术趋势",
      "content": "人工智能正在快速发展...",
      "tags": ["AI", "技术"]
    },
    "file_type": "docx"
  }'
```

---

## 🔧 依赖库

### 必需库
- `openpyxl` - Excel 生成（已在 ERP 模块中使用）

### 可选库（推荐安装）
- `python-docx` - Word 文档生成
- `python-pptx` - PPT 演示文稿生成
- `weasyprint` - PDF 生成（推荐）
- `reportlab` - PDF 生成（备用）

### 安装命令
```bash
pip install python-docx python-pptx weasyprint reportlab
```

**注意**: 如果未安装可选库，系统会自动使用备用方案（HTML/CSV 格式）。

---

## 🔄 工作流程

### 文件生成流程
```
1. 用户请求生成文件
   ↓
2. 解析内容格式（文本/JSON）
   ↓
3. 调用对应的生成方法
   ↓
4. 生成文件（内存中）
   ↓
5. 自动保存到 RAG 知识库（可选）
   ↓
6. 返回 base64 编码的文件数据
```

### RAG 集成流程
```
1. 文件生成成功
   ↓
2. 提取文件文本内容
   ↓
3. 构造文档元数据
   ↓
4. 调用 RAG 服务保存
   ↓
5. 记录保存结果（成功/失败）
```

---

## 📝 使用示例

### Python 示例
```python
import requests
import base64

# 生成 Word 文档
response = requests.post(
    "http://localhost:8000/api/super-agent/generate/file",
    json={
        "file_type": "word",
        "content": "# 我的文档\n\n这是内容。",
        "title": "测试文档"
    }
)

result = response.json()
if result["success"]:
    # 解码并保存文件
    file_data = base64.b64decode(result["file_data_base64"])
    with open(result["filename"], "wb") as f:
        f.write(file_data)
    print(f"文件已生成: {result['filename']}")
```

### JavaScript 示例
```javascript
// 生成 PDF 文档
fetch('http://localhost:8000/api/super-agent/generate/file', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    file_type: 'pdf',
    content: '# 标题\n\n内容',
    title: '测试PDF'
  })
})
.then(res => res.json())
.then(result => {
  if (result.success) {
    // 下载文件
    const blob = new Blob(
      [Uint8Array.from(atob(result.file_data_base64), c => c.charCodeAt(0))],
      { type: 'application/pdf' }
    );
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = result.filename;
    a.click();
  }
});
```

---

## ⚠️ 注意事项

1. **库依赖**: 建议安装所有可选库以获得最佳体验
2. **RAG 保存**: 如果 RAG 服务不可用，文件生成仍会成功，但会记录警告
3. **文件大小**: 大文件建议使用流式传输（当前版本返回 base64）
4. **内容格式**: Excel 和 PPT 需要 JSON 格式的内容
5. **备用方案**: 未安装库时会自动使用 HTML/CSV 格式

---

## 🚀 后续优化方向

- [ ] 支持文件模板
- [ ] 支持图片插入
- [ ] 支持样式自定义
- [ ] 流式文件传输
- [ ] 批量文件生成
- [ ] 文件预览功能

---

## 📞 技术支持

如有问题，请查看：
- API 文档: `/api/super-agent/docs`
- 日志文件: 查看系统日志
- RAG 集成: 检查 RAG 服务状态

---

**版本**: v1.0.0  
**最后更新**: 2025-01-XX

