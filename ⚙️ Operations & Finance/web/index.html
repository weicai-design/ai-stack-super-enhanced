<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>运营财务管理 - AI-STACK</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #303133;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #67c23a;
        }
        
        .status-dot.disconnected {
            background: #f56c6c;
        }
        
        .tabs {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .content-area {
            margin-top: 20px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #909399;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #303133;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            margin-bottom: 20px;
            color: #303133;
        }
        
        .chart {
            width: 100%;
            height: 400px;
        }
        
        .anomalies-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        
        .anomaly-item {
            padding: 15px;
            border-left: 4px solid #f56c6c;
            background: #fef0f0;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .anomaly-item.medium {
            border-left-color: #e6a23c;
            background: #fdf6ec;
        }
        
        .anomaly-item.low {
            border-left-color: #409eff;
            background: #ecf5ff;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- 头部 -->
            <div class="header">
                <h1>⚙️ 运营财务管理</h1>
                <p style="color: #909399;">制造型企业全流程分析与财务管理</p>
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-dot" :class="{disconnected: !erpConnected}"></span>
                        <span>ERP连接: {{ erpConnected ? '已连接' : '未连接' }}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-dot" :class="{disconnected: !listening}"></span>
                        <span>数据监听: {{ listening ? '监听中' : '未监听' }}</span>
                    </div>
                    <el-button size="small" @click="syncData" :loading="syncing">同步数据</el-button>
                </div>
            </div>
            
            <!-- 标签页 -->
            <div class="tabs">
                <el-tabs v-model="activeTab" @tab-change="handleTabChange">
                    <el-tab-pane label="运营分析" name="operations">
                        <div class="content-area">
                            <!-- 统计卡片 -->
                            <div class="stats-cards">
                                <div class="stat-card">
                                    <h3>订单总数</h3>
                                    <div class="value">{{ flowAnalysis.orders?.total || 0 }}</div>
                                </div>
                                <div class="stat-card">
                                    <h3>进行中订单</h3>
                                    <div class="value">{{ flowAnalysis.orders?.in_progress || 0 }}</div>
                                </div>
                                <div class="stat-card">
                                    <h3>已完成订单</h3>
                                    <div class="value">{{ flowAnalysis.orders?.completed || 0 }}</div>
                                </div>
                                <div class="stat-card">
                                    <h3>流程效率</h3>
                                    <div class="value">{{ flowAnalysis.flow_efficiency?.total_flow_efficiency || '良好' }}</div>
                                </div>
                            </div>
                            
                            <!-- 关键指标 -->
                            <div class="chart-container">
                                <h3>关键指标</h3>
                                <div class="chart" ref="metricsChart"></div>
                            </div>
                            
                            <!-- 异常预警 -->
                            <div class="anomalies-list" v-if="flowAnalysis.anomalies && flowAnalysis.anomalies.length > 0">
                                <h3 style="margin-bottom: 15px;">异常预警</h3>
                                <div 
                                    v-for="(anomaly, index) in flowAnalysis.anomalies" 
                                    :key="index"
                                    class="anomaly-item"
                                    :class="anomaly.severity"
                                >
                                    <strong>{{ anomaly.type }}</strong>
                                    <p>{{ anomaly.description }}</p>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                    
                    <el-tab-pane label="财务管理" name="finance">
                        <div class="content-area">
                            <!-- 价格分析 -->
                            <div class="chart-container">
                                <h3>价格趋势分析⭐深化版</h3>
                                <el-form :inline="true" style="margin-bottom: 20px;">
                                    <el-form-item label="产品ID">
                                        <el-input-number v-model="priceProductId" :min="1" placeholder="可选" />
                                    </el-form-item>
                                    <el-form-item label="周期">
                                        <el-select v-model="pricePeriod">
                                            <el-option label="7天" value="7d" />
                                            <el-option label="30天" value="30d" />
                                            <el-option label="90天" value="90d" />
                                            <el-option label="1年" value="1y" />
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="primary" @click="analyzePriceTrend">分析</el-button>
                                    </el-form-item>
                                </el-form>
                                <div class="chart" ref="priceChart"></div>
                                
                                <!-- 价格分析详细结果 -->
                                <div v-if="priceAnalysisResult" style="margin-top: 20px;">
                                    <el-card>
                                        <h4>分析结果</h4>
                                        <el-descriptions :column="2" border>
                                            <el-descriptions-item label="趋势方向">{{ priceAnalysisResult.trend }}</el-descriptions-item>
                                            <el-descriptions-item label="趋势强度">{{ priceAnalysisResult.trend_strength }}</el-descriptions-item>
                                            <el-descriptions-item label="平均价格">¥{{ priceAnalysisResult.average_price }}</el-descriptions-item>
                                            <el-descriptions-item label="当前价格">¥{{ priceAnalysisResult.current_price }}</el-descriptions-item>
                                            <el-descriptions-item label="价格范围">¥{{ priceAnalysisResult.price_range?.min }} - ¥{{ priceAnalysisResult.price_range?.max }}</el-descriptions-item>
                                            <el-descriptions-item label="波动性">{{ priceAnalysisResult.volatility_level }}</el-descriptions-item>
                                        </el-descriptions>
                                        
                                        <div v-if="priceAnalysisResult.anomalies && priceAnalysisResult.anomalies.length > 0" style="margin-top: 15px;">
                                            <el-alert 
                                                :title="`检测到${priceAnalysisResult.anomalies.length}个价格异常`" 
                                                type="warning" 
                                                :closable="false"
                                            >
                                                <ul>
                                                    <li v-for="(anomaly, idx) in priceAnalysisResult.anomalies" :key="idx">
                                                        {{ anomaly.date }}: ¥{{ anomaly.price }} ({{ anomaly.type }})
                                                    </li>
                                                </ul>
                                            </el-alert>
                                        </div>
                                        
                                        <div v-if="priceAnalysisResult.recommendations && priceAnalysisResult.recommendations.length > 0" style="margin-top: 15px;">
                                            <h5>建议：</h5>
                                            <ul>
                                                <li v-for="(rec, idx) in priceAnalysisResult.recommendations" :key="idx">{{ rec }}</li>
                                            </ul>
                                        </div>
                                    </el-card>
                                </div>
                            </div>
                            
                            <!-- 工时分析 -->
                            <div class="chart-container">
                                <h3>工时分析⭐深化版</h3>
                                <el-form :inline="true" style="margin-bottom: 20px;">
                                    <el-form-item label="项目ID">
                                        <el-input-number v-model="workHoursProjectId" :min="1" placeholder="可选" />
                                    </el-form-item>
                                    <el-form-item label="周期">
                                        <el-select v-model="workHoursPeriod">
                                            <el-option label="7天" value="7d" />
                                            <el-option label="30天" value="30d" />
                                            <el-option label="90天" value="90d" />
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="primary" @click="analyzeWorkHours">分析</el-button>
                                    </el-form-item>
                                </el-form>
                                <div class="chart" ref="workHoursChart"></div>
                                
                                <!-- 工时分析详细结果 -->
                                <div v-if="workHoursAnalysisResult" style="margin-top: 20px;">
                                    <el-card>
                                        <h4>分析结果</h4>
                                        <el-descriptions :column="2" border>
                                            <el-descriptions-item label="总工时">{{ workHoursAnalysisResult.total_hours }}小时</el-descriptions-item>
                                            <el-descriptions-item label="日均工时">{{ workHoursAnalysisResult.average_daily }}小时</el-descriptions-item>
                                            <el-descriptions-item label="效率">{{ workHoursAnalysisResult.efficiency?.level || '未知' }}</el-descriptions-item>
                                            <el-descriptions-item label="效率值">{{ workHoursAnalysisResult.efficiency?.efficiency || 0 }}</el-descriptions-item>
                                            <el-descriptions-item label="总成本">¥{{ workHoursAnalysisResult.cost_analysis?.total_cost || 0 }}</el-descriptions-item>
                                            <el-descriptions-item label="资源利用率">{{ (workHoursAnalysisResult.resource_utilization?.utilization * 100 || 0).toFixed(2) }}%</el-descriptions-item>
                                        </el-descriptions>
                                        
                                        <div v-if="workHoursAnalysisResult.anomalies && workHoursAnalysisResult.anomalies.length > 0" style="margin-top: 15px;">
                                            <el-alert 
                                                :title="`检测到${workHoursAnalysisResult.anomalies.length}个工时异常`" 
                                                type="warning" 
                                                :closable="false"
                                            >
                                                <ul>
                                                    <li v-for="(anomaly, idx) in workHoursAnalysisResult.anomalies" :key="idx">
                                                        {{ anomaly.date }}: {{ anomaly.hours }}小时 ({{ anomaly.type }})
                                                    </li>
                                                </ul>
                                            </el-alert>
                                        </div>
                                        
                                        <div v-if="workHoursAnalysisResult.recommendations && workHoursAnalysisResult.recommendations.length > 0" style="margin-top: 15px;">
                                            <h5>建议：</h5>
                                            <ul>
                                                <li v-for="(rec, idx) in workHoursAnalysisResult.recommendations" :key="idx">{{ rec }}</li>
                                            </ul>
                                        </div>
                                    </el-card>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
        </div>
    </div>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;
        
        createApp({
            data() {
                return {
                    activeTab: 'operations',
                    erpConnected: false,
                    listening: false,
                    syncing: false,
                    flowAnalysis: {},
                    priceProductId: null,
                    pricePeriod: '30d',
                    workHoursProjectId: null,
                    workHoursPeriod: '30d',
                    metricsChart: null,
                    priceChart: null,
                    workHoursChart: null,
                    priceAnalysisResult: null,
                    workHoursAnalysisResult: null
                };
            },
            mounted() {
                this.checkStatus();
                this.loadFlowAnalysis();
                this.initCharts();
                
                // 定时刷新
                setInterval(() => {
                    this.checkStatus();
                    if (this.activeTab === 'operations') {
                        this.loadFlowAnalysis();
                    }
                }, 30000); // 每30秒刷新
            },
            methods: {
                async checkStatus() {
                    try {
                        const response = await axios.get('/api/sync/status');
                        if (response.data.success) {
                            this.erpConnected = true;
                            this.listening = response.data.listening;
                        }
                    } catch (error) {
                        this.erpConnected = false;
                        this.listening = false;
                    }
                },
                
                async syncData() {
                    this.syncing = true;
                    try {
                        const response = await axios.post('/api/sync/erp');
                        if (response.data.success) {
                            ElMessage.success('数据同步成功');
                            await this.loadFlowAnalysis();
                        }
                    } catch (error) {
                        ElMessage.error('数据同步失败: ' + error.message);
                    } finally {
                        this.syncing = false;
                    }
                },
                
                async loadFlowAnalysis() {
                    try {
                        const response = await axios.get('/api/operations/manufacturing-flow');
                        if (response.data.success) {
                            this.flowAnalysis = response.data.analysis;
                            this.updateMetricsChart();
                        }
                    } catch (error) {
                        console.error('加载流程分析失败:', error);
                    }
                },
                
                async analyzePriceTrend() {
                    try {
                        const response = await axios.get('/api/finance/price/trend', {
                            params: {
                                product_id: this.priceProductId,
                                period: this.pricePeriod
                            }
                        });
                        if (response.data.success) {
                            this.priceAnalysisResult = response.data.trend;
                            this.updatePriceChart(response.data.trend);
                            ElMessage.success('价格分析完成');
                        }
                    } catch (error) {
                        ElMessage.error('价格分析失败: ' + error.message);
                    }
                },
                
                async analyzeWorkHours() {
                    try {
                        const response = await axios.get('/api/finance/work-hours/analyze', {
                            params: {
                                project_id: this.workHoursProjectId,
                                period: this.workHoursPeriod
                            }
                        });
                        if (response.data.success) {
                            this.workHoursAnalysisResult = response.data.analysis;
                            this.updateWorkHoursChart(response.data.analysis);
                            ElMessage.success('工时分析完成');
                        }
                    } catch (error) {
                        ElMessage.error('工时分析失败: ' + error.message);
                    }
                },
                
                initCharts() {
                    this.metricsChart = echarts.init(this.$refs.metricsChart);
                    this.priceChart = echarts.init(this.$refs.priceChart);
                    this.workHoursChart = echarts.init(this.$refs.workHoursChart);
                },
                
                updateMetricsChart() {
                    if (!this.metricsChart || !this.flowAnalysis.key_metrics) return;
                    
                    const metrics = this.flowAnalysis.key_metrics;
                    const option = {
                        title: { text: '关键指标', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        xAxis: {
                            type: 'category',
                            data: ['订单数', '订单金额', '交付数', '交付金额', '回款数', '回款金额']
                        },
                        yAxis: { type: 'value' },
                        series: [{
                            data: [
                                metrics.total_orders,
                                metrics.total_order_amount,
                                metrics.total_deliveries,
                                metrics.total_delivery_amount,
                                metrics.total_payments,
                                metrics.total_payment_amount
                            ],
                            type: 'bar',
                            itemStyle: { color: '#409eff' }
                        }]
                    };
                    this.metricsChart.setOption(option);
                },
                
                updatePriceChart(trend) {
                    if (!this.priceChart || !trend) return;
                    
                    // 显示详细的价格分析结果
                    const option = {
                        title: { 
                            text: `价格趋势分析 - ${trend.trend || '未知'}`, 
                            left: 'center',
                            subtext: `平均价格: ¥${trend.average_price || 0} | 波动性: ${trend.volatility_level || '未知'}`
                        },
                        tooltip: { trigger: 'axis' },
                        xAxis: { 
                            type: 'category', 
                            data: trend.price_history?.map(item => item.date?.substring(5, 10)) || ['1月', '2月', '3月', '4月', '5月', '6月']
                        },
                        yAxis: { 
                            type: 'value',
                            axisLabel: {
                                formatter: (value) => '¥' + value.toFixed(2)
                            }
                        },
                        series: [{
                            name: '价格',
                            data: trend.price_history?.map(item => item.price) || [100, 105, 102, 108, 110, 107],
                            type: 'line',
                            smooth: true,
                            itemStyle: { color: '#67c23a' },
                            markLine: {
                                data: [
                                    { yAxis: trend.average_price, name: '平均价格' },
                                    { yAxis: trend.price_range?.min, name: '最低价' },
                                    { yAxis: trend.price_range?.max, name: '最高价' }
                                ]
                            }
                        }]
                    };
                    this.priceChart.setOption(option);
                    
                    // 显示分析建议
                    if (trend.recommendations && trend.recommendations.length > 0) {
                        ElMessage.info({
                            message: `价格分析建议: ${trend.recommendations.join('; ')}`,
                            duration: 5000
                        });
                    }
                },
                
                updateWorkHoursChart(analysis) {
                    if (!this.workHoursChart || !analysis) return;
                    
                    // 显示详细的工时分析结果
                    const option = {
                        title: { 
                            text: `工时分析 - 效率: ${analysis.efficiency?.level || '未知'}`, 
                            left: 'center',
                            subtext: `总工时: ${analysis.total_hours || 0}小时 | 日均: ${analysis.average_daily || 0}小时`
                        },
                        tooltip: { trigger: 'axis' },
                        xAxis: { 
                            type: 'category', 
                            data: analysis.work_hours_data?.map(item => item.date?.substring(5, 10)) || ['项目1', '项目2', '项目3', '项目4']
                        },
                        yAxis: { 
                            type: 'value',
                            axisLabel: {
                                formatter: (value) => value + 'h'
                            }
                        },
                        series: [{
                            name: '工时',
                            data: analysis.work_hours_data?.map(item => item.hours) || [120, 150, 100, 130],
                            type: 'bar',
                            itemStyle: { color: '#e6a23c' },
                            markLine: {
                                data: [
                                    { yAxis: analysis.average_daily, name: '日均工时' },
                                    { yAxis: 8, name: '标准工时' }
                                ]
                            }
                        }]
                    };
                    this.workHoursChart.setOption(option);
                    
                    // 显示分析建议
                    if (analysis.recommendations && analysis.recommendations.length > 0) {
                        ElMessage.info({
                            message: `工时分析建议: ${analysis.recommendations.join('; ')}`,
                            duration: 5000
                        });
                    }
                },
                
                handleTabChange(tab) {
                    if (tab === 'finance') {
                        this.$nextTick(() => {
                            this.initCharts();
                        });
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>

