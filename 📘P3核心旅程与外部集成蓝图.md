# 📘 P3核心旅程与外部集成蓝图（2025-11-15）

## 1. 终端模拟器安全基线（已实施）
- **白名单 + 危险指令拦截**：仅允许 `ls/pwd/git/python/...` 等28个基础命令，自动拒绝 `&&`、`|`、`;`、重定向及 `rm -rf` 等危险片段。
- **资源沙箱**：工作目录被限制在 `/Users/ywc/ai-stack-super-enhanced` 内，输出按 `10,000` 字符/`400` 行截断，运行时间不超过 `30s`，并发 `<=2`。
- **环境隔离**：`API_KEY/SECRET/TOKEN` 等敏感环境变量不会注入到子进程。
- **可追溯性**：每条命令生成 `command_id`，记录执行耗时、返回码、错误信息，可直接写入 RAG 备忘。

> 下一步：将命令执行事件写入 `workflow_monitor`，并在主界面新增“终端安全看板”。

## 2. 智能任务系统旅程（用户→执行闭环）
| 阶段 | 触发方式 | 系统动作 | 可视化交付 |
| --- | --- | --- | --- |
| 1. 需求捕获 | 聊天输入、备忘录、自我学习提醒 | `memo_system` 调用 `task_templates` 做意图分类 | Chat 面板提醒 + 任务抽屉 |
| 2. 任务装配 | 用户确认、优先级设定 | `task_planning` 生成任务树（里程碑/依赖/专家模块） | 三级界面：甘特 + 看板 |
| 3. 执行编排 | `module_executor` 调度模块；记录 `workflow_monitor` | 并行调用 RAG/ERP/内容等模块 | 任务执行轨迹图 |
| 4. 状态回写 | 采集模块输出、异常、耗时 | `task_orchestrator`（计划新增）统一写回任务DB | 状态气泡、告警 |
| 5. 复盘 & 洞察 | 自我学习系统读取执行数据 | 生成“经验卡片/性能评分” | “智能建议”侧边栏 |

> 数据源：`tasks`（新增表） + `workflow_monitor` + `module_execution_log`；所有状态通过 WebSocket 推送至前端任务面板。

## 3. 自我学习 × 资源管理联动
1. **遥测采集**：`resource_monitor.py` + `psutil` 实时记录 CPU/内存/磁盘/外设状态，秒级写入 `resource_auto_adjuster`.
2. **事件标准化**：将资源异常、任务失败、命令超时等统一为 `LearningEvent`，字段包含 `source`, `severity`, `proposal`.
3. **策略生成**：`self_learning.py` 基于事件模式输出 3 类建议：
   - 参数调优（LLM温度、top_k、timeout）
   - 资源调节（降并发、释放缓存、暂停模块）
   - 任务回放（失败任务重试/拆解）
4. **用户确认**：主界面新增“智能建议”卡片 → 用户点击“接受/忽略” → 记录入 `learning_journal`.
5. **闭环验证**：建议执行后自动复测；结果写回 RAG 以供后续检索。

## 4. 示例工厂数据库（已生成 `data/demo_factory.db`）
- **覆盖链路**：`订单 → 项目 → 生产工位 → 采购 → 库存 → 质量事件 → 发运 → 现金流` 共 8 张表 + 1 个健康视图。
- **数据特点**：
  - 多优先级订单（星河半导体、天行汽车、蓝湾能源等）
  - 生产瓶颈、质量事件、物料在途、现金流收付
  - 可被 ERP/财务/运营/任务系统共享
- **使用方式**：
  1. `sqlite3 data/demo_factory.db "SELECT * FROM v_order_health"` 查看端到端状态。
  2. 后端模块通过 `sqlmodel/sqlite` 读取，封装在 `core/data_sources/factory.py`（待建）。
  3. 结合 `task_orchestrator` 自动推送“风险/机会任务”。

> 后续将提供数据重置脚本 + 单元测试夹具，保证每次迭代可稳定复刻。

## 5. 外部服务首选方案
### 内容创作模块
- **首选**：抖音开放平台（Content Publish API + Webhook 审核通知）
  - 用途：账号授权（OAuth2）、草稿上传、发布状态回调
  - 安全：本地仅存储 `refresh_token`，自动刷新并写入 `secrets/douyin.json`
  - Fallback：若网络受限，退回到“内容草稿 + 生成抖音上传脚本”的离线模式

### 股票量化模块
- **行情数据**：同花顺量化开放平台（WebSocket Level-1）+ TuShare Pro 作为历史数据备份
- **模拟交易**：统一适配器 `core/markets/broker_adapter.py`，默认连接同花顺模拟盘，暴露 `submit_order/cancel/order_status` 接口
- **日志**：所有行情/下单事件写入 `data/market_replay/{date}.jsonl`，便于自我学习系统复盘

> 已选数据源将写入 `.env.p3.example`，并在依赖清单中标注所需 SDK（tushare/thslquant）。

## 6. 下一步
1. 接入 `workflow_monitor`，把终端命令、任务状态、资源事件统一进监控。
2. 创建 `core/task_orchestrator.py` & `core/learning_events.py`，实现事件总线。
3. 构建 ERP/财务 API 层（SQLModel/Repository），对接示例数据库并输出 GraphQL/REST。
4. 搭建抖音/同花顺连接器的最小可用实现，完成凭证管理与错误回退。

---
本蓝图将作为 P3 阶段的执行手册，所有后续开发与验收都将以此为基线。欢迎继续补充需求或约束。*** End Patch




