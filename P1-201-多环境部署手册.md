# P1-201: 多环境部署手册

## 概述

本手册提供 AI-STACK 在多环境（开发、预发布、生产）下的完整部署指南，包括 npm、模型、外部 API、Sidecar、Docker、Service Register 等扩展功能的配置和部署。

## 目录

- [环境配置](#环境配置)
- [部署流程](#部署流程)
- [扩展功能配置](#扩展功能配置)
- [自动化部署](#自动化部署)
- [故障排查](#故障排查)

---

## 环境配置

### 环境类型

AI-STACK 支持三种环境配置：

| 环境 | 配置文件 | 用途 |
|------|---------|------|
| **开发环境** | `config/environments/dev.yaml` | 本地开发、CI 快速验证 |
| **预发布环境** | `config/environments/staging.yaml` | 验收测试、回归测试 |
| **生产环境** | `config/environments/prod.yaml` | 正式生产环境 |

### 配置文件结构

每个环境配置文件包含以下部分：

```yaml
name: <环境名称>
description: "<环境描述>"
env:
  # 基础环境变量
  APP_ENV: <development|staging|production>
  DATABASE_URL: <数据库连接字符串>
  # ...
npm:
  # npm 配置
  registry: <npm 仓库地址>
  token: <npm token>
  scope: <npm scope>
models:
  # 模型配置
  default: <默认模型>
  fallback: <备用模型>
  ollama_base_url: <Ollama 服务地址>
external_apis:
  # 外部 API 配置
  douyin:
    enabled: <0|1>
    app_key: <抖音 App Key>
    app_secret: <抖音 App Secret>
    real_mode: <0|1>
  tushare:
    enabled: <0|1>
    token: <Tushare Token>
  ths:
    enabled: <0|1>
    app_key: <同花顺 App Key>
    app_secret: <同花顺 App Secret>
services:
  # 服务配置
  api: <true|false>
  worker: <true|false>
  scheduler: <true|false>
  sidecars: <Sidecar 服务列表>
deploy:
  # 部署配置
  auto_migrate: <true|false>
  restart_services: <服务列表>
  docker:
    enabled: <true|false>
    compose_file: <Docker Compose 文件>
  sidecars:
    enabled: <true|false>
    services: <Sidecar 配置列表>
  service_registry:
    enabled: <true|false>
    endpoint: <Service Registry 地址>
```

---

## 部署流程

### 部署步骤

AI-STACK 的部署流程包括以下步骤：

1. **环境验证**
   - 验证 Python、Node.js、Docker 等工具
   - 验证依赖完整性

2. **npm 依赖安装**
   - 根据环境配置安装 npm 依赖
   - 配置 npm registry 和 token

3. **模型服务验证**
   - 验证 Ollama 服务可用性
   - 检查模型是否已下载

4. **外部 API 验证**
   - 验证抖音、Tushare、同花顺等外部 API 配置

5. **数据库迁移**
   - 运行数据库迁移脚本
   - 初始化种子数据

6. **测试执行**
   - 运行关键测试用例

7. **前端构建**
   - 构建前端静态资源

8. **Docker 构建（如需要）**
   - 构建 Docker 镜像
   - 启动 Docker Compose 服务

9. **Sidecar 部署（如需要）**
   - 部署 RAG Hub Sidecar
   - 部署 Trend Ops Sidecar

10. **服务注册（如需要）**
    - 注册 Sidecar 服务到 Service Registry

11. **服务重启**
    - 重启 FastAPI 和后台服务

12. **健康检查**
    - 验证所有服务健康状态

### 部署命令

#### 方式1: 使用自动化脚本（推荐）

```bash
# 开发环境部署（干运行）
./scripts/deploy_multi_env.sh dev true

# 开发环境部署（实际执行）
./scripts/deploy_multi_env.sh dev false

# 预发布环境部署
./scripts/deploy_multi_env.sh staging false

# 生产环境部署
./scripts/deploy_multi_env.sh prod false

# 只执行特定步骤
./scripts/deploy_multi_env.sh dev false "npm_install,docker_build"
```

#### 方式2: 使用 Python 脚本

```bash
# 应用环境配置
python3 scripts/manage_configs.py apply dev

# 运行部署流水线（干运行）
python3 scripts/run_deployment.py --profile dev --dry-run

# 运行部署流水线（实际执行）
python3 scripts/run_deployment.py --profile dev

# 只执行特定步骤
python3 scripts/run_deployment.py --profile dev --steps npm_install,docker_build
```

#### 方式3: 使用 API

```bash
# 应用环境配置
curl -X POST http://localhost:8000/api/devops/config/apply \
  -H "Content-Type: application/json" \
  -d '{"profile": "dev"}'

# 运行部署流水线
curl -X POST http://localhost:8000/api/devops/deploy/run \
  -H "Content-Type: application/json" \
  -d '{"profile": "dev", "dry_run": false}'
```

---

## 扩展功能配置

### npm 配置

#### 配置 npm registry

在环境配置文件中设置：

```yaml
npm:
  registry: "https://registry.npmjs.org/"
  token: "${NPM_TOKEN}"
  scope: "@ai-stack"
```

#### 设置环境变量

```bash
export NPM_TOKEN="your-npm-token"
```

#### 安装依赖

部署脚本会自动执行 `npm install`，使用配置的 registry 和 token。

### 模型配置

#### 配置 Ollama 服务

在环境配置文件中设置：

```yaml
models:
  default: "qwen2.5:7b"
  fallback: "qwen2.5:1.5b"
  ollama_base_url: "http://ollama-prod:11434"
```

#### 验证模型服务

部署脚本会自动验证 Ollama 服务可用性：

```bash
curl -f http://ollama-prod:11434/api/tags
```

### 外部 API 配置

#### 抖音 API

1. **获取 API 密钥**
   - 登录抖音开放平台
   - 创建应用并获取 App Key 和 App Secret

2. **配置环境变量**
   ```bash
   export DOUYIN_APP_KEY="your-app-key"
   export DOUYIN_APP_SECRET="your-app-secret"
   ```

3. **在环境配置中启用**
   ```yaml
   external_apis:
     douyin:
       enabled: "1"
       app_key: "${DOUYIN_APP_KEY}"
       app_secret: "${DOUYIN_APP_SECRET}"
       real_mode: "1"
   ```

#### Tushare API

1. **获取 Token**
   - 注册 Tushare 账号
   - 获取 API Token

2. **配置环境变量**
   ```bash
   export TUSHARE_TOKEN="your-tushare-token"
   ```

3. **在环境配置中启用**
   ```yaml
   external_apis:
     tushare:
       enabled: "1"
       token: "${TUSHARE_TOKEN}"
   ```

#### 同花顺 API

1. **获取 API 密钥**
   - 联系同花顺获取 App Key 和 App Secret

2. **配置环境变量**
   ```bash
   export THS_APP_KEY="your-app-key"
   export THS_APP_SECRET="your-app-secret"
   ```

3. **在环境配置中启用**
   ```yaml
   external_apis:
     ths:
       enabled: "1"
       app_key: "${THS_APP_KEY}"
       app_secret: "${THS_APP_SECRET}"
   ```

### Sidecar 部署

#### 配置 Sidecar 服务

在环境配置文件中设置：

```yaml
services:
  sidecars:
    - rag_hub
    - trend_ops

deploy:
  sidecars:
    enabled: true
    services:
      - name: rag_hub
        port: 8001
        path: "services/rag_sidecar.py"
        replicas: 2
      - name: trend_ops
        port: 8002
        path: "services/trend_sidecar.py"
        replicas: 2
```

#### 部署 Sidecar

部署脚本会自动启动 Sidecar 服务：

```bash
python3 -m uvicorn services.rag_sidecar:app --host 0.0.0.0 --port 8001
python3 -m uvicorn services.trend_sidecar:app --host 0.0.0.0 --port 8002
```

### Docker 部署

#### 配置 Docker

在环境配置文件中设置：

```yaml
deploy:
  docker:
    enabled: true
    compose_file: "docker-compose.prod.yml"
    image_tag: "latest"
```

#### 构建 Docker 镜像

部署脚本会自动构建 Docker 镜像：

```bash
docker build -t ai-stack:latest -f Dockerfile .
```

#### 启动 Docker Compose

部署脚本会自动启动 Docker Compose 服务：

```bash
docker-compose -f docker-compose.prod.yml up -d
```

### Service Register 配置

#### 配置 Service Registry

在环境配置文件中设置：

```yaml
deploy:
  service_registry:
    enabled: true
    endpoint: "http://service-registry:8500"
```

#### 注册服务

部署脚本会自动注册 Sidecar 服务到 Service Registry：

```bash
curl -X POST "http://localhost:8000/api/architecture/services/register" \
  -H "Content-Type: application/json" \
  -d '{
    "service": "rag_hub",
    "endpoint": "http://localhost:8001",
    "version": "v1",
    "protocol": "http",
    "deployment_target": "sidecar"
  }'
```

---

## 自动化部署

### CI/CD 集成

#### GitHub Actions 示例

```yaml
name: Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Configure environment
        run: |
          export NPM_TOKEN=${{ secrets.NPM_TOKEN }}
          export DOUYIN_APP_KEY=${{ secrets.DOUYIN_APP_KEY }}
          export DOUYIN_APP_SECRET=${{ secrets.DOUYIN_APP_SECRET }}
          export TUSHARE_TOKEN=${{ secrets.TUSHARE_TOKEN }}
      
      - name: Deploy
        run: |
          ./scripts/deploy_multi_env.sh staging false
```

### 部署历史

部署历史记录保存在以下位置：

- **配置历史**: `artifacts/config/apply_history.jsonl`
- **部署历史**: `artifacts/deployments/deployment_history.jsonl`

查看部署历史：

```bash
# 查看配置历史
tail -n 20 artifacts/config/apply_history.jsonl | jq

# 查看部署历史
tail -n 20 artifacts/deployments/deployment_history.jsonl | jq
```

---

## 故障排查

### 常见问题

#### 1. npm 安装失败

**问题**: `npm install` 失败，提示认证错误

**解决**:
- 检查 `NPM_TOKEN` 环境变量是否正确设置
- 检查 npm registry 配置是否正确
- 尝试手动运行 `npm install` 查看详细错误

#### 2. 模型服务不可用

**问题**: 模型服务验证失败

**解决**:
- 检查 Ollama 服务是否运行：`curl http://localhost:11434/api/tags`
- 检查模型是否已下载：`ollama list`
- 检查环境变量 `MODEL_OLLAMA_BASE_URL` 是否正确

#### 3. 外部 API 配置错误

**问题**: 外部 API 验证失败

**解决**:
- 运行验证脚本：`python3 scripts/verify_external_apis.py`
- 检查环境变量是否正确设置
- 检查 API 密钥是否有效

#### 4. Sidecar 启动失败

**问题**: Sidecar 服务无法启动

**解决**:
- 检查端口是否被占用：`lsof -i :8001`
- 检查 Sidecar 文件是否存在：`ls -la services/rag_sidecar.py`
- 查看 Sidecar 日志：`tail -f logs/rag_sidecar.log`

#### 5. Docker 构建失败

**问题**: Docker 镜像构建失败

**解决**:
- 检查 Dockerfile 是否存在
- 检查 Docker 服务是否运行：`docker ps`
- 查看详细构建日志：`docker build -t ai-stack:latest .`

#### 6. 服务注册失败

**问题**: 服务无法注册到 Service Registry

**解决**:
- 检查 Service Registry 是否运行
- 检查主服务 API 是否可访问：`curl http://localhost:8000/api/health`
- 检查服务注册端点是否正确

### 日志查看

#### 查看部署日志

```bash
# 查看配置应用日志
tail -f artifacts/config/apply_history.jsonl

# 查看部署执行日志
tail -f artifacts/deployments/deployment_history.jsonl

# 查看服务日志
tail -f logs/api.log
tail -f logs/worker.log
```

#### 查看 Docker 日志

```bash
# 查看容器日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f api
docker-compose logs -f worker
```

---

## 最佳实践

### 1. 环境隔离

- 不同环境使用不同的数据库
- 不同环境使用不同的外部 API 密钥
- 生产环境禁用自动迁移

### 2. 密钥管理

- 使用环境变量存储敏感信息
- 不要在配置文件中硬编码密钥
- 使用密钥管理服务（如 AWS Secrets Manager、HashiCorp Vault）

### 3. 部署前检查

- 始终先执行干运行模式：`./scripts/deploy_multi_env.sh <env> true`
- 验证所有外部依赖（数据库、Redis、Ollama 等）
- 检查磁盘空间和资源配额

### 4. 回滚策略

- 保留之前的 Docker 镜像版本
- 保留数据库迁移脚本
- 准备快速回滚脚本

### 5. 监控和告警

- 配置健康检查端点
- 设置服务监控和告警
- 定期检查部署历史

---

## 相关文档

- `P1-005-日常配置与部署自动化交付文档.md`: P1-005 基础功能文档
- `P1-201-完整验证总结.md`: P1-201 验证总结
- `config/environments/*.yaml`: 环境配置文件
- `config/deploy_pipeline.yaml`: 部署流水线配置
- `scripts/deploy_multi_env.sh`: 多环境部署脚本
- `scripts/verify_external_apis.py`: 外部 API 验证脚本

