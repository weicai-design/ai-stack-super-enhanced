## P3-002 · 微服务拆分交付文档

### 1. 任务目标
在保持单体可运行的前提下，完成“可切换微服务形态”的基础设施：服务边界、契约、注册/发现、通信与部署示例，支持 Sidecar/独立进程演进。

### 2. 核心交付
| 组件 | 功能 |
| --- | --- |
| `core/service_registry.py` | 维护 `ServiceContract` & `ServiceInstance`，提供注册、心跳、变更日志。 |
| `core/service_gateway.py` | 统一调用入口；支持同进程 handler 与远端 HTTP 调用，返回 `ServiceCallResult`。 |
| `config/services/*.yaml` | `rag_hub` / `trend_ops` 服务契约模板，描述 operation、路径、超时时间。 |
| `services/rag_sidecar.py` | 基于 FastAPI 的 RAG Hub Sidecar，可独立运行 exposing `/v1/rag/*`。 |
| `services/trend_sidecar.py` | 趋势分析 Sidecar，提供 `/v1/trend/backtest`、`/v1/trend/scenario`。 |
| API 扩展 | `/architecture/services/*` 系列接口（summary / register / heartbeat / call），受 RBAC 保护。 |
| 文档 | 本交付文档 + `P3-002-完整验证总结.md`。 |

### 3. 运行示例
```bash
# 1. 启动 RAG sidecar
uvicorn services.rag_sidecar:app --port 8011

# 2. 在主控制台注册实例
curl -X POST /api/super-agent/architecture/services/register \
  -H "X-API-Key: ..." \
  -d '{"service":"rag_hub","endpoint":"http://localhost:8011","deployment_target":"sidecar"}'

# 3. 通过 Gateway 调用
curl -X POST /api/super-agent/architecture/services/call \
  -H "X-API-Key: ..." \
  -d '{"service":"rag_hub","operation":"search","payload":{"query":"供应链优化"}}'
```
未注册 Sidecar 时，Gateway 会回退到内置 handler（同进程调用 `DualRAGEngine` / `TrendScenarioEngine`），确保功能不中断。

### 4. 配置与部署
- 配置契约：`config/services/*` 可被 CI/运维系统读取，用于生成 API Gateway/Ingress 配置。
- 实例注册：Sidecar 启动后通过 `/architecture/services/register` 或 `scripts/manage_configs.py` 注册；心跳接口用于健康监控。
- 自动化：结合 `scripts/run_deployment.py` 可在部署阶段自动执行“配置 profile → 注册服务 → 健康校验”。

### 5. 与多租户/闭环的关系
- Registry/ Gateway 已与 `multitenant_evolution` 规划一致，service summary API 可作为 Phase1 “Module Contracts” 的契约源。
- 所有服务调用都记录 request_id，可与 Unified Event Bus/闭环证据系统关联。

### 6. 后续建议
1. 接入真实服务发现（Consul/etcd）替换内存 Registry。
2. 在 Gateway 内部发布事件（Workflow/Observability），纳入性能报表。
3. 为 Sidecar 模板加入 Dockerfile & systemd unit，自动生成部署包。

