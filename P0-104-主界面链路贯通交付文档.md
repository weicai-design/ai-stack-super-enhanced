# P0-104: ä¸»ç•Œé¢ â†’ äºŒçº§ â†’ ä¸‰çº§/å››çº§è´¯é€šäº¤ä»˜æ–‡æ¡£

## ä»»åŠ¡æ¦‚è¿°

ä¸ºæ¯ä¸ªä¼˜å…ˆæ¨¡å—å»ºç«‹"ä¸»ç•Œé¢å¡ç‰‡ â†’ äºŒçº§ç•Œé¢ â†’ API â†’ æ•°æ®åº“/Sidecar"çš„çœŸå®è°ƒç”¨è·¯å¾„ï¼Œå¹¶è®°å½•åœ¨é“¾è·¯å›¾ä¸­ã€‚

## è¦†ç›–æ¨¡å—

1. **RAG çŸ¥è¯†ä¸­å¿ƒ**
2. **ERP æµç¨‹ä¸­å¿ƒ**
3. **å†…å®¹åˆ›ä½œç³»ç»Ÿ**
4. **è¶‹åŠ¿åˆ†æ**
5. **è‚¡ç¥¨é‡åŒ–**
6. **è¿è¥è´¢åŠ¡**
7. **AI ç¼–ç¨‹åŠ©æ‰‹**

## å®ç°å†…å®¹

### 1. ModuleChainManager (`core/module_chain.py`)

**åŠŸèƒ½**ï¼š
- ç»´æŠ¤æ¯ä¸ªæ¨¡å—çš„å®Œæ•´è°ƒç”¨é“¾è·¯ä¿¡æ¯
- è®°å½•ä¸»ç•Œé¢å…¥å£ã€äºŒçº§/ä¸‰çº§/å››çº§è§†å›¾è·¯å¾„
- è¿½è¸ª API ç«¯ç‚¹ã€æ•°æ®æºã€Sidecar æœåŠ¡
- æä¾›éªŒè¯æŒ‡æ ‡ï¼ˆæ•°æ®è®°å½•æ•°ã€æœåŠ¡å¥‘çº¦çŠ¶æ€ç­‰ï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `list_chains(refresh=False)`: åˆ—å‡ºæ‰€æœ‰æ¨¡å—é“¾è·¯
- `get_chain(module_id)`: è·å–æŒ‡å®šæ¨¡å—é“¾è·¯
- `refresh()`: å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰é“¾è·¯ä¿¡æ¯
- `_build_*_chain()`: ä¸ºæ¯ä¸ªæ¨¡å—æ„å»ºé“¾è·¯ä¿¡æ¯

### 2. API ç«¯ç‚¹é›†æˆ

**æ–°å¢ç«¯ç‚¹**ï¼š
- `GET /modules/chains?refresh=false`: è·å–æ‰€æœ‰æ¨¡å—é“¾è·¯åˆ—è¡¨
- `GET /modules/chains/{module_id}`: è·å–æŒ‡å®šæ¨¡å—çš„é“¾è·¯è¯¦æƒ…
- `POST /modules/chains/refresh`: å¼ºåˆ¶åˆ·æ–°é“¾è·¯ä¿¡æ¯ï¼ˆéœ€è¦æƒé™ï¼‰

### 3. é“¾è·¯ä¿¡æ¯ç»“æ„

æ¯ä¸ªæ¨¡å—é“¾è·¯åŒ…å«ï¼š
- **hierarchy**: ä¸»ç•Œé¢å¡ç‰‡ â†’ äºŒçº§è·¯ç”± â†’ ä¸‰çº§è§†å›¾ â†’ å››çº§èƒ½åŠ›
- **apis**: ç›¸å…³ API ç«¯ç‚¹åˆ—è¡¨ï¼ˆæ–¹æ³•ã€è·¯å¾„ã€æè¿°ï¼‰
- **data_sources**: æ•°æ®æºä¿¡æ¯ï¼ˆæ•°æ®åº“è¡¨ã€æ–‡ä»¶ã€å¤–éƒ¨æœåŠ¡ç­‰ï¼‰
- **sidecars**: Sidecar æœåŠ¡å¥‘çº¦ä¿¡æ¯
- **verification**: éªŒè¯æŒ‡æ ‡ï¼ˆæ•°æ®è®°å½•æ•°ã€æœåŠ¡å¯ç”¨æ€§ç­‰ï¼‰

## æ¨¡å—é“¾è·¯è¯¦æƒ…

### RAG çŸ¥è¯†ä¸­å¿ƒ

**é“¾è·¯è·¯å¾„**ï¼š
```
ä¸»ç•Œé¢: sidebar.nav-btn[data-module='rag']
  â†’ äºŒçº§: three_level.html?module=rag
    â†’ ä¸‰çº§: preprocess â†’ ingest_status
      â†’ å››çº§: upload_document
```

**API è°ƒç”¨é“¾**ï¼š
- `POST /rag/pipeline/ingest`: æ–‡æ¡£æ¥å…¥ä¸é¢„å¤„ç†
- `GET /rag/pipeline/documents`: åˆ—å‡ºå…¥åº“æ–‡æ¡£
- `GET /modules/view-data?module=rag&stage=preprocess&view=ingest_status`: ä¸‰çº§è§†å›¾æ•°æ®

**æ•°æ®æº**ï¼š
- æ•°æ®åº“ï¼š`rag_documents` è¡¨ï¼ˆé€šè¿‡ DataServiceï¼‰
- æ–‡ä»¶ï¼š`data/rag/documents.jsonl`

**Sidecar**ï¼š
- `rag_hub.search`: æœç´¢æœåŠ¡å¥‘çº¦
- `rag_hub.experience`: ç»éªŒæ£€ç´¢æœåŠ¡å¥‘çº¦

### ERP æµç¨‹ä¸­å¿ƒ

**é“¾è·¯è·¯å¾„**ï¼š
```
ä¸»ç•Œé¢: sidebar.nav-btn[data-module='erp']
  â†’ äºŒçº§: three_level.html?module=erp
    â†’ ä¸‰çº§: operations â†’ operations_board
      â†’ å››çº§: strategy_links
```

**API è°ƒç”¨é“¾**ï¼š
- `POST /erp/trial/calc`: è¿è¥è¯•ç®—å™¨
- `POST /erp/8d/analyze`: 8D åˆ†æ
- `GET /operations-finance/erp/sync/status`: ERP æ•°æ®åŒæ­¥çŠ¶æ€

**æ•°æ®æº**ï¼š
- æ•°æ®åº“ï¼š`erp_data` è¡¨
- æ•°æ®æºï¼š`DemoFactoryTrialDataSource`
- æ•°æ®æºï¼š`FactoryDataSource`

### å†…å®¹åˆ›ä½œç³»ç»Ÿ

**é“¾è·¯è·¯å¾„**ï¼š
```
ä¸»ç•Œé¢: sidebar.nav-btn[data-module='content']
  â†’ äºŒçº§: three_level.html?module=content
    â†’ ä¸‰çº§: generation â†’ content_generation
      â†’ å››çº§: storyline æ¨¡æ¿
```

**API è°ƒç”¨é“¾**ï¼š
- `POST /douyin/publish`: æŠ–éŸ³çœŸå®å‘å¸ƒ
- `POST /content/storyboard/generate`: è„šæœ¬/åˆ†é•œç”Ÿæˆ
- `GET /content/analytics`: è¿è¥è¡¨ç°åˆ†æ

**æ•°æ®æº**ï¼š
- æ•°æ®åº“ï¼š`content_data` è¡¨
- åˆ†ææœåŠ¡ï¼š`ContentAnalytics`ï¼ˆå†…å­˜å­˜å‚¨ï¼‰

### è¶‹åŠ¿åˆ†æ

**é“¾è·¯è·¯å¾„**ï¼š
```
ä¸»ç•Œé¢: sidebar.nav-btn[data-module='trend']
  â†’ äºŒçº§: three_level.html?module=trend
    â†’ ä¸‰çº§: analysis â†’ trend_insights
      â†’ å››çº§: trend_rag_output
```

**API è°ƒç”¨é“¾**ï¼š
- `GET /trend/backtest`: å›æµ‹ä¸ RAG é“¾è·¯
- `POST /trend/what-if`: What-if æƒ…æ™¯æ¨¡æ‹Ÿ

**æ•°æ®æº**ï¼š
- æ•°æ®åº“ï¼š`trend_data` è¡¨
- é‡‡é›†å™¨ï¼š`TrendDataCollector`ï¼ˆæœ€è¿‘7å¤©æ•°æ®æºç»Ÿè®¡ï¼‰

**Sidecar**ï¼š
- `trend_ops.backtest`: å›æµ‹æœåŠ¡å¥‘çº¦

### è‚¡ç¥¨é‡åŒ–

**é“¾è·¯è·¯å¾„**ï¼š
```
ä¸»ç•Œé¢: sidebar.nav-btn[data-module='stock']
  â†’ äºŒçº§: three_level.html?module=stock
    â†’ ä¸‰çº§: trading â†’ stock_simulator
      â†’ å››çº§: risk_control
```

**API è°ƒç”¨é“¾**ï¼š
- `GET /stock/quote`: å®æ—¶è¡Œæƒ…ï¼ˆå¤šæºçƒ­åˆ‡æ¢ï¼‰
- `POST /stock/sim/place-order`: æ¨¡æ‹Ÿç›˜ä¸‹å•
- `GET /stock/sim/risk-report`: æ¨¡æ‹Ÿç›˜é£æ§

**æ•°æ®æº**ï¼š
- æ•°æ®åº“ï¼š`stock_data` è¡¨
- ç½‘å…³ï¼š`StockGateway`ï¼ˆå¤šæ•°æ®æºçƒ­åˆ‡æ¢ï¼‰

### è¿è¥è´¢åŠ¡

**é“¾è·¯è·¯å¾„**ï¼š
```
ä¸»ç•Œé¢: sidebar.nav-btn[data-module='operations']
  â†’ äºŒçº§: three_level.html?module=operations
    â†’ ä¸‰çº§: operations â†’ operations_board
      â†’ å››çº§: cross_system_sync
```

**API è°ƒç”¨é“¾**ï¼š
- `GET /operations-finance/kpis`: è¿è¥è´¢åŠ¡ KPI
- `GET /operations-finance/insights`: ä¸“å®¶æ´å¯Ÿ
- `POST /operations-finance/erp/sync`: ERP æ•°æ®å›å†™

**æ•°æ®æº**ï¼š
- æ•°æ®åº“ï¼š`operations_data` è¡¨

### AI ç¼–ç¨‹åŠ©æ‰‹

**é“¾è·¯è·¯å¾„**ï¼š
```
ä¸»ç•Œé¢: sidebar.nav-btn[data-module='coding']
  â†’ äºŒçº§: three_level.html?module=coding
    â†’ ä¸‰çº§: generation â†’ coding_generation
      â†’ å››çº§: cursor_bridge
```

**API è°ƒç”¨é“¾**ï¼š
- `GET /coding/cursor/status`: Cursor æ¡¥æ¥çŠ¶æ€
- `POST /coding/cursor/open-file`: æ‰“å¼€æ–‡ä»¶åˆ° Cursor
- `POST /coding/cursor/apply-edits`: æ¨é€ç¼–è¾‘ diff

**æ•°æ®æº**ï¼š
- æ¡¥æ¥å™¨ï¼š`CursorBridge`ï¼ˆCursor IDE é›†æˆçŠ¶æ€ï¼‰

## ä½¿ç”¨è¯´æ˜

### 1. è·å–æ‰€æœ‰æ¨¡å—é“¾è·¯

```bash
curl http://localhost:8000/api/modules/chains
```

### 2. è·å–æŒ‡å®šæ¨¡å—é“¾è·¯

```bash
curl http://localhost:8000/api/modules/chains/rag
```

### 3. å¼ºåˆ¶åˆ·æ–°é“¾è·¯ä¿¡æ¯

```bash
curl -X POST http://localhost:8000/api/modules/chains/refresh \
  -H "X-User-Roles: admin"
```

### 4. å‰ç«¯é›†æˆç¤ºä¾‹

```javascript
// è·å–æ¨¡å—é“¾è·¯ä¿¡æ¯
async function loadModuleChain(moduleId) {
  const response = await fetch(`/api/modules/chains/${moduleId}`);
  const result = await response.json();
  return result.chain;
}

// åœ¨ä¸»ç•Œé¢ç‚¹å‡»æ¨¡å—å¡ç‰‡åï¼Œæ ¹æ®é“¾è·¯ä¿¡æ¯å¯¼èˆª
async function navigateToModule(moduleId) {
  const chain = await loadModuleChain(moduleId);
  // æ ¹æ® chain.hierarchy æ„å»ºå¯¼èˆªè·¯å¾„
  const secondaryRoute = chain.hierarchy.secondary_route;
  window.location.href = secondaryRoute;
}
```

## éªŒè¯æŒ‡æ ‡

æ¯ä¸ªæ¨¡å—é“¾è·¯éƒ½åŒ…å« `verification` å­—æ®µï¼Œç”¨äºéªŒè¯é“¾è·¯å®Œæ•´æ€§ï¼š

- **æ•°æ®è®°å½•æ•°**: é€šè¿‡ `DataService.count_data()` ç»Ÿè®¡
- **æ–‡ä»¶å­˜åœ¨æ€§**: æ£€æŸ¥æœ¬åœ°æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- **æœåŠ¡å¥‘çº¦çŠ¶æ€**: æ£€æŸ¥ Sidecar æœåŠ¡å¥‘çº¦æ˜¯å¦æ³¨å†Œ
- **æ•°æ®æºå¯ç”¨æ€§**: æ£€æŸ¥å¤–éƒ¨æ•°æ®æºæ˜¯å¦å¯ç”¨
- **æ¡¥æ¥å™¨çŠ¶æ€**: æ£€æŸ¥ Cursor ç­‰æ¡¥æ¥å™¨æ˜¯å¦å¯ç”¨

## æŠ€æœ¯å®ç°

### ä¾èµ–ç»„ä»¶

- `DataService`: æ•°æ®æœåŠ¡å±‚ï¼Œç”¨äºç»Ÿè®¡å’ŒæŸ¥è¯¢æ•°æ®
- `ServiceRegistry`: æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œç”¨äºæŸ¥è¯¢ Sidecar å¥‘çº¦
- å„æ¨¡å—çš„æ•°æ®æºå®ä¾‹ï¼ˆå¦‚ `TrendDataCollector`ã€`ContentAnalytics` ç­‰ï¼‰

### çº¿ç¨‹å®‰å…¨

ä½¿ç”¨ `asyncio.Lock()` ç¡®ä¿é“¾è·¯ä¿¡æ¯çš„çº¿ç¨‹å®‰å…¨æ›´æ–°ã€‚

### æ€§èƒ½ä¼˜åŒ–

- é“¾è·¯ä¿¡æ¯ç¼“å­˜ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢
- æ”¯æŒæŒ‰éœ€åˆ·æ–°ï¼ˆ`refresh` å‚æ•°ï¼‰
- å¼‚æ­¥æ“ä½œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹

## åç»­æ‰©å±•

1. **é“¾è·¯ç›‘æ§**: å¯ä»¥æ‰©å±•ä¸ºå®æ—¶ç›‘æ§é“¾è·¯å¥åº·çŠ¶æ€
2. **é“¾è·¯è¿½è¸ª**: é›†æˆåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œè®°å½•å®é™…è°ƒç”¨è·¯å¾„
3. **é“¾è·¯æµ‹è¯•**: è‡ªåŠ¨åŒ–æµ‹è¯•æ¯ä¸ªæ¨¡å—çš„å®Œæ•´é“¾è·¯
4. **é“¾è·¯å¯è§†åŒ–**: åœ¨å‰ç«¯å¯è§†åŒ–å±•ç¤ºæ¨¡å—é“¾è·¯å›¾

## ç›¸å…³æ–‡ä»¶

- `ğŸš€ Super Agent Main Interface/core/module_chain.py`: é“¾è·¯ç®¡ç†å™¨å®ç°
- `ğŸš€ Super Agent Main Interface/api/super_agent_api.py`: API ç«¯ç‚¹é›†æˆ
- `P0-104-æ¨¡å—é“¾è·¯è´¯é€šå›¾.md`: é“¾è·¯å›¾æ–‡æ¡£

