# P1-201: æ—¥å¸¸é…ç½®ä¸éƒ¨ç½²æ‰©å±•äº¤ä»˜æ–‡æ¡£

## ä»»åŠ¡æ¦‚è¿°

å°† P1-005 çš„ç¯å¢ƒ/éƒ¨ç½²è„šæœ¬æ‰©å±•åˆ° npmã€æ¨¡å‹ã€å¤–éƒ¨ APIï¼›åŠ å…¥ Sidecar/Docker/Service Register æ­¥éª¤ã€‚è¾“å‡ºå¤šç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ + è‡ªåŠ¨åŒ–è„šæœ¬ã€‚

## å®ç°å†…å®¹

### 1. æ‰©å±•ç¯å¢ƒé…ç½®ç®¡ç†å™¨ (`core/config_automation.py`)

**æ–°å¢åŠŸèƒ½**:
- âœ… **npm é…ç½®æ”¯æŒ**: æ”¯æŒ npm registryã€tokenã€scope é…ç½®
- âœ… **æ¨¡å‹é…ç½®æ”¯æŒ**: æ”¯æŒé»˜è®¤æ¨¡å‹ã€å¤‡ç”¨æ¨¡å‹ã€Ollama æœåŠ¡åœ°å€é…ç½®
- âœ… **å¤–éƒ¨ API é…ç½®æ”¯æŒ**: æ”¯æŒæŠ–éŸ³ã€Tushareã€åŒèŠ±é¡ºç­‰å¤–éƒ¨ API é…ç½®
- âœ… **é…ç½®è‡ªåŠ¨æ³¨å…¥**: è‡ªåŠ¨å°† npmã€æ¨¡å‹ã€å¤–éƒ¨ API é…ç½®æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡

**æ ¸å¿ƒæ–¹æ³•æ‰©å±•**:
- `apply_profile()`: æ‰©å±•æ”¯æŒ npmã€æ¨¡å‹ã€å¤–éƒ¨ API é…ç½®
- `list_profiles()`: è¿”å›åŒ…å«æ‰©å±•é…ç½®çš„é…ç½®åˆ—è¡¨

### 2. æ‰©å±•éƒ¨ç½²è‡ªåŠ¨åŒ– (`core/config_automation.py`)

**æ–°å¢æ­¥éª¤ç±»å‹**:
- âœ… **npm_install**: npm ä¾èµ–å®‰è£…æ­¥éª¤
- âœ… **docker_build**: Docker é•œåƒæ„å»ºå’Œè¿è¡Œæ­¥éª¤
- âœ… **sidecar_deploy**: Sidecar æœåŠ¡éƒ¨ç½²æ­¥éª¤
- âœ… **service_register**: æœåŠ¡æ³¨å†Œæ­¥éª¤

**æ ¸å¿ƒæ–¹æ³•æ‰©å±•**:
- `_execute_step()`: æ”¯æŒæ–°çš„æ­¥éª¤ç±»å‹
- `_build_npm_command()`: æ„å»º npm å®‰è£…å‘½ä»¤
- `_build_docker_command()`: æ„å»º Docker å‘½ä»¤
- `_build_sidecar_command()`: æ„å»º Sidecar éƒ¨ç½²å‘½ä»¤
- `_build_service_register_command()`: æ„å»ºæœåŠ¡æ³¨å†Œå‘½ä»¤

### 3. ç¯å¢ƒé…ç½®æ–‡ä»¶æ‰©å±•

**æ›´æ–°çš„é…ç½®æ–‡ä»¶**:
- âœ… `config/environments/dev.yaml`: æ·»åŠ  npmã€æ¨¡å‹ã€å¤–éƒ¨ API é…ç½®
- âœ… `config/environments/staging.yaml`: æ·»åŠ å®Œæ•´æ‰©å±•é…ç½®
- âœ… `config/environments/prod.yaml`: æ·»åŠ å®Œæ•´æ‰©å±•é…ç½®

**æ–°å¢é…ç½®é¡¹**:
- `npm`: npm registryã€tokenã€scope
- `models`: é»˜è®¤æ¨¡å‹ã€å¤‡ç”¨æ¨¡å‹ã€Ollama æœåŠ¡åœ°å€
- `external_apis`: æŠ–éŸ³ã€Tushareã€åŒèŠ±é¡º API é…ç½®
- `deploy.docker`: Docker éƒ¨ç½²é…ç½®
- `deploy.sidecars`: Sidecar éƒ¨ç½²é…ç½®
- `deploy.service_registry`: Service Registry é…ç½®

### 4. éƒ¨ç½²æµæ°´çº¿æ‰©å±• (`config/deploy_pipeline.yaml`)

**æ–°å¢æ­¥éª¤**:
- âœ… `verify_node`: éªŒè¯ Node.js/npm
- âœ… `verify_docker`: éªŒè¯ Docker
- âœ… `npm_install`: npm ä¾èµ–å®‰è£…
- âœ… `verify_models`: éªŒè¯æ¨¡å‹æœåŠ¡
- âœ… `verify_external_apis`: éªŒè¯å¤–éƒ¨ API é…ç½®
- âœ… `docker_build`: Docker é•œåƒæ„å»º
- âœ… `docker_compose_up`: Docker Compose å¯åŠ¨
- âœ… `deploy_sidecars`: Sidecar æœåŠ¡éƒ¨ç½²
- âœ… `register_sidecar_services`: Sidecar æœåŠ¡æ³¨å†Œ
- âœ… `health_check`: å¥åº·æ£€æŸ¥

### 5. è‡ªåŠ¨åŒ–è„šæœ¬

**æ–°å¢è„šæœ¬**:
- âœ… `scripts/deploy_multi_env.sh`: å¤šç¯å¢ƒéƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬
- âœ… `scripts/verify_external_apis.py`: å¤–éƒ¨ API é…ç½®éªŒè¯è„šæœ¬

**è„šæœ¬åŠŸèƒ½**:
- æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²ï¼ˆdev/staging/prodï¼‰
- æ”¯æŒå¹²è¿è¡Œæ¨¡å¼
- æ”¯æŒé€‰å®šæ­¥éª¤æ‰§è¡Œ
- è‡ªåŠ¨ç¯å¢ƒéªŒè¯
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

### 6. å¤šç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ

**æ–‡æ¡£å†…å®¹**:
- âœ… ç¯å¢ƒé…ç½®è¯´æ˜
- âœ… éƒ¨ç½²æµç¨‹è¯¦è§£
- âœ… æ‰©å±•åŠŸèƒ½é…ç½®æŒ‡å—ï¼ˆnpmã€æ¨¡å‹ã€å¤–éƒ¨ APIã€Sidecarã€Dockerã€Service Registerï¼‰
- âœ… è‡ªåŠ¨åŒ–éƒ¨ç½²æ–¹æ³•
- âœ… CI/CD é›†æˆç¤ºä¾‹
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—
- âœ… æœ€ä½³å®è·µ

## æ‰©å±•åŠŸèƒ½è¯¦æƒ…

### npm é…ç½®

**é…ç½®é¡¹**:
- `registry`: npm ä»“åº“åœ°å€ï¼ˆé»˜è®¤: https://registry.npmjs.org/ï¼‰
- `token`: npm è®¤è¯ tokenï¼ˆå¯é€‰ï¼‰
- `scope`: npm scopeï¼ˆå¯é€‰ï¼‰

**ä½¿ç”¨æ–¹å¼**:
```yaml
npm:
  registry: "https://registry.npmjs.org/"
  token: "${NPM_TOKEN}"
  scope: "@ai-stack"
```

**è‡ªåŠ¨æ‰§è¡Œ**:
éƒ¨ç½²æµæ°´çº¿ä¼šè‡ªåŠ¨æ‰§è¡Œ `npm install`ï¼Œä½¿ç”¨é…ç½®çš„ registry å’Œ tokenã€‚

### æ¨¡å‹é…ç½®

**é…ç½®é¡¹**:
- `default`: é»˜è®¤æ¨¡å‹ï¼ˆå¦‚: qwen2.5:7bï¼‰
- `fallback`: å¤‡ç”¨æ¨¡å‹ï¼ˆå¦‚: qwen2.5:1.5bï¼‰
- `ollama_base_url`: Ollama æœåŠ¡åœ°å€

**ä½¿ç”¨æ–¹å¼**:
```yaml
models:
  default: "qwen2.5:7b"
  fallback: "qwen2.5:1.5b"
  ollama_base_url: "http://ollama-prod:11434"
```

**è‡ªåŠ¨éªŒè¯**:
éƒ¨ç½²æµæ°´çº¿ä¼šè‡ªåŠ¨éªŒè¯ Ollama æœåŠ¡å¯ç”¨æ€§ã€‚

### å¤–éƒ¨ API é…ç½®

**æ”¯æŒçš„ API**:
- æŠ–éŸ³ API
- Tushare API
- åŒèŠ±é¡º API

**é…ç½®ç¤ºä¾‹**:
```yaml
external_apis:
  douyin:
    enabled: "1"
    app_key: "${DOUYIN_APP_KEY}"
    app_secret: "${DOUYIN_APP_SECRET}"
    real_mode: "1"
  tushare:
    enabled: "1"
    token: "${TUSHARE_TOKEN}"
  ths:
    enabled: "1"
    app_key: "${THS_APP_KEY}"
    app_secret: "${THS_APP_SECRET}"
```

**è‡ªåŠ¨éªŒè¯**:
éƒ¨ç½²æµæ°´çº¿ä¼šè‡ªåŠ¨éªŒè¯å¤–éƒ¨ API é…ç½®ã€‚

### Sidecar éƒ¨ç½²

**é…ç½®ç¤ºä¾‹**:
```yaml
services:
  sidecars:
    - rag_hub
    - trend_ops

deploy:
  sidecars:
    enabled: true
    services:
      - name: rag_hub
        port: 8001
        path: "services/rag_sidecar.py"
        replicas: 2
```

**è‡ªåŠ¨éƒ¨ç½²**:
éƒ¨ç½²æµæ°´çº¿ä¼šè‡ªåŠ¨å¯åŠ¨ Sidecar æœåŠ¡ã€‚

### Docker éƒ¨ç½²

**é…ç½®ç¤ºä¾‹**:
```yaml
deploy:
  docker:
    enabled: true
    compose_file: "docker-compose.prod.yml"
    image_tag: "latest"
```

**è‡ªåŠ¨æ‰§è¡Œ**:
éƒ¨ç½²æµæ°´çº¿ä¼šè‡ªåŠ¨æ„å»º Docker é•œåƒå¹¶å¯åŠ¨ Docker Compose æœåŠ¡ã€‚

### Service Register

**é…ç½®ç¤ºä¾‹**:
```yaml
deploy:
  service_registry:
    enabled: true
    endpoint: "http://service-registry:8500"
```

**è‡ªåŠ¨æ³¨å†Œ**:
éƒ¨ç½²æµæ°´çº¿ä¼šè‡ªåŠ¨æ³¨å†Œ Sidecar æœåŠ¡åˆ° Service Registryã€‚

## ä½¿ç”¨æ–¹æ³•

### 1. åº”ç”¨ç¯å¢ƒé…ç½®

```bash
# ä½¿ç”¨ Python è„šæœ¬
python3 scripts/manage_configs.py apply dev

# ä½¿ç”¨ API
curl -X POST http://localhost:8000/api/devops/config/apply \
  -H "Content-Type: application/json" \
  -d '{"profile": "dev"}'
```

### 2. è¿è¡Œéƒ¨ç½²æµæ°´çº¿

```bash
# ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰
./scripts/deploy_multi_env.sh dev false

# ä½¿ç”¨ Python è„šæœ¬
python3 scripts/run_deployment.py --profile dev

# ä½¿ç”¨ API
curl -X POST http://localhost:8000/api/devops/deploy/run \
  -H "Content-Type: application/json" \
  -d '{"profile": "dev", "dry_run": false}'
```

### 3. éªŒè¯å¤–éƒ¨ API

```bash
python3 scripts/verify_external_apis.py
```

## é…ç½®ç¤ºä¾‹

### å¼€å‘ç¯å¢ƒ

```yaml
name: dev
npm:
  registry: "https://registry.npmjs.org/"
models:
  default: "qwen2.5:1.5b"
  ollama_base_url: "http://localhost:11434"
external_apis:
  douyin:
    enabled: "0"
deploy:
  docker:
    enabled: false
  sidecars:
    enabled: false
```

### ç”Ÿäº§ç¯å¢ƒ

```yaml
name: prod
npm:
  registry: "https://registry.npmjs.org/"
  token: "${NPM_TOKEN}"
models:
  default: "qwen2.5:7b"
  ollama_base_url: "http://ollama-prod:11434"
external_apis:
  douyin:
    enabled: "1"
    real_mode: "1"
deploy:
  docker:
    enabled: true
    compose_file: "docker-compose.prod.yml"
  sidecars:
    enabled: true
  service_registry:
    enabled: true
```

## æŠ€æœ¯å®ç°

### ä¾èµ–åº“

- `PyYAML`: YAML æ–‡ä»¶è§£æ
- `asyncio`: å¼‚æ­¥æ“ä½œæ”¯æŒ
- `subprocess`: å‘½ä»¤æ‰§è¡Œ
- `pathlib`: è·¯å¾„å¤„ç†

### æ‰©å±•æ€§

- æ˜“äºæ·»åŠ æ–°çš„æ­¥éª¤ç±»å‹
- æ˜“äºæ·»åŠ æ–°çš„å¤–éƒ¨ API æ”¯æŒ
- æ˜“äºæ·»åŠ æ–°çš„ Sidecar æœåŠ¡

## ç›¸å…³æ–‡ä»¶

- `ğŸš€ Super Agent Main Interface/core/config_automation.py`: é…ç½®å’Œéƒ¨ç½²è‡ªåŠ¨åŒ–æ ¸å¿ƒå®ç°
- `config/environments/*.yaml`: ç¯å¢ƒé…ç½®æ–‡ä»¶
- `config/deploy_pipeline.yaml`: éƒ¨ç½²æµæ°´çº¿é…ç½®
- `scripts/deploy_multi_env.sh`: å¤šç¯å¢ƒéƒ¨ç½²è„šæœ¬
- `scripts/verify_external_apis.py`: å¤–éƒ¨ API éªŒè¯è„šæœ¬
- `P1-201-å¤šç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ.md`: è¯¦ç»†éƒ¨ç½²æ‰‹å†Œ

