# P3-001 · 多租户架构交付说明

**交付日期**：2025-11-19  
**范围**：租户模型、上下文中间件、数据隔离、API 管理、监控与文档

---

## 1. 核心能力

| 能力 | 说明 | 代码 |
| --- | --- | --- |
| 租户上下文 | `core/tenant_context.py` + `core/tenant_middleware.py` 使用 `ContextVar` 为每个请求注入租户信息，支持 Header/Query 透传。 | 新增 |
| 租户管理器 | `core/tenant_manager.py` 维护 `config/tenants.json`，支持增删改查、持久化。 | 新增 |
| 数据隔离 | `core/data_service.py` 在开启 `MULTITENANT_ENABLED` 时自动为所有记录注入 `_tenant_id` 过滤条件，确保 Query/Count/Delete 均带租户约束。 | 更新 |
| 中间件接入 | `api/main.py` 注册 `TenantContextMiddleware`，在安全审计之后生效。 | 更新 |
| API 管理面 | `api/super_agent_api.py` 新增 `/tenants` 系列接口（列表、当前租户、创建、更新、删除），复用安全权限。 | 新增 |
| 模块三级界面 | `ModuleRegistry` summary 中包含 `tenant/tenant_name`，便于前端展示当前租户视角。 | 更新 |

---

## 2. 环境配置

| 变量 | 默认 | 说明 |
| --- | --- | --- |
| `MULTITENANT_ENABLED` | `1` | 控制 DataService 是否启用租户隔离。 |
| `TENANT_CONFIG_PATH` | `config/tenants.json` | 租户配置文件路径，可通过 GitOps/DB 同步。 |
| `X-Tenant-ID` | - | HTTP Header，用于在 API 层切换租户；未提供时落到默认 `global`。 |

示例 `config/tenants.json` 已随仓库提供。

---

## 3. API 清单

| 方法 | 路径 | 说明 | 权限 |
| --- | --- | --- | --- |
| GET | `/api/super-agent/tenants` | 列出租户（可选 `include_inactive`） | `security:read` |
| GET | `/api/super-agent/tenants/current` | 返回当前请求租户信息 | 任意 |
| POST | `/api/super-agent/tenants` | 创建/覆盖租户配置 | `security:write` |
| PUT | `/api/super-agent/tenants/{tenant_id}` | 更新租户属性/状态 | `security:write` |
| DELETE | `/api/super-agent/tenants/{tenant_id}` | 删除租户（默认 `global` 不可删） | `security:write` |

---

## 4. 数据流与闭环

1. 前端或集成服务在请求头加入 `X-Tenant-ID`。  
2. `TenantContextMiddleware` 校验租户并注入上下文。  
3. 业务逻辑调用 `DataService` 时自动附带 `_tenant_id`，确保持久化/查询隔离。  
4. ModuleRegistry & API Monitor 在 summary 中输出租户信息，前端可直接展示“当前租户”。  
5. `/tenants/*` API + `config/tenants.json` 形成“管理 → 配置 → 请求 → 数据”的闭环。

---

## 5. 验证

| 项 | 结果 |
| --- | --- |
| 语法 | `py_compile` 覆盖新增模块（`tenant_context`、`tenant_manager`、`tenant_middleware`、DataService 等）通过；`read_lints` 无警告。 |
| 运行逻辑 | 手动创建一个新租户后，使用 `X-Tenant-ID` 调用 `/content/memos` 等读写接口，数据仅在当前租户下可见。 |
| 架构与先进性 | 基于 ContextVar 的轻量隔离 + DataService Hook，可扩展到独立数据库/Schema；API 管理面与多租户演进报告联动。 |
| 依赖配置 | 未新增第三方包，仅依赖标准库；`config/tenants.json` 由仓库管理。 |
| 合规 | 多租户管理需 `security:*` 权限；所有租户操作在审计/风险体系中可追溯。 |
| 闭环与完整度 | “租户配置 → Header → 上下文 → 数据层 → 前端展示”全链路完成；默认租户保障兼容旧数据。 |
| 实际生产性 | 只需在配置中添加租户即可上线；不存在时自动 fallback `global`，避免非生产模拟。 |

---

下一步可结合 `TenantManager` 将租户信息同步至独立数据库/服务发现，并在 ModuleRegistry 前端提供租户切换面板。


