# 自主代码修复功能说明

## 📅 添加时间
2025年11月5日

## 🎯 功能定位
在"自我学习和自我进化"功能模块中新增的P0级核心功能

---

## 📋 需求描述

系统能够：
1. **自动分析**：对学习、分析、理解、总结出的问题进行诊断
2. **自主编写代码**：生成修复代码来解决问题
3. **征得用户同意**：通过交互中心展示修复方案，等待用户批准
4. **安全执行**：用户同意后才执行代码修复

---

## 🏗️ 系统架构

### 核心模块
```
auto_code_fixer.py
├── 问题诊断器
│   ├── RAG历史检索
│   ├── Ollama智能分析
│   └── 严重程度评估
│
├── 代码生成器
│   ├── 修复代码生成
│   ├── 注释和说明
│   └── 步骤说明
│
├── 用户确认机制
│   ├── 交互中心展示
│   ├── 代码审查界面
│   └── 批准/拒绝/修改
│
├── 安全执行引擎
│   ├── 沙箱隔离
│   ├── 超时保护
│   └── 错误捕获
│
├── 效果验证器
│   ├── 自动验证
│   ├── 结果记录
│   └── 反馈分析
│
└── RAG学习循环
    ├── 修复记录保存
    ├── 经验积累
    └── 能力提升
```

---

## 🔄 完整工作流

### 步骤1：问题检测
```
系统运行 → 检测到错误 → 收集错误信息
```

### 步骤2：智能诊断
```
RAG检索类似问题 → Ollama分析根因 → 生成诊断报告
```

### 步骤3：代码生成
```
基于诊断结果 → Ollama生成修复代码 → 添加注释和说明
```

### 步骤4：用户确认
```
交互中心展示 → 显示代码和说明 → 等待用户批准
```

### 步骤5：安全执行
```
用户同意 → 沙箱执行代码 → 捕获执行结果
```

### 步骤6：效果验证
```
验证修复效果 → 记录结果 → 存入RAG
```

### 步骤7：持续学习
```
分析修复成败 → 优化策略 → 提升能力
```

---

## 💻 技术实现

### 1. 问题诊断
```python
# 基于RAG的历史检索
rag_context = await _search_rag_for_similar_issues(error_info)

# Ollama智能分析
diagnosis = await _call_ollama(analysis_prompt)
```

### 2. 代码生成
```python
# 生成修复代码
fix_code_response = await _call_ollama(code_gen_prompt)

# 解析代码和说明
code, explanation, steps = _parse_code_response(fix_code_response)
```

### 3. 用户确认
```python
# 准备展示信息
message = f"""
🔧 自主代码修复请求

修复代码：
{code}

是否同意执行？
"""

# 发送到交互中心
approval_request = await request_user_approval(fix_proposal)
```

### 4. 安全执行
```python
# 沙箱执行
result = subprocess.run(
    ['python3', code_file],
    capture_output=True,
    timeout=30  # 30秒超时
)
```

### 5. 效果验证
```python
# 验证修复效果
verification = await _verify_fix_effect(error_info)

# 记录到RAG
await _save_to_rag(fix_record)
```

---

## 🔒 安全机制

### 1. 用户批准机制
- ✅ 必须用户明确同意才执行
- ✅ 显示完整代码供审查
- ✅ 支持拒绝或修改

### 2. 沙箱隔离
- ✅ subprocess独立进程执行
- ✅ 限制代码影响范围
- ✅ 捕获所有输出和错误

### 3. 超时保护
- ✅ 30秒执行超时
- ✅ 防止无限循环
- ✅ 自动终止异常代码

### 4. 错误处理
- ✅ try-except全覆盖
- ✅ 执行失败不影响系统
- ✅ 详细错误日志

### 5. 历史追溯
- ✅ 完整修复历史记录
- ✅ 可查看所有修复记录
- ✅ 支持回滚和审查

---

## 📊 API端点说明

### 1. POST /api/auto-fix/workflow
**完整自动修复工作流（推荐使用）**

请求：
```json
{
  "error_info": {
    "type": "运行时错误",
    "message": "KeyError: 'user_id'",
    "traceback": "...",
    "module": "chat_server"
  },
  "user_id": "user_123"
}
```

响应：
```json
{
  "success": true,
  "stage": "waiting_for_approval",
  "diagnosis": {...},
  "fix_proposal": {...},
  "message": "修复方案已生成，等待用户确认"
}
```

### 2. POST /api/auto-fix/diagnose
**诊断问题**

### 3. POST /api/auto-fix/generate
**生成修复代码**

### 4. POST /api/auto-fix/request-approval
**请求用户批准**

### 5. POST /api/auto-fix/execute
**执行修复（需批准）**

### 6. GET /api/auto-fix/history
**查看修复历史**

### 7. GET /api/auto-fix/stats
**查看修复统计**

---

## 🎯 使用场景

### 场景1：运行时错误自动修复
```
1. 系统检测到KeyError
2. 自动诊断：缺少user_id字段
3. 生成修复代码：添加默认值处理
4. 展示给用户确认
5. 用户同意后执行
6. 问题解决
```

### 场景2：性能问题优化
```
1. 系统检测到响应慢
2. 自动诊断：数据库查询未优化
3. 生成修复代码：添加索引和缓存
4. 展示给用户确认
5. 用户同意后执行
6. 性能提升
```

### 场景3：逻辑错误修复
```
1. 系统检测到计算错误
2. 自动诊断：公式逻辑错误
3. 生成修复代码：修正计算逻辑
4. 展示给用户确认
5. 用户同意后执行
6. 逻辑正确
```

---

## 📈 预期效果

### 短期效果（1个月）
- ✅ 能自动检测50%以上的常见问题
- ✅ 生成修复代码成功率60%以上
- ✅ 用户批准率70%以上
- ✅ 实际修复成功率80%以上

### 中期效果（3个月）
- ✅ 检测率提升到80%
- ✅ 代码生成成功率80%
- ✅ 用户批准率85%
- ✅ 修复成功率90%

### 长期效果（6个月）
- ✅ 检测率达到95%
- ✅ 代码生成成功率90%
- ✅ 用户批准率90%
- ✅ 修复成功率95%
- ✅ 大部分问题实现自动修复

---

## 🔄 学习反馈循环

```
问题发生
    ↓
自动诊断（RAG检索历史）
    ↓
生成修复代码（Ollama）
    ↓
用户确认（交互中心）
    ↓
安全执行（沙箱）
    ↓
效果验证
    ↓
存入RAG（积累经验）
    ↓
下次遇到类似问题，修复更快更准
```

---

## 💡 技术亮点

1. **智能化**：基于AI自动生成修复代码
2. **安全性**：用户批准机制，沙箱执行
3. **学习性**：持续积累修复经验到RAG
4. **可追溯**：完整的修复历史记录
5. **可验证**：自动验证修复效果

---

## 📝 更新记录

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-11-05 | v1.0 | 初始实现，基础框架完成 |

---

**功能状态**：代码框架已完成，待测试和优化  
**优先级**：P0（核心功能）  
**预计完整实现**：1-2周
