# AlertManager å¤šæ¸ é“é€šçŸ¥é…ç½®
# P0-018: å¯è§‚æµ‹ä½“ç³»å¢å¼º - å¤šæ¸ é“é€šçŸ¥é…ç½®

global:
  # å…¨å±€SMTPé…ç½®ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@yourcompany.com'
  smtp_auth_username: 'your-email@gmail.com'
  smtp_auth_password: 'your-app-password'
  smtp_require_tls: true
  
  # é’‰é’‰é…ç½®
  dingtalk_api_url: 'https://oapi.dingtalk.com/robot/send'
  
  # Slacké…ç½®
  slack_api_url: 'https://hooks.slack.com/services'
  
  # ä¼ä¸šå¾®ä¿¡é…ç½®
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin'

route:
  # é»˜è®¤è·¯ç”±
  group_by: ['alertname', 'severity', 'category']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'multi-channel-receiver'
  
  # å­è·¯ç”± - æŒ‰ä¸¥é‡ç¨‹åº¦è·¯ç”±
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts-receiver'
      group_wait: 5s
      repeat_interval: 5m
      
    - match:
        severity: error
      receiver: 'error-alerts-receiver'
      group_wait: 10s
      repeat_interval: 10m
      
    - match:
        severity: warning
      receiver: 'warning-alerts-receiver'
      group_wait: 30s
      repeat_interval: 30m
      
    - match:
        severity: info
      receiver: 'info-alerts-receiver'
      group_wait: 1m
      repeat_interval: 2h
      
    # æŒ‰åˆ†ç±»è·¯ç”±
    - match:
        category: business
      receiver: 'business-alerts-receiver'
      group_wait: 15s
      repeat_interval: 15m
      
    - match:
        category: system
      receiver: 'system-alerts-receiver'
      group_wait: 10s
      repeat_interval: 10m
      
    - match:
        category: api
      receiver: 'api-alerts-receiver'
      group_wait: 10s
      repeat_interval: 10m

receivers:
  # å¤šæ¸ é“æ¥æ”¶å™¨ - é»˜è®¤æ¥æ”¶æ‰€æœ‰å‘Šè­¦
  - name: 'multi-channel-receiver'
    email_configs:
      - to: 'devops-team@yourcompany.com'
        subject: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          ========
          å‘Šè­¦åç§°: {{ .Labels.alertname }}
          ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
          åˆ†ç±»: {{ .Labels.category }}
          ç±»å‹: {{ .Labels.type }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          æè¿°: {{ .Annotations.description }}
          æ‘˜è¦: {{ .Annotations.summary }}
          {{ if .GeneratorURL }}
          è¯¦æƒ…é“¾æ¥: {{ .GeneratorURL }}
          {{ end }}
          ========
          {{ end }}
        
    dingtalk_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_DINGTALK_TOKEN'
        secret: 'YOUR_DINGTALK_SECRET'
        message:
          msgtype: markdown
          markdown:
            title: '{{ .GroupLabels.alertname }}'
            text: |
              ## {{ .GroupLabels.alertname }}
              
              **ä¸¥é‡ç¨‹åº¦**: {{ .GroupLabels.severity }}
              **åˆ†ç±»**: {{ .GroupLabels.category }}
              
              {{ range .Alerts }}
              ---
              **å‘Šè­¦è¯¦æƒ…**:
              - å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              - æè¿°: {{ .Annotations.description }}
              {{ if .GeneratorURL }}
              - [æŸ¥çœ‹è¯¦æƒ…]({{ .GeneratorURL }})
              {{ end }}
              {{ end }}
        
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts'
        username: 'Alert Bot'
        icon_emoji: ':warning:'
        title: '{{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Severity*: {{ .Labels.severity }}
          *Category*: {{ .Labels.category }}
          *Description*: {{ .Annotations.description }}
          {{ if .GeneratorURL }}
          *Details*: {{ .GeneratorURL }}
          {{ end }}
          ---
          {{ end }}
        
    webhook_configs:
      - url: 'http://localhost:9093/webhook'
        send_resolved: true

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨ - ç´§æ€¥é€šçŸ¥
  - name: 'critical-alerts-receiver'
    email_configs:
      - to: 'oncall-team@yourcompany.com, managers@yourcompany.com'
        subject: '[CRITICAL] {{ .GroupLabels.alertname }} - éœ€è¦ç«‹å³å¤„ç†ï¼'
        
    dingtalk_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=CRITICAL_DINGTALK_TOKEN'
        secret: 'CRITICAL_DINGTALK_SECRET'
        message:
          msgtype: actionCard
          actionCard:
            title: 'ğŸš¨ ä¸¥é‡å‘Šè­¦: {{ .GroupLabels.alertname }}'
            text: |
              ## ğŸš¨ ä¸¥é‡å‘Šè­¦éœ€è¦ç«‹å³å¤„ç†ï¼
              
              **å‘Šè­¦åç§°**: {{ .GroupLabels.alertname }}
              **ä¸¥é‡ç¨‹åº¦**: {{ .GroupLabels.severity }}
              
              {{ range .Alerts }}
              **æè¿°**: {{ .Annotations.description }}
              **å¼€å§‹æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
              
              [æŸ¥çœ‹è¯¦æƒ…]({{ .Alerts.0.GeneratorURL }})
            
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/CRITICAL/SLACK/WEBHOOK'
        channel: '#critical-alerts'
        username: 'Critical Alert Bot'
        icon_emoji: ':rotating_light:'
        color: 'danger'
        
    # çŸ­ä¿¡é€šçŸ¥ï¼ˆéœ€è¦é›†æˆçŸ­ä¿¡æœåŠ¡ï¼‰
    webhook_configs:
      - url: 'http://sms-gateway:8080/send-alert'
        send_resolved: true

  # é”™è¯¯å‘Šè­¦æ¥æ”¶å™¨
  - name: 'error-alerts-receiver'
    email_configs:
      - to: 'devops-team@yourcompany.com'
        subject: '[ERROR] {{ .GroupLabels.alertname }}'
        
    dingtalk_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=ERROR_DINGTALK_TOKEN'
        secret: 'ERROR_DINGTALK_SECRET'
        
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/ERROR/SLACK/WEBHOOK'
        channel: '#error-alerts'

  # è­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
  - name: 'warning-alerts-receiver'
    email_configs:
      - to: 'devops-team@yourcompany.com'
        subject: '[WARNING] {{ .GroupLabels.alertname }}'
        
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/WARNING/SLACK/WEBHOOK'
        channel: '#warning-alerts'

  # ä¿¡æ¯å‘Šè­¦æ¥æ”¶å™¨
  - name: 'info-alerts-receiver'
    email_configs:
      - to: 'monitoring-team@yourcompany.com'
        subject: '[INFO] {{ .GroupLabels.alertname }}'
        
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/INFO/SLACK/WEBHOOK'
        channel: '#info-alerts'

  # ä¸šåŠ¡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'business-alerts-receiver'
    email_configs:
      - to: 'business-team@yourcompany.com, product-team@yourcompany.com'
        subject: '[BUSINESS] {{ .GroupLabels.alertname }}'
        
    dingtalk_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=BUSINESS_DINGTALK_TOKEN'
        secret: 'BUSINESS_DINGTALK_SECRET'
        
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/BUSINESS/SLACK/WEBHOOK'
        channel: '#business-alerts'

  # ç³»ç»Ÿå‘Šè­¦æ¥æ”¶å™¨
  - name: 'system-alerts-receiver'
    email_configs:
      - to: 'infrastructure-team@yourcompany.com'
        subject: '[SYSTEM] {{ .GroupLabels.alertname }}'
        
    dingtalk_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=SYSTEM_DINGTALK_TOKEN'
        secret: 'SYSTEM_DINGTALK_SECRET'
        
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/SYSTEM/SLACK/WEBHOOK'
        channel: '#system-alerts'

  # APIå‘Šè­¦æ¥æ”¶å™¨
  - name: 'api-alerts-receiver'
    email_configs:
      - to: 'api-team@yourcompany.com, backend-team@yourcompany.com'
        subject: '[API] {{ .GroupLabels.alertname }}'
        
    dingtalk_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=API_DINGTALK_TOKEN'
        secret: 'API_DINGTALK_SECRET'
        
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/API/SLACK/WEBHOOK'
        channel: '#api-alerts'

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœå­˜åœ¨ä¸¥é‡å‘Šè­¦ï¼ŒæŠ‘åˆ¶ç›¸åŒåˆ†ç±»çš„è­¦å‘Šå’Œä¿¡æ¯å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['category', 'alertname']
    
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'info'
    equal: ['category', 'alertname']
    
  # å¦‚æœå­˜åœ¨é”™è¯¯å‘Šè­¦ï¼ŒæŠ‘åˆ¶ç›¸åŒåˆ†ç±»çš„ä¿¡æ¯å‘Šè­¦
  - source_match:
      severity: 'error'
    target_match:
      severity: 'info'
    equal: ['category', 'alertname']

# é™é»˜é…ç½®
# å¯ä»¥é…ç½®å®šæœŸç»´æŠ¤çª—å£ç­‰é™é»˜è§„åˆ™