# Prometheus告警规则 - 服务监控

groups:
  - name: service_alerts
    interval: 30s
    rules:
      # ==================== 服务可用性告警 ====================
      
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "服务 {{ $labels.job }} 不可用"
          description: "{{ $labels.instance }} 已经宕机超过1分钟"
          action: "立即检查服务状态并重启"
      
      - alert: ServiceHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          category: errors
        annotations:
          summary: "服务 {{ $labels.job }} 错误率过高"
          description: "5xx错误率 {{ $value | humanizePercentage }} 超过阈值"
      
      # ==================== 性能告警 ====================
      
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "服务 {{ $labels.job }} 响应时间过长"
          description: "P95响应时间 {{ $value }}s 超过1秒"
      
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "服务 {{ $labels.job }} CPU使用率过高"
          description: "CPU使用率 {{ $value | humanizePercentage }} 超过80%"
      
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 4
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "服务 {{ $labels.job }} 内存使用过高"
          description: "内存使用 {{ $value }}GB 超过4GB"
      
      # ==================== 请求量告警 ====================
      
      - alert: HighRequestRate
        expr: rate(http_requests_total[5m]) > 1000
        for: 5m
        labels:
          severity: info
          category: traffic
        annotations:
          summary: "服务 {{ $labels.job }} 请求量激增"
          description: "请求速率 {{ $value }} req/s，注意监控"
      
      - alert: LowRequestRate
        expr: rate(http_requests_total[5m]) < 0.1
        for: 30m
        labels:
          severity: info
          category: traffic
        annotations:
          summary: "服务 {{ $labels.job }} 请求量异常低"
          description: "请求速率 {{ $value }} req/s，可能存在问题"
      
      # ==================== 数据库告警 ====================
      
      - alert: DatabaseConnectionsHigh
        expr: db_connections_active > 80
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "数据库连接数过高"
          description: "活跃连接数 {{ $value }}，接近上限"
      
      - alert: SlowDatabaseQueries
        expr: rate(db_query_duration_seconds_sum[5m]) / rate(db_query_duration_seconds_count[5m]) > 0.5
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "数据库查询缓慢"
          description: "平均查询时间 {{ $value }}s"
      
      # ==================== 缓存告警 ====================
      
      - alert: CacheHitRateLow
        expr: rate(cache_hits_total[5m]) / rate(cache_requests_total[5m]) < 0.5
        for: 15m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "缓存命中率低"
          description: "缓存命中率 {{ $value | humanizePercentage }}"
      
      # ==================== AI模型告警 ====================
      
      - alert: AIModelResponseSlow
        expr: ai_model_inference_duration_seconds > 10
        for: 5m
        labels:
          severity: warning
          category: ai
        annotations:
          summary: "AI模型响应缓慢"
          description: "模型推理时间 {{ $value }}s 超过10秒"
      
      - alert: AIModelErrorRate
        expr: rate(ai_model_errors_total[5m]) > 0.1
        for: 10m
        labels:
          severity: critical
          category: ai
        annotations:
          summary: "AI模型错误率高"
          description: "模型错误率过高，请检查Ollama服务"

